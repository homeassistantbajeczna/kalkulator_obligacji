<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Obligacji Skarbu Państwa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="logo-container">
        <a href="https://finance-brothers.pl">
            <img src="cropped-logo-FB-1.png" alt="Twoje Logo" class="logo d-block mx-auto">
        </a>
    </div>
    <div class="container">
        <div class="form-section" id="formSection">
            <h4>Kalkulator Obligacji Skarbu Państwa</h4>
            <div class="form-container">
                <div class="form-wrapper">
                    <form id="obligacjeForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="kwota" class="form-label">Kwota inwestycji</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="kwota" min="100" max="5000000" step="100" value="10000">
                                    <span class="input-group-text">zł</span>
                                </div>
                                <input type="range" class="form-range" id="kwotaRange" min="100" max="5000000" step="100" value="10000">
                                <div class="sub-info" id="iloscObligacji">Ilość obligacji: 100</div>
                            </div>
                            <div class="form-group">
                                <label for="typObligacji" class="form-label">Typ obligacji</label>
                                <select class="form-control" id="typObligacji">
                                    <option value="OTS" selected>3-miesięczne (OTS)</option>
                                    <option value="ROR">12-miesięczne (ROR)</option>
                                    <option value="DOR">24-miesięczne (DOR)</option>
                                    <option value="TOS">3-letnie (TOS)</option>
                                    <option value="COI">4-letnie (COI)</option>
                                    <option value="EDO">10-letnie (EDO)</option>
                                    <option value="ROS">6-letnie (ROS)</option>
                                    <option value="ROD">12-letnie (ROD)</option>
                                </select>
                                <div class="sub-info"></div>
                            </div>
                            <div class="form-group">
                                <label for="inflacja" class="form-label">Inflacja</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="inflacja" min="0" max="50" step="0.1" value="4.9">
                                    <span class="input-group-text">%</span>
                                </div>
                                <input type="range" class="form-range" id="inflacjaRange" min="0" max="50" step="0.1" value="4.9">
                                <div class="sub-info"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="okres" class="form-label">Okres inwestycji</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="okres" min="3" max="144" step="1" value="3" readonly>
                                    <span class="input-group-text">mc-y</span>
                                </div>
                                <div class="sub-info" id="lata"></div>
                            </div>
                            <div class="form-group">
                                <label for="oprocentowanie" class="form-label">Oprocentowanie</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="oprocentowanie" min="0.1" max="25" step="0.1" value="3" readonly>
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="sub-info" id="oprocentowanieInfo"></div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="form-row">
                <button type="button" class="btn btn-primary" id="obliczBtn" style="margin: 25px auto 0;">Oblicz</button>
            </div>
            <div class="obligacje-opis" id="obligacjeOpis"></div>
        </div>
    </div>
    <div class="result-section" id="resultSection">
        <div class="result-header">
            <h4 id="resultHeader">Podsumowanie wyników</h4>
            <button id="generatePdfBtn" class="btn btn-primary btn-sm">Generuj PDF</button>
        </div>
        <button class="btn btn-secondary mb-3" onclick="showForm()">Powrót do edycji</button>
        <div class="result-container">
            <div class="result-wrapper">
                <h5>Wyniki inwestycji</h5>
                <div class="chart-container">
                    <div class="chart">
                        <canvas id="obligacjeChart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item" data-index="0">
                            <div class="color-box" style="background-color: #28a745;" data-tooltip="">
                                <span class="value" id="valueKapital">-</span>
                            </div>
                            <span class="legend-text" id="legendKapital">Kapitał</span>
                        </div>
                        <div class="legend-item" data-index="1">
                            <div class="color-box" style="background-color: #007bff;" data-tooltip="">
                                <span class="value" id="valueOdsetki">-</span>
                            </div>
                            <span class="legend-text" id="legendOdsetki">Odsetki</span>
                        </div>
                        <div class="legend-item" data-index="2">
                            <div class="color-box" style="background-color: #dc3545;" data-tooltip="">
                                <span class="value" id="valuePodatek">-</span>
                            </div>
                            <span class="legend-text" id="legendPodatek">Podatek</span>
                        </div>
                    </div>
                </div>
                <div class="summary-footer">
                    <span class="highlight yellow" data-hover="3 miesięcy">Okres inwestycji: <span id="okresInwestycji">-</span> mc-y</span>
                    <span class="highlight green" data-hover="">Zysk netto: <span id="zyskNetto">-</span> zł</span>
                </div>
            </div>
        </div>
        <div class="harmonogram-container">
            <div class="result-wrapper">
                <div class="harmonogram">
                    <h5 class="btn-toggle" onclick="toggleHarmonogram('harmonogramContent')">Harmonogram odsetek ▼</h5>
                    <div id="harmonogramContent">
                        <table class="table table-striped">
                            <thead id="harmonogramNaglowek">
                                <tr>
                                    <th id="pierwszaKolumnaNaglowek">Rok</th>
                                    <th>Kwota wykupu</th>
                                    <th>Oproc. cykl</th>
                                    <th>Odsetki</th>
                                    <th>Odsetki skum.</th>
                                    <th>Opłata wyk.</th>
                                    <th>Podatek</th>
                                    <th>Zysk netto</th>
                                    <th>Inflacja</th>
                                    <th>Kwota po cykl.</th>
                                </tr>
                            </thead>
                            <tbody id="harmonogramTabela"></tbody>
                        </table>
                    </div>
                </div>
                <div class="chart-container-line">
                    <div class="chart-line">
                        <canvas id="obligacjeChartLine"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <style>
    body {
        background-color: #f5f6f5;
        font-family: 'Montserrat', sans-serif;
        padding: 10px;
    }
    .logo-container {
        background-color: #e9ecef;
        padding: 15px;
        text-align: center;
        margin-bottom: 20px;
    }
    .logo {
        max-width: 200px;
        margin-bottom: 0;
        cursor: pointer;
    }
    .container {
        max-width: 1200px;
        margin: 30px auto 0;
        background: #FFFFFF;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .form-section {
        padding: 10px;
        position: relative;
    }
    .form-section h4 {
        margin-bottom: 15px;
        text-align: center;
        font-size: 1.2em;
        color: #333333;
        font-weight: 700;
    }
    .form-row {
        display: flex;
        justify-content: center;
        margin-bottom: 10px;
        gap: 10px;
        align-items: flex-start;
    }
    .form-group {
        flex: 1;
        min-width: 0;
        max-width: 150px;
    }
    .form-label {
        font-size: 0.7em;
        text-transform: uppercase;
        margin-bottom: 2px;
        color: #333333;
    }
    .form-control, .form-select, .form-range {
        height: 22px;
        font-size: 0.7em;
        padding: 2px;
        text-align: center;
    }
    .form-select {
        max-width: 100px;
        appearance: none;
        background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAQ0lEQVR42mNgwAfKy8Q/Y//+Ii//3jVAYQzsIFyQ0dOaWq992zxcnN5+9NmyZACV40DmGhPZtzwUAxhUaoLntdha0DqQbtz4E9DzN6XgI0P2VYFlQrUwoQDIgbChLE/0awXiwV5rhugPX6A8BSsYFDqU+rEFdkGZA7+G9HMqaAU6l+0w+NdJD7ADhzhR/4KDZnWOw0QKrVqYc1G+1Dczfx8DR0uv+QJqDRvQxdizFAQAwsy39EZhAAAwAAJ4+Q1XFlAAAAABJRU5ErkJggg==') no-repeat right 5px center;
    }
    .form-range {
        margin-top: 2px;
        height: 8px;
        background: #d3d3d3;
        border-radius: 5px;
    }
    .form-range::-webkit-slider-thumb {
        background: #C2B280;
        border: none;
        border-radius: 50%;
        width: 12px;
        height: 12px;
        cursor: pointer;
        -webkit-appearance: none;
    }
    .form-range::-moz-range-thumb {
        background: #C2B280;
        border: none;
        border-radius: 50%;
        width: 12px;
        height: 12px;
        cursor: pointer;
    }
    .input-group-text {
        font-size: 0.7em;
        padding: 2px 5px;
    }
    .sub-info {
        font-size: 0.4em;
        color: #333333;
        margin-top: 2px;
        text-align: left;
    }
    .obligacje-opis {
        margin-top: 20px;
        font-size: 0.6em;
        color: #333333;
        text-align: center;
    }
    .obligacje-opis ul {
        list-style: none;
        padding-left: 0;
    }
    .obligacje-opis li {
        margin-bottom: 5px;
    }
    .result-section {
        display: none;
        padding: 10px;
        max-width: 1200px;
        margin: 0 auto;
        background: #FFFFFF;
    }
    .result-header {
        text-align: center;
        margin-bottom: 20px;
        position: relative;
    }
    .result-header h4 {
        font-size: 1.2em;
        color: #333333;
        font-weight: 700;
        display: inline-block;
    }
    .chart-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
        position: relative;
        overflow: visible;
    }
    .chart {
        flex: 0 0 auto;
        width: 120px;
        height: 120px;
        position: relative;
        z-index: 25;
    }
    .chart-legend {
        flex: 0 0 auto;
        max-width: 200px;
        margin: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .chart-legend .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 6px;
        font-size: 0.7em;
        color: #333333;
        cursor: pointer;
        transition: transform 0.3s ease;
        padding-left: 8px;
    }
    .chart-legend .color-box {
        width: 90px;
        height: 18px;
        border-radius: 5px;
        text-align: center;
        font-weight: 500;
        line-height: 18px;
        font-size: 0.8em;
        white-space: nowrap;
        overflow: hidden;
        position: relative;
        color: #fff;
        margin-right: 6px;
    }
    .chart-legend .color-box .value {
        display: block;
    }
    .chart-legend .color-box:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        color: #fff;
        font-size: 0.8em;
        line-height: 18px;
        text-align: center;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 30;
    }
    .chart-legend .color-box:hover .value {
        display: none;
    }
    .chart-legend .legend-text {
        opacity: 1;
        transition: opacity 0.3s ease;
        font-size: 0.7em;
    }
    .summary-footer {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 10px;
    }
    .summary-footer .highlight {
        font-size: 0.8em;
        padding: 4px 6px;
        border-radius: 5px;
        position: relative;
        cursor: pointer;
    }
    .highlight.yellow {
        background-color: #17a2b8;
        color: #ffffff;
    }
    .highlight.yellow:hover {
        color: transparent;
    }
    .highlight.yellow:hover::after {
        content: attr(data-hover);
        font-weight: bold;
        font-size: 1.1em;
        color: #ffffff;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .highlight.green {
        background-color: #28a745;
        color: #ffffff;
    }
    .highlight.green:hover {
        color: transparent;
    }
    .highlight.green:hover::after {
        content: attr(data-hover);
        font-weight: bold;
        font-size: 1.1em;
        color: #ffffff;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .harmonogram {
        margin-top: 20px;
        font-size: 0.8em;
        background-color: #f9f9f9;
        border-radius: 10px;
        padding: 10px;
    }
    .harmonogram table {
        margin: 0 auto;
        width: auto;
        max-width: 1000px;
        display: table;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        background: #f9f9f9;
    }
    .harmonogram th {
        background: linear-gradient(90deg, #C2B280, #b0a070);
        color: #000000;
        padding: 12px;
        text-align: center;
        vertical-align: middle;
        font-weight: 500;
        border-bottom: 2px solid #ddd;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .harmonogram td {
        padding: 10px;
        text-align: center;
        font-weight: 400;
        border-bottom: 1px solid #eee;
        background-color: #f9f9f9;
        color: #000000;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .btn-toggle {
        cursor: pointer;
        font-size: 0.8em;
        color: #007bff;
        text-decoration: underline;
        margin-bottom: 10px;
    }
    .btn-primary, .btn-secondary {
        background-color: #C2B280;
        border-color: #C2B280;
        color: #000000;
        font-size: 0.9em;
        padding: 5px 20px;
        width: auto;
        margin: 25px auto 0;
        display: block;
    }
    .btn-primary:hover, .btn-secondary:hover {
        background-color: #b0a070;
        border-color: #b0a070;
        color: #000000;
    }
    .btn-sm {
        font-size: 0.7em;
        padding: 3px 10px;
    }
    #generatePdfBtn {
        position: absolute;
        top: 0;
        right: 10px;
    }
    #harmonogramContent {
        display: block;
    }
    .form-container {
        display: flex;
        gap: 20px;
        justify-content: center;
        position: relative;
    }
    .form-wrapper {
        flex: 1;
        max-width: 400px;
    }
    .result-container {
        display: flex;
        gap: 20px;
        justify-content: center;
        flex-wrap: wrap;
        position: relative;
    }
    .harmonogram-container {
        display: flex;
        gap: 20px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 20px;
        position: relative;
        background-color: #f9f9f9;
        border-radius: 10px;
        padding: 10px;
    }
    .result-wrapper {
        flex: 1;
        max-width: 1000px;
    }
    .result-wrapper h5 {
        font-size: 1em;
        text-align: center;
        margin-bottom: 10px;
        color: #333333;
    }
    .chart-container-line {
        margin-top: 20px;
        width: 100%;
        height: 400px;
    }
    .chart-line {
        width: 100%;
        height: 100%;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<script>
    let chart, chartLine;
    let harmonogramData = [];

    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) {
        console.error("Biblioteka jsPDF nie została załadowana.");
    } else if (!jsPDF.prototype.autoTable) {
        console.warn("Plugin autoTable nie został załadowany. PDF bez tabel harmonogramu.");
    }

    const obligacjeConfig = {
        "OTS": { okres: 3, oprocentowanie: 3.00, zmienne: false, kapitalizacja: false, oplataWykup: 0.00 }, // 0%
        "ROR": { okres: 12, oprocentowanie: 5.75, zmienne: true, marza: 0.00, kapitalizacja: false, oplataWykup: 0.005 }, // 0,5%
        "DOR": { okres: 24, oprocentowanie: 5.90, zmienne: true, marza: 0.15, kapitalizacja: false, oplataWykup: 0.007 }, // 0,7%
        "TOS": { okres: 36, oprocentowanie: 5.95, zmienne: false, kapitalizacja: true, oplataWykup: 0.01 }, // 1%
        "COI": { okres: 48, oprocentowanie: 6.30, zmienne: true, marza: 0.75, indeksowaneInflacja: true, kapitalizacja: false, oplataWykup: 0.02 }, // 2%
        "EDO": { okres: 120, oprocentowanie: 6.55, zmienne: true, marza: 2.00, indeksowaneInflacja: true, kapitalizacja: true, oplataWykup: 0.03 }, // 3%
        "ROS": { okres: 72, oprocentowanie: 6.40, zmienne: true, marza: 1.50, indeksowaneInflacja: true, kapitalizacja: true, oplataWykup: 0.02 }, // 2%
        "ROD": { okres: 144, oprocentowanie: 6.70, zmienne: true, marza: 2.50, indeksowaneInflacja: true, kapitalizacja: true, oplataWykup: 0.03 } // 3%
    };

    const opisyObligacji = {
        "OTS": "* OTS (3-miesięczne): Stałe oprocentowanie 3,00%, idealne na krótkoterminowe inwestycje.",
        "ROR": "* ROR (12-miesięczne): Oprocentowanie zmienne, w pierwszym roku 5,75%, kolejne oparte na stopie NBP.",
        "DOR": "* DOR (24-miesięczne): Oprocentowanie zmienne, 5,90% w pierwszym roku, kolejne NBP + 0,15%.",
        "TOS": "* TOS (3-letnie): Stałe oprocentowanie 5,95%, przeznaczone dla stabilnych inwestycji z kapitalizacją odsetek.",
        "COI": "* COI (4-letnie): Indeksowane inflacją, 6,30% w pierwszym roku, kolejne inflacja + 0,75%, dla ochrony przed wzrostem cen.",
        "EDO": "* EDO (10-letnie): Indeksowane inflacją, 6,55% w pierwszym roku, kolejne inflacja + 2,00%, długoterminowa ochrona kapitału z kapitalizacją.",
        "ROS": "* ROS (6-letnie): Indeksowane inflacją, 6,40% w pierwszym roku, kolejne inflacja + 1,50%, dla średnioterminowych inwestorów z kapitalizacją.",
        "ROD": "* ROD (12-letnie): Indeksowane inflacją, 6,70% w pierwszym roku, kolejne inflacja + 2,50%, dla długoterminowych strategii z kapitalizacją."
    };

    const nazwyObligacji = {
        "OTS": "3-miesięcznych (OTS)",
        "ROR": "12-miesięcznych (ROR)",
        "DOR": "24-miesięcznych (DOR)",
        "TOS": "3-letnich (TOS)",
        "COI": "4-letnich (COI)",
        "EDO": "10-letnich (EDO)",
        "ROS": "6-letnich (ROS)",
        "ROD": "12-letnich (ROD)"
    };

    document.getElementById("kwotaRange").addEventListener("input", function() {
        const kwotaInput = document.getElementById("kwota");
        kwotaInput.value = this.value;
        updateIloscObligacji();
    });

    document.getElementById("kwota").addEventListener("input", function() {
        const kwotaRange = document.getElementById("kwotaRange");
        kwotaRange.value = this.value;
        updateIloscObligacji();
    });

    document.getElementById("inflacjaRange").addEventListener("input", function() {
        const inflacjaInput = document.getElementById("inflacja");
        inflacjaInput.value = this.value;
    });

    document.getElementById("inflacja").addEventListener("input", function() {
        const inflacjaRange = document.getElementById("inflacjaRange");
        inflacjaRange.value = this.value;
    });

    document.getElementById("typObligacji").addEventListener("change", function() {
        const typ = this.value;
        const config = obligacjeConfig[typ];
        document.getElementById("okres").value = config.okres;
        document.getElementById("oprocentowanie").value = config.oprocentowanie;
        updateLata();
        updateOprocentowanieInfo();
        updateOpisObligacji();
    });

    function updateIloscObligacji() {
        const kwota = parseFloat(document.getElementById("kwota").value) || 0;
        const ilosc = Math.floor(kwota / 100);
        document.getElementById("iloscObligacji").textContent = `Ilość obligacji: ${ilosc}`;
    }

    function updateLata() {
        const miesiace = parseInt(document.getElementById("okres").value) || 0;
        const lata = (miesiace / 12).toFixed(0);
        document.getElementById("lata").textContent = `Ilość lat: ${miesiace >= 12 ? lata : 0}`;
    }

    function updateOprocentowanieInfo() {
        const typ = document.getElementById("typObligacji").value;
        const config = obligacjeConfig[typ];
        let info = "";
        if (config.zmienne) {
            if (config.indeksowaneInflacja) {
                info = `Pierwszy rok: ${config.oprocentowanie}%, kolejne: inflacja + ${config.marza}%`;
            } else {
                info = `Pierwszy miesiąc: ${config.oprocentowanie}%, kolejne: stopa NBP + ${config.marza}%`;
            }
        } else {
            info = `Stałe: ${config.oprocentowanie}%`;
        }
        document.getElementById("oprocentowanieInfo").textContent = info;
    }

    function updateOpisObligacji() {
        const typ = document.getElementById("typObligacji").value;
        document.getElementById("obligacjeOpis").textContent = opisyObligacji[typ] || "";
    }

    updateIloscObligacji();
    updateLata();
    updateOprocentowanieInfo();
    updateOpisObligacji();

    function toggleHarmonogram(sectionId) {
        const content = document.getElementById(sectionId);
        const toggleBtn = content.previousElementSibling;
        if (content.style.display === "none") {
            content.style.display = "block";
            toggleBtn.textContent = "Harmonogram odsetek ▼";
        } else {
            content.style.display = "none";
            toggleBtn.textContent = "Harmonogram odsetek ►";
        }
    }

    function showForm() {
        document.getElementById("formSection").style.display = "block";
        document.getElementById("resultSection").style.display = "none";
    }

    function obliczObligacje() {
        const kwota = parseFloat(document.getElementById("kwota").value) || 0;
        const typ = document.getElementById("typObligacji").value;
        const config = obligacjeConfig[typ];
        const miesiace = config.okres;
        const inflacja = parseFloat(document.getElementById("inflacja").value) / 100 || 0;
        const podatekBelki = 0.19;

        if (kwota < 100 || miesiace <= 0) {
            alert("Proszę wypełnić wszystkie wymagane pola poprawnymi wartościami.");
            return;
        }

        // Ustawienie dynamicznego nagłówka w podsumowaniu wyników
        document.getElementById("resultHeader").textContent = `Wynik inwestycji dla obligacji ${nazwyObligacji[typ]}`;

        // Ustawienie nagłówka pierwszej kolumny (Rok/Miesiąc) w zależności od typu obligacji
        const pierwszaKolumnaNaglowek = document.getElementById("pierwszaKolumnaNaglowek");
        if (["OTS", "ROR", "DOR"].includes(typ)) {
            pierwszaKolumnaNaglowek.textContent = "Miesiąc";
        } else {
            pierwszaKolumnaNaglowek.textContent = "Rok";
        }

        let kapital = kwota;
        let odsetkiCalkowite = 0;
        let zyskNetto = 0;
        let harmonogram = [];
        let skumulowaneOdsetki = 0;
        let skumulowanaKwota = kwota;

        for (let i = 1; i <= miesiace; i++) {
            let okresWiersz = ["OTS", "ROR", "DOR"].includes(typ) ? i : Math.ceil(i / 12);

            let oprocentowanieMiesieczne;
            if (config.zmienne) {
                if (config.indeksowaneInflacja) {
                    if (i <= 12) {
                        oprocentowanieMiesieczne = config.oprocentowanie / 100 / 12;
                    } else {
                        oprocentowanieMiesieczne = (inflacja + config.marza / 100) / 12;
                    }
                } else {
                    oprocentowanieMiesieczne = (i === 1 ? config.oprocentowanie / 100 : (config.oprocentowanie / 100 + config.marza / 100)) / 12;
                }
            } else {
                oprocentowanieMiesieczne = config.oprocentowanie / 100 / 12;
            }

            let odsetkiMiesiac = kapital * oprocentowanieMiesieczne;
            let podatekMiesiac = odsetkiMiesiac * podatekBelki;
            let odsetkiNettoMiesiac = odsetkiMiesiac - podatekMiesiac;
            odsetkiCalkowite += odsetkiMiesiac;
            skumulowaneOdsetki += odsetkiMiesiac;
            zyskNetto += odsetkiNettoMiesiac;

            skumulowanaKwota += odsetkiNettoMiesiac;

            if (config.kapitalizacja) {
                kapital += odsetkiNettoMiesiac;
            }

            let oplataZaWykup = 0;
            if (i < miesiace) {
                oplataZaWykup = kwota * config.oplataWykup;
            }

            harmonogram.push({
                okres: okresWiersz,
                kwotaDoWykupu: kwota.toFixed(2),
                oprocentowanieNaCykl: (oprocentowanieMiesieczne * 12 * 100).toFixed(2) + "%",
                odsetkiBrutto: odsetkiMiesiac.toFixed(2),
                skumulowaneOdsetki: skumulowaneOdsetki.toFixed(2),
                oplataZaWykup: oplataZaWykup.toFixed(2),
                podatek: podatekMiesiac.toFixed(2),
                zyskNetto: odsetkiNettoMiesiac.toFixed(2),
                inflacjaRoczna: (inflacja * 100).toFixed(2) + "%",
                kwotaPoZakonczeniuCyklu: skumulowanaKwota.toFixed(2)
            });
        }

        harmonogramData = harmonogram;

        document.getElementById("valueKapital").textContent = `${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
        document.querySelector('.result-wrapper .legend-item[data-index="0"] .color-box').setAttribute('data-tooltip', `Kapitał: ${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`);

        document.getElementById("valueOdsetki").textContent = `${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
        document.querySelector('.result-wrapper .legend-item[data-index="1"] .color-box').setAttribute('data-tooltip', `Odsetki: ${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`);

        const podatekCalkowity = odsetkiCalkowite * podatekBelki;
        document.getElementById("valuePodatek").textContent = `${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
        document.querySelector('.result-wrapper .legend-item[data-index="2"] .color-box').setAttribute('data-tooltip', `Podatek: ${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`);

        document.getElementById("okresInwestycji").textContent = miesiace;
        document.querySelector('.result-wrapper .highlight.yellow').setAttribute('data-hover', `${miesiace} miesięcy`);

        document.getElementById("zyskNetto").textContent = `${zyskNetto.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.querySelector('.result-wrapper .highlight.green').setAttribute('data-hover', `${zyskNetto.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`);

        if (chart) chart.destroy();
        if (chartLine) chartLine.destroy();

        const ctx = document.getElementById("obligacjeChart").getContext("2d");
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Kapitał', 'Odsetki', 'Podatek'],
                datasets: [{
                    data: [kwota, odsetkiCalkowite, podatekCalkowity],
                    backgroundColor: ['#28a745', '#007bff', '#dc3545'],
                    borderWidth: 1,
                    hoverOffset: 8,
                    hoverBackgroundColor: ['#28a745', '#007bff', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 10 },
                        bodyFont: { size: 8 }
                    }
                },
                onHover: (event, chartElement) => {
                    event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                }
            }
        });

        document.querySelectorAll('.result-wrapper .legend-item').forEach(item => {
            item.addEventListener('mouseenter', function() {
                const index = parseInt(this.getAttribute('data-index'));
                chart.setActiveElements([{ datasetIndex: 0, index: index }]);
                chart.update();

                const currentLegend = document.querySelector(`#legend${['Kapital', 'Odsetki', 'Podatek'][index]}`);
                if (currentLegend) {
                    currentLegend.style.opacity = 0;
                }

                const valueElements = document.querySelectorAll('#valueKapital, #valueOdsetki, #valuePodatek');
                valueElements.forEach((value, idx) => {
                    if (idx === index) {
                        value.textContent = `${['Kapitał', 'Odsetki', 'Podatek'][idx]}: ${value.textContent}`;
                    }
                });
            });

            item.addEventListener('mouseleave', function() {
                const index = parseInt(this.getAttribute('data-index'));
                chart.setActiveElements([]);
                chart.update();

                const currentLegend = document.querySelector(`#legend${['Kapital', 'Odsetki', 'Podatek'][index]}`);
                if (currentLegend) {
                    currentLegend.style.opacity = 1;
                }

                document.getElementById("valueKapital").textContent = `${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
                document.getElementById("valueOdsetki").textContent = `${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
                document.getElementById("valuePodatek").textContent = `${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
            });
        });

        let tabela = document.getElementById("harmonogramTabela");
        tabela.innerHTML = "";
        harmonogram.forEach(wiersz => {
            tabela.innerHTML += `
                <tr>
                    <td>${wiersz.okres}</td>
                    <td>${parseFloat(wiersz.kwotaDoWykupu).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                    <td>${wiersz.oprocentowanieNaCykl}</td>
                    <td>${parseFloat(wiersz.odsetkiBrutto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                    <td>${parseFloat(wiersz.skumulowaneOdsetki).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                    <td>${parseFloat(wiersz.oplataZaWykup).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                    <td>${parseFloat(wiersz.podatek).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                    <td>${parseFloat(wiersz.zyskNetto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                    <td>${wiersz.inflacjaRoczna}</td>
                    <td>${parseFloat(wiersz.kwotaPoZakonczeniuCyklu).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                </tr>
            `;
        });

        // Obliczenie dynamicznej skali osi Y
        const maxKwotaPoCyklu = Math.max(...harmonogram.map(wiersz => parseFloat(wiersz.kwotaPoZakonczeniuCyklu)));
        const minKwota = kwota;
        const range = maxKwotaPoCyklu - minKwota;
        const padding = range * 0.1; // Dodajemy 10% marginesu nad i pod wartościami
        const yMin = minKwota - padding;
        const yMax = maxKwotaPoCyklu + padding;
        const stepSize = range / 5; // Dzielimy zakres na 5 kroków

        const ctxLine = document.getElementById("obligacjeChartLine").getContext("2d");
        chartLine = new Chart(ctxLine, {
            type: 'line',
            data: {
                labels: harmonogram.map(wiersz => ["OTS", "ROR", "DOR"].includes(typ) ? `Miesiąc ${wiersz.okres}` : `Rok ${wiersz.okres}`),
                datasets: [
                    {
                        label: 'Zainwestowana kwota',
                        data: harmonogram.map(() => kwota),
                        borderColor: '#8B7D47', // Ciemniejszy beż
                        backgroundColor: 'rgba(139, 125, 71, 0.1)',
                        fill: false,
                        tension: 0,
                        borderWidth: 2
                    },
                    {
                        label: 'Kwota po zakończeniu cyklu',
                        data: harmonogram.map(wiersz => parseFloat(wiersz.kwotaPoZakonczeniuCyklu)),
                        borderColor: '#D4C791', // Jaśniejszy złoty
                        backgroundColor: 'rgba(212, 199, 145, 0.2)',
                        fill: true,
                        tension: 0.1,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: ["OTS", "ROR", "DOR"].includes(typ) ? 'Okres (miesiące)' : 'Okres (lata)',
                            font: { size: 14 }
                        },
                        ticks: { font: { size: 12 } }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Wartość (PLN)',
                            font: { size: 14 }
                        },
                        min: yMin,
                        max: yMax,
                        ticks: {
                            stepSize: stepSize,
                            font: { size: 12 }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: { font: { size: 12 } }
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 12 },
                        bodyFont: { size: 10 }
                    }
                }
            }
        });

        document.getElementById("formSection").style.display = "none";
        document.getElementById("resultSection").style.display = "block";
    }

    document.addEventListener('DOMContentLoaded', function() {
        const obliczBtn = document.getElementById("obliczBtn");
        if (obliczBtn) {
            obliczBtn.addEventListener("click", obliczObligacje);
        } else {
            console.error("Przycisk 'Oblicz' nie został znaleziony w dokumencie.");
        }
    });

    function removePolishChars(text) {
        const polishToLatin = {
            'ą': 'a', 'ć': 'c', 'ę': 'e', 'ł': 'l', 'ń': 'n', 'ó': 'o', 'ś': 's', 'ź': 'z', 'ż': 'z',
            'Ą': 'A', 'Ć': 'C', 'Ę': 'E', 'Ł': 'L', 'Ń': 'N', 'Ó': 'O', 'Ś': 'S', 'Ź': 'Z', 'Ż': 'Z'
        };
        return text.replace(/[ąćęłńóśźżĄĆĘŁŃÓŚŹŻ]/g, match => polishToLatin[match] || match);
    }

    function generatePDF() {
        const doc = new jsPDF();
        doc.setFont("helvetica", "normal");
        doc.setFontSize(16);

        let yOffset = 10;

        doc.text(removePolishChars("Kalkulator Obligacji Skarbu Panstwa - Podsumowanie"), 10, yOffset);
        yOffset += 10;

        doc.setFontSize(14);
        const typ = document.getElementById("typObligacji").value;
        doc.text(removePolishChars(`Wynik inwestycji dla obligacji ${nazwyObligacji[typ]}`), 10, yOffset);
        yOffset += 8;

        doc.setFontSize(10);
        const kapital = document.getElementById("valueKapital").textContent || "-";
        const odsetki = document.getElementById("valueOdsetki").textContent || "-";
        const podatek = document.getElementById("valuePodatek").textContent || "-";
        const okres = document.getElementById("okresInwestycji").textContent || "-";
        const zysk = document.getElementById("zyskNetto").textContent || "-";

        doc.text(removePolishChars(`${kapital}`), 10, yOffset);
        yOffset += 6;
        doc.text(removePolishChars(`${odsetki}`), 10, yOffset);
        yOffset += 6;
        doc.text(removePolishChars(`${podatek}`), 10, yOffset);
        yOffset += 6;
        doc.text(removePolishChars(`Okres inwestycji: ${okres} miesiecy`), 10, yOffset);
        yOffset += 6;
        doc.text(removePolishChars(`Zysk netto: ${zysk} zł`), 10, yOffset);
        yOffset += 10;

        if (harmonogramData.length > 0 && jsPDF.prototype.autoTable) {
            doc.setFontSize(12);
            doc.text(removePolishChars("Harmonogram odsetek"), 10, yOffset);
            yOffset += 6;

            const pierwszaKolumna = ["OTS", "ROR", "DOR"].includes(typ) ? "Miesiac" : "Rok";

            const tableData = harmonogramData.map(row => [
                row.okres,
                row.kwotaDoWykupu + ' zł',
                row.oprocentowanieNaCykl,
                row.odsetkiBrutto + ' zł',
                row.skumulowaneOdsetki + ' zł',
                row.oplataZaWykup + ' zł',
                row.podatek + ' zł',
                row.zyskNetto + ' zł',
                row.inflacjaRoczna,
                row.kwotaPoZakonczeniuCyklu + ' zł'
            ]);

            doc.autoTable({
                startY: yOffset,
                head: [[
                    removePolishChars(pierwszaKolumna),
                    removePolishChars('Kwota wykupu'),
                    removePolishChars('Oproc. cykl'),
                    removePolishChars('Odsetki'),
                    removePolishChars('Odsetki skum.'),
                    removePolishChars('Opłata wyk.'),
                    removePolishChars('Podatek'),
                    removePolishChars('Zysk netto'),
                    removePolishChars('Inflacja'),
                    removePolishChars('Kwota po cykl.')
                ]],
                body: tableData,
                theme: 'grid',
                styles: { font: "helvetica", fontSize: 8, cellPadding: 4, overflow: 'linebreak' },
                headStyles: { fillColor: [194, 178, 128], textColor: [0, 0, 0] },
                columnStyles: { 
                    0: { cellWidth: 15 }, 
                    1: { cellWidth: 25 }, 
                    2: { cellWidth: 20 }, 
                    3: { cellWidth: 20 }, 
                    4: { cellWidth: 25 }, 
                    5: { cellWidth: 20 }, 
                    6: { cellWidth: 20 }, 
                    7: { cellWidth: 20 }, 
                    8: { cellWidth: 20 }, 
                    9: { cellWidth: 25 }
                }
            });
        }

        doc.save("Kalkulator_Obligacji_Skarbowych.pdf");
    }

    document.getElementById("generatePdfBtn").addEventListener("click", generatePDF);
</script>
</body>
</html>
