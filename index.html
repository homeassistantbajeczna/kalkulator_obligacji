<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Obligacji Skarbowych</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f8f9fa; padding: 20px; }
        .container { max-width: 1200px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .result-section { display: none; margin-top: 20px; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: 20px 0; }
        .legend-item { display: inline-flex; align-items: center; margin-right: 15px; }
        .color-box { width: 15px; height: 15px; margin-right: 5px; }
        .highlight { padding: 5px 10px; border-radius: 5px; }
        .yellow { background-color: #fff3cd; }
        .green { background-color: #d4edda; }
        .opis-obligacji { font-size: 0.9em; color: #555; }
        #harmonogramOpis { font-size: 0.85em; color: #666; margin-top: 10px; }
        .variable-input-group { display: flex; align-items: center; margin-bottom: 10px; }
        .variable-input-group label { margin-right: 10px; }
        .btn-danger { margin-left: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Kalkulator Obligacji Skarbowych</h1>
        <script>
    const obligacjeConfig = {
        "OTS": { okres: 3, oprocentowanie: 3.00, kapitalizacja: false, oplataWykup: 0 },
        "ROR": { okres: 12, oprocentowanie: 5.75, kapitalizacja: false, marza: 0, oplataWykup: 0.005 },
        "DOR": { okres: 24, oprocentowanie: 5.90, kapitalizacja: false, marza: 0.15, oplataWykup: 0.007 },
        "TOS": { okres: 36, oprocentowanie: 5.95, kapitalizacja: true, oplataWykup: 0.01 },
        "COI": { okres: 48, oprocentowanie: 6.30, kapitalizacja: false, marza: 1.50, oplataWykup: 0.02 },
        "EDO": { okres: 120, oprocentowanie: 6.55, kapitalizacja: true, marza: 2.00, oplataWykup: 0.03 },
        "ROS": { okres: 72, oprocentowanie: 6.50, kapitalizacja: true, marza: 2.00, oplataWykup: 0.02 },
        "ROD": { okres: 144, oprocentowanie: 6.80, kapitalizacja: true, marza: 2.50, oplataWykup: 0.03 }
    };

    const nazwyObligacji = {
        "OTS": "3-miesięczne OTS",
        "ROR": "12-miesięczne ROR",
        "DOR": "24-miesięczne DOR",
        "TOS": "3-letnie TOS",
        "COI": "4-letnie COI",
        "EDO": "10-letnie EDO",
        "ROS": "6-letnie ROS",
        "ROD": "12-letnie ROD"
    };

    const opisyObligacji = {
        "OTS": "* <strong>OTS (3-miesięczne)</strong>: stałe oprocentowanie <strong>3,00%</strong> na okres <strong>3-miesięcy</strong>, wypłata odsetek nastąpi <strong>przy wykupie</strong> obligacji. Wcześniejszy odkup powoduje nienaliczenie odsetek, natomiast <strong>nie ma opłat za wcześniejszy odkup</strong>. Obligacje <strong>OTS</strong> są idealne dla <strong>krótkoterminowych inwestycji</strong>.",
        "ROR": "* <strong>ROR (12-miesięczne)</strong>: <strong>oprocentowanie zmienne</strong>, w pierwszym miesiącu <strong>5,75%</strong>, w pozostałych <strong>11 miesiącach</strong> oprocentowanie oparte na <strong>stopie referencyjnej NBP + 0%</strong>. Wypłata odsetek następuje <strong>co miesiąc</strong>, jest możliwość wcześniejszego odkupu, niestety wiąże się to z opłatą w wysokości <strong>0,5%</strong> wartości obligacji (<strong>0,5 zł</strong> za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Obligacje <strong>ROR</strong> przeznaczone są dla <strong>krótko i średnioterminowych inwestorów</strong>.",
        "DOR": "* <strong>DOR (24-miesięczne)</strong>: <strong>oprocentowanie zmienne</strong>, <strong>5,90% w pierwszym miesiącu</strong>, w pozostałych <strong>23 miesiącach</strong> oprocentowanie oparte na <strong>stopie referencyjnej NBP + 0,15%</strong>. Wypłata odsetek następuje <strong>co miesiąc</strong>, jest możliwość wcześniejszego odkupu, niestety wiąże się to z opłatą w wysokości <strong>0,7%</strong> wartości obligacji (<strong>0,7 zł</strong> za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Obligacje <strong>DOR</strong> przeznaczone są dla <strong>średnioterminowych inwestorów</strong>.",
        "TOS": "* <strong>TOS (3-letnie)</strong>: <strong>stałe oprocentowanie 5,95%</strong> na okres <strong>3-lat</strong>, wypłata odsetek nastąpi <strong>przy wykupie</strong> obligacji po <strong>3 latach</strong> inwestycji. Wcześniejszy odkup wiąże się z opłatą w wysokości <strong>1%</strong> wartości obligacji (<strong>1 zł</strong> za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. <strong>Roczna kapitalizacja odsetek</strong> zwiększa efektywności inwestycji. Obligacje <strong>TOS</strong> przeznaczone dla <strong>stabilnych średnioterminowych inwestycji</strong>.",
        "COI": "* <strong>COI (4-letnie)</strong>: obligacje <strong>indeksowane inflacją</strong>, <strong>6,30% w pierwszym roku</strong>, w kolejnych <strong>3 latach</strong> oprocentowanie wynosi <strong>wartość inflacji + 1,50%</strong>. Wypłata odsetek następuje <strong>po każdym roku</strong> inwestycji, jest możliwość wcześniejszego odkupu, niestety wiąże się to z opłatą w wysokości <strong>2%</strong> wartości obligacji (<strong>2 zł</strong> za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Obligacje <strong>COI</strong> są idealne dla <strong>średnio i długoterminowych inwestycji</strong> oraz dla <strong>ochrony przed wzrostem inflacji</strong>.",
        "EDO": "* <strong>EDO (10-letnie)</strong>: obligacje <strong>indeksowane inflacją</strong>, <strong>6,55% w pierwszym roku</strong>, w kolejnych <strong>9 latach</strong> oprocentowanie wynosi <strong>wartość inflacji + 2,00%</strong>. Wypłata odsetek następuje <strong>przy wykupie</strong> obligacji po <strong>10 latach inwestycji</strong>. Wcześniejszy odkup niestety wiąże się z opłatą w wysokości <strong>3%</strong> wartości obligacji (<strong>3 zł</strong> za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. <strong>Roczna kapitalizacja odsetek</strong> zwiększa efektywności inwestycji. Obligacje <strong>EDO</strong> są idealne dla <strong>długoterminowych inwestycji</strong> oraz dla <strong>ochrony przed wzrostem inflacji</strong>.",
        "ROS": "* <strong>ROS (6-letnie)</strong>: rodzinne obligacje przeznaczone są wyłącznie dla beneficjentów programu <strong>800+</strong>. Obligacje <strong>indeksowane inflacją</strong>, <strong>6,50% w pierwszym roku</strong>, w kolejnych <strong>5 latach</strong> oprocentowanie wynosi <strong>wartość inflacji + 2,00%</strong>. Wypłata odsetek następuje <strong>przy wykupie</strong> obligacji po <strong>6 latach inwestycji</strong>. Wcześniejszy odkup niestety wiąże się z opłatą w wysokości <strong>2%</strong> wartości obligacji (<strong>2 zł</strong> za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. <strong>Roczna kapitalizacja odsetek</strong> zwiększa efektywności inwestycji. Obligacje <strong>ROS</strong> są idealne dla <strong>rodzinnych inwestycji</strong> oraz dla <strong>ochrony przed wzrostem inflacji</strong>.",
        "ROD": "* <strong>ROD (12-letnie)</strong>: rodzinne obligacje przeznaczone są wyłącznie dla beneficjentów programu <strong>800+</strong>. Obligacje <strong>indeksowane inflacją</strong>, <strong>6,80% w pierwszym roku</strong>, w kolejnych <strong>11 latach</strong> oprocentowanie wynosi <strong>wartość inflacji + 2,50%</strong>. Wypłata odsetek następuje <strong>przy wykupie</strong> obligacji po <strong>12 latach</strong> inwestycji. Wcześniejszy odkup niestety wiąże się z opłatą w wysokości <strong>3%</strong> wartości obligacji (<strong>3 zł</strong> za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. <strong>Roczna kapitalizacja odsetek</strong> zwiększa efektywności inwestycji. Obligacje <strong>ROD</strong> są idealne dla <strong>długoterminowych rodzinnych inwestycji</strong> oraz dla <strong>ochrony przed wzrostem inflacji</strong>."
    };

    const state = {
        chart: null,
        chartLine: null,
        isCalculating: false,
        isIkeIkzeMode: false,
        harmonogramData: [],
        lastFormData: {},
        variableInflacjaChanges: [],
        variableStopaChanges: []
    };

    const elements = {
        kwota: document.getElementById("kwota"),
        typObligacji: document.getElementById("typObligacji"),
        okres: document.getElementById("okres"),
        oprocentowanie: document.getElementById("oprocentowanie"),
        dynamicRate: document.getElementById("dynamicRate"),
        ikeIkzeBtn: document.getElementById("ikeIkzeBtn"),
        inflacjaZmiennaBtn: document.getElementById("inflacjaZmiennaBtn"),
        stopaZmiennaBtn: document.getElementById("stopaZmiennaBtn"),
        formSection: document.getElementById("formSection"),
        resultSection: document.getElementById("resultSection"),
        resultHeader: document.getElementById("resultHeader"),
        obligacjeChart: document.getElementById("obligacjeChart"),
        obligacjeChartLine: document.getElementById("obligacjeChartLine"),
        generatePdfBtn: document.getElementById("generatePdfBtn"),
        obliczBtn: document.getElementById("obliczBtn"),
        powrotBtn: document.getElementById("powrotBtn")
    };
            <section id="formSection">
    <form id="obligacjeForm" class="container">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="kwota">Kwota inwestycji (PLN):</label>
                    <input type="number" class="form-control" id="kwota" min="100" step="100" value="1000" required>
                </div>
                <div class="form-group">
                    <label for="typObligacji">Typ obligacji:</label>
                    <select class="form-control" id="typObligacji"></select>
                </div>
                <div class="form-group">
                    <label for="okres">Okres inwestycji (miesiące):</label>
                    <input type="number" class="form-control" id="okres" readonly>
                </div>
                <div class="form-group">
                    <label for="oprocentowanie">Oprocentowanie w pierwszym okresie (%):</label>
                    <input type="number" class="form-control" id="oprocentowanie" readonly>
                    <small id="oprocentowanieInfo" class="form-text text-muted"></small>
                </div>
                <div class="form-group" id="dynamicRateGroup" style="display: none;">
                    <label for="dynamicRate" id="dynamicRateLabel"></label>
                    <input type="number" class="form-control" id="dynamicRate">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group form-check" style="margin-top: 30px;">
                    <input type="checkbox" class="form-check-input" id="ikeIkzeBtn">
                    <label class="form-check-label" for="ikeIkzeBtn"><strong>Inwestycje w IKE lub IKZE</strong></label>
                </div>
                <div class="form-group form-check" id="inflacjaZmiennaLabel" style="display: none;">
                    <input type="checkbox" class="form-check-input" id="inflacjaZmiennaBtn">
                    <label class="form-check-label" for="inflacjaZmiennaBtn"><strong>Zmienna Inflacja</strong></label>
                </div>
                <div class="form-group form-check" id="stopaZmiennaLabel" style="display: none;">
                    <input type="checkbox" class="form-check-input" id="stopaZmiennaBtn">
                    <label class="form-check-label" for="stopaZmiennaBtn"><strong>Zmienne stopy ref. NBP</strong></label>
                </div>
                <div id="variableInputsContainer" style="display: none;"></div>
                <div class="form-group">
                    <label>Opis obligacji:</label>
                    <div id="opisObligacji" class="opis-obligacji"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12 text-center">
                <button type="button" class="btn btn-primary" id="obliczBtn">Oblicz</button>
            </div>
        </div>
    </form>
</section>

<section id="resultSection" class="result-section">
    <h2 id="resultHeader" class="text-center"></h2>
    <div class="row result-wrapper-chart">
        <div class="col-md-6">
            <div class="chart-container">
                <canvas id="obligacjeChart"></canvas>
            </div>
            <div class="legend">
                <div class="legend-item" data-index="0"><div class="color-box" style="background-color: #28a745;"></div><span id="legendKapital">Kapitał</span></div>
                <div class="legend-item" data-index="1"><div class="color-box" style="background-color: #007bff;"></div><span id="legendOdsetki">Odsetki</span></div>
                <div class="legend-item" data-index="2"><div class="color-box" style="background-color: #dc3545;"></div><span id="legendPodatek">Podatek</span></div>
            </div>
        </div>
        <div class="col-md-6">
            <p><strong>Kapitał:</strong> <span id="valueKapital"></span></p>
            <p><strong>Odsetki:</strong> <span id="valueOdsetki"></span></p>
            <p><strong>Podatek:</strong> <span id="valuePodatek"></span></p>
            <p><strong>Okres inwestycji:</strong> <span class="highlight yellow" id="okresInwestycji"></span></p>
            <p><strong>Zysk netto:</strong> <span class="highlight green" id="zyskNetto"></span></p>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="chart-container">
                <canvas id="obligacjeChartLine"></canvas>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <h3>Harmonogram</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th id="pierwszaKolumnaNaglowek"></th>
                        <th>Wartość inwestycji</th>
                        <th>Oproc.</th>
                        <th>Odsetki</th>
                        <th>Suma odsetek</th>
                        <th>Podatek</th>
                        <th id="zyskKolumnaNaglowek"></th>
                        <th>Opłata za wykup</th>
                        <th id="kolumnaStopaInflacja" style="display: table-cell;"></th>
                        <th>Suma netto</th>
                    </tr>
                </thead>
                <tbody id="harmonogramTabela"></tbody>
            </table>
            <div id="harmonogramOpis"></div>
        </div>
    </div>
    <div class="row">
        <div class="col-12 text-center">
            <button id="generatePdfBtn" class="btn btn-primary">Generuj PDF</button>
            <button id="powrotBtn" class="btn btn-secondary">Powrót</button>
        </div>
    </div>
</section>
            <script>
    function updateLata() {
        const okres = parseInt(elements.okres.value);
        const lata = Math.floor(okres / 12);
        const miesiace = okres % 12;
        let text = "";
        if (lata > 0) text += `${lata} ${lata === 1 ? "rok" : lata > 1 && lata < 5 ? "lata" : "lat"}`;
        if (miesiace > 0) text += (text ? " i " : "") + `${miesiace} ${miesiace === 1 ? "miesiąc" : "miesięcy"}`;
        document.getElementById("oprocentowanieInfo").textContent = text ? `Okres inwestycji: ${text}` : "";
    }

    function updateOprocentowanieInfo() {
        const typ = elements.typObligacji.value;
        const config = obligacjeConfig[typ];
        const info = document.getElementById("oprocentowanieInfo");
        if (["COI", "EDO", "ROS", "ROD"].includes(typ)) {
            info.textContent += `, w kolejnych okresach: inflacja + ${config.marza}%`;
        } else if (["ROR", "DOR"].includes(typ)) {
            info.textContent += `, w kolejnych okresach: stopa ref. NBP + ${config.marza}%`;
        }
    }

    function updateOpisObligacji() {
        const typ = elements.typObligacji.value;
        document.getElementById("opisObligacji").innerHTML = opisyObligacji[typ] || "";
    }

    function setDynamicRateField(label, value, step, max) {
        const group = document.getElementById("dynamicRateGroup");
        group.style.display = "block";
        document.getElementById("dynamicRateLabel").textContent = label + " (%):";
        elements.dynamicRate.value = value;
        elements.dynamicRate.min = "0";
        elements.dynamicRate.max = max;
        elements.dynamicRate.step = step;
    }

    function updateVariableInputs() {
        const typ = elements.typObligacji.value;
        const inflacjaZmienna = elements.inflacjaZmiennaBtn.checked && ["COI", "EDO", "ROS", "ROD"].includes(typ);
        const stopaZmienna = elements.stopaZmiennaBtn.checked && ["ROR", "DOR"].includes(typ);
        const variableInputsContainer = document.getElementById("variableInputsContainer");
        variableInputsContainer.innerHTML = "";

        let changes = inflacjaZmienna ? state.variableInflacjaChanges : (stopaZmienna ? state.variableStopaChanges : []);
        const jednostka = ["OTS", "ROR", "DOR"].includes(typ) ? "miesiąca" : "roku";

        if (inflacjaZmienna || stopaZmienna) {
            variableInputsContainer.style.display = "block";
            changes.forEach((change, index) => {
                const inputGroup = document.createElement("div");
                inputGroup.className = "input-group variable-input-group";
                inputGroup.innerHTML = `
                    <label>Od <input type="number" class="form-control cykl-input" value="${change.cykl}" min="1" step="1" style="width: 70px;"> ${jednostka}:</label>
                    <input type="number" class="form-control wartosc-input" value="${change.wartosc}" min="0" max="50" step="0.1" style="width: 70px;"> %
                    <button class="btn btn-danger remove-variable-btn">Usuń</button>
                `;
                variableInputsContainer.appendChild(inputGroup);

                inputGroup.querySelector(".cykl-input").addEventListener("input", (e) => {
                    changes[index].cykl = parseInt(e.target.value) || 1;
                });
                inputGroup.querySelector(".wartosc-input").addEventListener("input", (e) => {
                    changes[index].wartosc = parseFloat(e.target.value) || 0;
                });
                inputGroup.querySelector(".remove-variable-btn").addEventListener("click", () => {
                    changes.splice(index, 1);
                    updateVariableInputs();
                });
            });

            const addButton = document.createElement("button");
            addButton.className = "btn btn-secondary";
            addButton.textContent = "Dodaj zmianę";
            addButton.addEventListener("click", () => {
                changes.push({ cykl: changes.length ? changes[changes.length - 1].cykl + 1 : 1, wartosc: parseFloat(elements.dynamicRate.value) || (inflacjaZmienna ? 4.90 : 5.75) });
                updateVariableInputs();
            });
            variableInputsContainer.appendChild(addButton);
        } else {
            variableInputsContainer.style.display = "none";
        }
    }

    function updateDynamicRateField() {
        state.isIkeIkzeMode = elements.ikeIkzeBtn.checked;
        const select = elements.typObligacji;
        const previousTyp = select.value;

        select.innerHTML = state.isIkeIkzeMode ? `
            <option value="ROR">12-miesięczne (ROR)</option>
            <option value="DOR">24-miesięczne (DOR)</option>
            <option value="TOS" selected>3-letnie (TOS)</option>
            <option value="COI">4-letnie (COI)</option>
            <option value="EDO">10-letnie (EDO)</option>
        ` : `
            <option value="OTS" selected>3-miesięczne (OTS)</option>
            <option value="ROR">12-miesięczne (ROR)</option>
            <option value="DOR">24-miesięczne (DOR)</option>
            <option value="TOS">3-letnie (TOS)</option>
            <option value="COI">4-letnie (COI)</option>
            <option value="EDO">10-letnie (EDO)</option>
            <option value="ROS">6-letnie (ROS)</option>
            <option value="ROD">12-letnich (ROD)</option>
        `;

        const availableOptions = Array.from(select.options).map(opt => opt.value);
        select.value = availableOptions.includes(previousTyp) ? previousTyp : (state.isIkeIkzeMode ? "TOS" : "OTS");

        const typ = select.value;
        const config = obligacjeConfig[typ];

        elements.okres.value = config.okres;
        elements.oprocentowanie.value = config.oprocentowanie;
        updateLata();
        updateOprocentowanieInfo();
        updateOpisObligacji();

        if (["ROR", "DOR"].includes(typ)) {
            setDynamicRateField("Stopa Ref. NBP", state.lastFormData.dynamicRate || 5.75, "0.05", "20");
            state.lastFormData.isInflacja = false;
        } else if (["COI", "EDO", "ROS", "ROD"].includes(typ)) {
            setDynamicRateField("Inflacja", state.lastFormData.dynamicRate && state.lastFormData.isInflacja ? state.lastFormData.dynamicRate : 4.90, "0.1", "50");
            state.lastFormData.isInflacja = true;
        } else {
            document.getElementById("dynamicRateGroup").style.display = "none";
            state.lastFormData.isInflacja = false;
        }

        document.getElementById("inflacjaZmiennaLabel").style.display = ["COI", "EDO", "ROS", "ROD"].includes(typ) ? "flex" : "none";
        document.getElementById("stopaZmiennaLabel").style.display = ["ROR", "DOR"].includes(typ) ? "flex" : "none";

        elements.inflacjaZmiennaBtn.checked = state.lastFormData.inflacjaZmienna || false;
        elements.stopaZmiennaBtn.checked = state.lastFormData.stopaZmienna || false;
        state.variableInflacjaChanges = state.lastFormData.variableInflacjaChanges ? [...state.lastFormData.variableInflacjaChanges] : [];
        state.variableStopaChanges = state.lastFormData.variableStopaChanges ? [...state.lastFormData.variableStopaChanges] : [];
        updateVariableInputs();
    }

    function updateIloscObligacji() {
        const kwota = parseFloat(elements.kwota.value) || 0;
        const ilosc = Math.floor(kwota / 100);
        if (ilosc > 0) {
            elements.kwota.value = ilosc * 100;
        }
    }

    elements.kwota.addEventListener("input", updateIloscObligacji);
    elements.typObligacji.addEventListener("change", updateDynamicRateField);
    elements.ikeIkzeBtn.addEventListener("change", updateDynamicRateField);
    elements.inflacjaZmiennaBtn.addEventListener("change", updateVariableInputs);
    elements.stopaZmiennaBtn.addEventListener("change", updateVariableInputs);
    elements.obliczBtn.addEventListener("click", obliczObligacje);
    elements.powrotBtn.addEventListener("click", () => {
        elements.formSection.style.display = "block";
        elements.resultSection.style.display = "none";
    });
    elements.generatePdfBtn.addEventListener("click", () => {
        console.log("GeneratePdf clicked");
        generatePdf();
    });
            <script>
    if (typeof pdfMake !== "undefined" && typeof pdfMake.vfs !== "undefined") {
        pdfMake.fonts = {
            Roboto: {
                normal: 'Roboto-Regular.ttf',
                bold: 'Roboto-Medium.ttf',
                italics: 'Roboto-Italic.ttf',
                bolditalics: 'Roboto-MediumItalic.ttf'
            }
        };
    }

    function obliczObligacje() {
        console.log("Starting obliczObligacje");
        if (state.isCalculating) {
            console.log("Calculation already in progress");
            return;
        }
        state.isCalculating = true;

        if (typeof Chart === "undefined") {
            console.error("Biblioteka Chart.js nie została załadowana.");
            alert("Błąd: Nie można załadować wykresów. Spróbuj ponownie później.");
            state.isCalculating = false;
            return;
        }

        const kwota = parseFloat(elements.kwota.value) || 0;
        const typ = elements.typObligacji.value;
        const config = obligacjeConfig[typ];
        const miesiace = config.okres;
        const dynamicRate = parseFloat(elements.dynamicRate.value) / 100 || (["COI", "EDO", "ROS", "ROD"].includes(typ) ? 0.0490 : 0.0575);
        const isInflacja = ["COI", "EDO", "ROS", "ROD"].includes(typ);
        const inflacjaZmienna = elements.inflacjaZmiennaBtn.checked && isInflacja;
        const stopaZmienna = elements.stopaZmiennaBtn.checked && ["ROR", "DOR"].includes(typ);
        const inflacja = isInflacja ? dynamicRate : 0;
        const stopaRel = !isInflacja ? dynamicRate : 0.0575;
        const podatekBelki = state.isIkeIkzeMode ? 0 : 0.19;

        state.lastFormData = {
            kwota: kwota,
            typObligacji: typ,
            dynamicRate: dynamicRate * 100,
            okres: miesiace,
            oprocentowanie: config.oprocentowanie,
            ikeIkze: state.isIkeIkzeMode,
            isInflacja: isInflacja,
            inflacjaZmienna: inflacjaZmienna,
            stopaZmienna: stopaZmienna,
            variableInflacjaChanges: [...state.variableInflacjaChanges],
            variableStopaChanges: [...state.variableStopaChanges]
        };

        if (kwota < 100 || miesiace <= 0) {
            alert("Proszę wypełnić wszystkie wymagane pola poprawnymi wartościami.");
            state.isCalculating = false;
            return;
        }

        elements.resultHeader.textContent = `Wynik inwestycji dla obligacji ${nazwyObligacji[typ]}${state.isIkeIkzeMode ? " (IKE/IKZE)" : ""}`;
        const pierwszaKolumnaNaglowek = document.getElementById("pierwszaKolumnaNaglowek");
        const kolumnaStopaInflacja = document.getElementById("kolumnaStopaInflacja");
        const zyskKolumnaNaglowek = document.getElementById("zyskKolumnaNaglowek");

        if (["OTS", "ROR", "DOR"].includes(typ)) {
            pierwszaKolumnaNaglowek.textContent = "Miesiąc";
            kolumnaStopaInflacja.textContent = ["ROR", "DOR"].includes(typ) ? "Stopa Ref. NBP" : "Inflacja";
            kolumnaStopaInflacja.style.display = ["OTS"].includes(typ) ? "none" : "table-cell";
        } else {
            pierwszaKolumnaNaglowek.textContent = "Rok";
            kolumnaStopaInflacja.textContent = "Inflacja";
            kolumnaStopaInflacja.style.display = ["TOS"].includes(typ) ? "none" : "table-cell";
        }
        zyskKolumnaNaglowek.textContent = state.isIkeIkzeMode ? "Zysk" : "Zysk netto";

        let kapital = kwota;
        let odsetkiCalkowite = 0;
        let zyskNettoCalkowity = 0;
        state.harmonogramData = [];
        let skumulowaneOdsetki = 0;

        let liczbaCykli = ["OTS", "ROR", "DOR"].includes(typ) ? miesiace : miesiace / 12;
        let changes = inflacjaZmienna ? state.variableInflacjaChanges : (stopaZmienna ? state.variableStopaChanges : []);
        changes.sort((a, b) => a.cykl - b.cykl);

        for (let i = 1; i <= liczbaCykli; i++) {
            let okresWiersz = i;
            let changeApplied = false;
            let stopaRefLubInflacja = "-";

            let oprocentowanieRoczne;
            if (inflacjaZmienna || stopaZmienna) {
                let dynamicValue = (inflacjaZmienna ? 4.90 : 5.75) / 100;
                for (const change of changes) {
                    if (i >= change.cykl) {
                        dynamicValue = change.wartosc / 100;
                        if (i === change.cykl) changeApplied = true;
                    }
                }
                oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (dynamicValue + config.marza / 100);
                stopaRefLubInflacja = (dynamicValue * 100).toFixed(2) + "%";
            } else if (isInflacja) {
                oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (inflacja + config.marza / 100);
                stopaRefLubInflacja = (inflacja * 100).toFixed(2) + "%";
            } else if (["ROR", "DOR"].includes(typ)) {
                oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (stopaRel + config.marza / 100);
                stopaRefLubInflacja = (stopaRel * 100).toFixed(2) + "%";
            } else {
                oprocentowanieRoczne = config.oprocentowanie / 100;
            }

            let oprocentowanieMiesieczne = oprocentowanieRoczne / 12;
            let miesiecyWCyklu = ["OTS", "ROR", "DOR"].includes(typ) ? 1 : 12;
            let odsetkiCykl = kapital * oprocentowanieMiesieczne * miesiecyWCyklu;

            let podatekCykl = odsetkiCykl * podatekBelki;
            let odsetkiNettoCykl = state.isIkeIkzeMode ? odsetkiCykl : (odsetkiCykl - podatekCykl);

            odsetkiCalkowite += odsetkiCykl;
            skumulowaneOdsetki += odsetkiCykl;
            zyskNettoCalkowity += odsetkiNettoCykl;

            let wartoscInwestycji = kwota;
            if (config.kapitalizacja) {
                kapital += odsetkiCykl;
                wartoscInwestycji = kapital;
            }

            let kwotaPoCyklu = state.isIkeIkzeMode ? (config.kapitalizacja ? wartoscInwestycji : kwota + zyskNettoCalkowity) : 
                (config.kapitalizacja ? (wartoscInwestycji - skumulowaneOdsetki * 0.19) : kwota + zyskNettoCalkowity);

            let oplataZaWykup = i < liczbaCykli ? kwota * config.oplataWykup : 0;

            state.harmonogramData.push({
                okres: okresWiersz,
                wartoscInwestycji: wartoscInwestycji.toFixed(2),
                oprocentowanieNaCykl: (oprocentowanieRoczne * 100).toFixed(2) + "%",
                odsetkiBrutto: odsetkiCykl.toFixed(2),
                skumulowaneOdsetki: skumulowaneOdsetki.toFixed(2),
                podatek: podatekCykl.toFixed(2),
                zyskNetto: odsetkiNettoCykl.toFixed(2),
                oplataZaWykup: oplataZaWykup.toFixed(2),
                stopaRefLubInflacja: stopaRefLubInflacja,
                kwotaPoZakonczeniuCyklu: kwotaPoCyklu.toFixed(2),
                changeApplied: changeApplied
            });
        }

        document.getElementById("valueKapital").textContent = `${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
        document.querySelector('.result-wrapper-chart .legend-item[data-index="0"] .color-box').setAttribute('data-tooltip', `Kapitał: ${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`);
        document.getElementById("valueOdsetki").textContent = `${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
        document.querySelector('.result-wrapper-chart .legend-item[data-index="1"] .color-box').setAttribute('data-tooltip', `Odsetki: ${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`);
        const podatekCalkowity = odsetkiCalkowite * (state.isIkeIkzeMode ? 0 : 0.19);
        document.getElementById("valuePodatek").textContent = `${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
        document.querySelector('.result-wrapper-chart .legend-item[data-index="2"] .color-box').setAttribute('data-tooltip', `Podatek: ${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`);
        document.getElementById("okresInwestycji").textContent = miesiace;
        document.querySelector('.result-wrapper-chart .highlight.yellow').setAttribute('data-hover', `${miesiace} miesięcy`);
        document.getElementById("zyskNetto").textContent = `${zyskNettoCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
        document.querySelector('.result-wrapper-chart .highlight.green').setAttribute('data-hover', `${zyskNettoCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`);

        if (state.chart) state.chart.destroy();
        if (state.chartLine) state.chartLine.destroy();

        const ctx = elements.obligacjeChart.getContext("2d");
        state.chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Kapitał', 'Odsetki', 'Podatek'],
                datasets: [{
                    data: [kwota, odsetkiCalkowite, podatekCalkowity],
                    backgroundColor: ['#28a745', '#007bff', '#dc3545'],
                    borderWidth: 1,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });

        document.querySelectorAll('.result-wrapper-chart .legend-item').forEach(item => {
            item.addEventListener('mouseenter', function() {
                const index = parseInt(this.getAttribute('data-index'));
                state.chart.setActiveElements([{ datasetIndex: 0, index: index }]);
                state.chart.update();
                const currentLegend = document.querySelector(`#legend${['Kapital', 'Odsetki', 'Podatek'][index]}`);
                if (currentLegend) currentLegend.style.opacity = 0;
                const valueElements = document.querySelectorAll('#valueKapital, #valueOdsetki, #valuePodatek');
                valueElements.forEach((value, idx) => {
                    if (idx === index) value.textContent = `${['Kapitał', 'Odsetki', 'Podatek'][idx]}: ${value.textContent}`;
                });
            });

            item.addEventListener('mouseleave', function() {
                const index = parseInt(this.getAttribute('data-index'));
                state.chart.setActiveElements([]);
                state.chart.update();
                const currentLegend = document.querySelector(`#legend${['Kapital', 'Odsetki', 'Podatek'][index]}`);
                if (currentLegend) currentLegend.style.opacity = 1;
                document.getElementById("valueKapital").textContent = `${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
                document.getElementById("valueOdsetki").textContent = `${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
                document.getElementById("valuePodatek").textContent = `${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
            });
        });

        let tabela = document.getElementById("harmonogramTabela");
        tabela.innerHTML = "";
        state.harmonogramData.forEach(wiersz => {
            let rowHTML = `
                <tr>
                    <td>${wiersz.okres}</td>
                    <td>${parseFloat(wiersz.wartoscInwestycji).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                    <td>${wiersz.oprocentowanieNaCykl}${wiersz.changeApplied ? ' ★' : ''}</td>
                    <td>${parseFloat(wiersz.odsetkiBrutto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                    <td>${parseFloat(wiersz.skumulowaneOdsetki).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                    <td>${state.isIkeIkzeMode ? "0,00 zł*" : parseFloat(wiersz.podatek).toLocaleString('pl-PL', { minimumFractionDigits: 2 }) + " zł"}</td>
                    <td>${parseFloat(wiersz.zyskNetto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                    <td>${parseFloat(wiersz.oplataZaWykup).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
            `;
            if (!["OTS", "TOS"].includes(typ)) {
                rowHTML += `<td>${wiersz.stopaRefLubInflacja}</td>`;
            }
            rowHTML += `
                    <td>${parseFloat(wiersz.kwotaPoZakonczeniuCyklu).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                </tr>
            `;
            tabela.innerHTML += rowHTML;
        });

        const harmonogramOpis = document.getElementById("harmonogramOpis");
        if (state.isIkeIkzeMode) {
            harmonogramOpis.innerHTML = "* Podatek wyniesie <strong>0 zł</strong> po osiągnięciu <strong>wieku emerytalnego</strong> i <strong>55 roku życia</strong> lub <strong>60 roku życia</strong> w przypadku <strong>IKE</strong> oraz <strong>10 % zryczałtowanego podatku</strong> po osiągnięciu <strong>65 roku życia</strong> w przypadku <strong>IKZE</strong>.";
            harmonogramOpis.style.display = "block";
        } else {
            harmonogramOpis.innerHTML = "";
            harmonogramOpis.style.display = "none";
        }

        const maxKwotaPoCyklu = Math.max(...state.harmonogramData.map(wiersz => parseFloat(wiersz.kwotaPoZakonczeniuCyklu)));
        const minKwota = kwota;
        const range = maxKwotaPoCyklu - minKwota;
        const padding = range * 0.1;
        const yMin = minKwota - padding;
        const yMax = maxKwotaPoCyklu + padding;
        const stepSize = range / 5;

        const ctxLine = elements.obligacjeChartLine.getContext("2d");
        state.chartLine = new Chart(ctxLine, {
            type: 'line',
            data: {
                labels: state.harmonogramData.map(wiersz => ["OTS", "ROR", "DOR"].includes(typ) ? `Miesiąc ${wiersz.okres}` : `Rok ${wiersz.okres}`),
                datasets: [
                    {
                        label: 'Zainwestowana kwota',
                        data: state.harmonogramData.map(() => kwota),
                        borderColor: '#8B7D47',
                        backgroundColor: 'rgba(139, 125, 71, 0.1)',
                        fill: false,
                        tension: 0,
                        borderWidth: 2
                    },
                    {
                        label: 'Kwota po zakończeniu cyklu',
                        data: state.harmonogramData.map(wiersz => parseFloat(wiersz.kwotaPoZakonczeniuCyklu)),
                        borderColor: '#D4C791',
                        backgroundColor: 'rgba(212, 199, 145, 0.2)',
                        fill: true,
                        tension: 0.1,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: ["OTS", "ROR", "DOR"].includes(typ) ? 'Okres (miesiące)' : 'Okres (lata)', font: { size: 14 } }, ticks: { font: { size: 12 } } },
                    y: { title: { display: true, text: 'Wartość (PLN)', font: { size: 14 } }, min: yMin, max: yMax, ticks: { stepSize: stepSize, font: { size: 12 } } }
                },
                plugins: { legend: { labels: { font: { size: 12 } } } }
            }
        });

        elements.formSection.style.display = "none";
        elements.resultSection.style.display = "block";
        elements.generatePdfBtn.disabled = false;
        console.log("GeneratePdfBtn enabled:", !elements.generatePdfBtn.disabled);
        state.isCalculating = false;
        console.log("ObliczObligacje completed");
    }

    function generatePdf() {
        console.log("Starting generatePdf");
        if (typeof pdfMake === "undefined") {
            console.error("Biblioteka PDFMake nie została załadowana.");
            alert("Błąd: Biblioteka PDFMake nie jest załadowana. Sprawdź, czy skrypt PDFMake jest poprawnie dołączony w HTML.");
            return;
        }

        if (!state.harmonogramData.length) {
            console.log("No harmonogram data available");
            alert("Najpierw oblicz wyniki inwestycji, klikając 'Oblicz'.");
            return;
        }

        const typ = state.lastFormData.typObligacji;
        const nazwaObligacji = nazwyObligacji[typ];
        const headerText = `Wynik inwestycji dla obligacji ${nazwaObligacji}${state.isIkeIkzeMode ? " (IKE/IKZE)" : ""}`;
        const opis = opisyObligacji[typ] || "";

        const summary = [
            `Kapitał: ${parseFloat(state.lastFormData.kwota).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
            `Odsetki: ${parseFloat(document.getElementById("valueOdsetki").textContent.replace(/[^\d,.]/g, "").replace(",", ".")).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
            `Podatek: ${parseFloat(document.getElementById("valuePodatek").textContent.replace(/[^\d,.]/g, "").replace(",", ".")).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
            `Okres inwestycji: ${state.lastFormData.okres} miesięcy`,
            `Zysk netto: ${parseFloat(document.getElementById("zyskNetto").textContent.replace(/[^\d,.]/g, "").replace(",", ".")).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`
        ];

        const headers = ["OTS", "ROR", "DOR"].includes(typ) ?
            ["Miesiąc", "Wartość inwestycji", "Oproc.", "Odsetki", "Suma odsetek", "Podatek", "Zysk netto", "Opłata za wykup", "Stopa Ref. NBP", "Suma netto"] :
            ["Rok", "Wartość inwestycji", "Oproc.", "Odsetki", "Suma odsetek", "Podatek", "Zysk netto", "Opłata za wykup", "Inflacja", "Suma netto"];
        if (["OTS", "TOS"].includes(typ)) headers.splice(8, 1);

        const tableData = state.harmonogramData.map(wiersz => {
            const row = [
                wiersz.okres.toString(),
                `${parseFloat(wiersz.wartoscInwestycji).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                wiersz.oprocentowanieNaCykl,
                `${parseFloat(wiersz.odsetkiBrutto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                `${parseFloat(wiersz.skumulowaneOdsetki).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                state.isIkeIkzeMode ? "0,00 zł*" : `${parseFloat(wiersz.podatek).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                `${parseFloat(wiersz.zyskNetto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                `${parseFloat(wiersz.oplataZaWykup).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`
            ];
            if (!["OTS", "TOS"].includes(typ)) row.push(wiersz.stopaRefLubInflacja);
            row.push(`${parseFloat(wiersz.kwotaPoZakonczeniuCyklu).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`);
            return row;
        });

        const lineChartCanvas = document.getElementById("obligacjeChartLine");
        const lineChartImage = lineChartCanvas.toDataURL("image/png");

        const docDefinition = {
            pageSize: 'A4',
            pageMargins: [20, 20, 20, 20],
            defaultStyle: { font: 'Roboto' },
            content: [
                { text: headerText, style: 'header' },
                { text: opis.replace(/<[^>]+>/g, ""), style: 'subheader', margin: [0, 10, 0, 10] },
                { text: "Podsumowanie:", style: 'sectionHeader', margin: [0, 10, 0, 5] },
                { ul: summary.map(item => ({ text: item, style: 'listItem' })), margin: [0, 0, 0, 10] },
                {
                    table: {
                        headerRows: 1,
                        widths: headers.map(() => '*'),
                        body: [
                            headers.map(h => ({ text: h, style: 'tableHeader' })),
                            ...tableData.map(row => row.map(cell => ({ text: cell, style: 'tableCell' })))
                        ]
                    },
                    layout: {
                        fillColor: function (rowIndex) { return (rowIndex === 0) ? '#C2B280' : (rowIndex % 2 === 0 ? '#F5F5F5' : null); },
                        hLineWidth: function () { return 0.5; },
                        vLineWidth: function () { return 0.5; }
                    },
                    margin: [0, 10, 0, 10]
                },
                state.isIkeIkzeMode ? { 
                    text: "* Podatek wyniesie 0 zł po osiągnięciu wieku emerytalnego i 55 roku życia lub 60 roku życia w przypadku IKE oraz 10 % zryczałtowanego podatku po osiągnięciu 65 roku życia w przypadku IKZE.", 
                    style: 'footerNote', 
                    margin: [0, 5, 0, 10] 
                } : {},
                { text: "Wykres liniowy wartości inwestycji w czasie", style: 'sectionHeader', margin: [0, 10, 0, 5], pageBreak: tableData.length > 10 ? 'before' : 'none' },
                { image: lineChartImage, width: 500, height: 250, alignment: 'center', margin: [0, 5, 0, 0] }
            ],
            styles: {
                header: { fontSize: 16, bold: true, alignment: 'center', margin: [0, 0, 0, 10] },
                subheader: { fontSize: 10, alignment: 'justify' },
                sectionHeader: { fontSize: 12, bold: true },
                listItem: { fontSize: 10, margin: [0, 2, 0, 2] },
                tableHeader: { fontSize: 8, bold: true, alignment: 'center', color: '#000000', fillColor: '#C2B280' },
                tableCell: { fontSize: 8, alignment: 'center' },
                footerNote: { fontSize: 8, italics: true }
            }
        };

        try {
            pdfMake.createPdf(docDefinition).download(`Wynik_inwestycji_${nazwaObligacji.replace(/\s+/g, "_")}.pdf`);
            console.log("PDF generated successfully");
        } catch (error) {
            console.error("Error generating PDF:", error);
            alert("Błąd podczas generowania PDF. Sprawdź konsolę dla szczegółów.");
        }
    }

    updateDynamicRateField();
    updateIloscObligacji();
</script>
</body>
</html>
