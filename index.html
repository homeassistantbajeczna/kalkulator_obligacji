<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Obligacji Skarbu Państwa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        body {
            background-color: #f5f6f5;
            font-family: 'Arial', sans-serif;
            padding: 10px;
        }
        .container {
            max-width: 1200px;
            margin: 30px auto 0;
            background: #FFFFFF;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .form-section, .result-section { padding: 10px; }
        .result-section { display: none; }
        .form-group { margin-bottom: 15px; }
        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart { width: 120px; height: 120px; }
        .harmonogram table {
            margin: 0 auto;
            width: auto;
            border-collapse: collapse;
        }
        .harmonogram th, .harmonogram td {
            padding: 10px;
            text-align: center;
            border: 1px solid #eee;
        }
        .harmonogram th {
            background: linear-gradient(90deg, #C2B280, #b0a070);
            color: #000000;
        }
        .btn-primary {
            background: linear-gradient(135deg, #C2B280, #b0a070);
            border: none;
            color: #000000;
            padding: 8px 20px;
            border-radius: 25px;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #b0a070, #C2B280);
            color: #000000;
        }
        #generatePdfBtn { position: absolute; top: 0; right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-section" id="formSection">
            <h4>Kalkulator Obligacji Skarbu Państwa</h4>
            <form id="obligacjeForm">
                <div class="form-group">
                    <label for="kwota">Kwota inwestycji</label>
                    <input type="number" class="form-control" id="kwota" min="100" step="100" value="10000">
                </div>
                <div class="form-group">
                    <label for="typObligacji">Typ obligacji</label>
                    <select class="form-control" id="typObligacji">
                        <option value="OTS" selected>3-miesięczne (OTS)</option>
                        <option value="ROR">12-miesięczne (ROR)</option>
                        <option value="DOR">24-miesięczne (DOR)</option>
                        <option value="TOS">3-letnie (TOS)</option>
                        <option value="COI">4-letnie (COI)</option>
                        <option value="EDO">10-letnie (EDO)</option>
                    </select>
                </div>
                <button type="button" class="btn btn-primary" id="obliczBtn">Oblicz</button>
            </form>
        </div>
        <div class="result-section" id="resultSection">
            <div class="result-header" style="position: relative;">
                <h4 id="resultHeader">Podsumowanie wyników</h4>
                <button id="generatePdfBtn" class="btn btn-primary btn-sm">Generuj PDF</button>
            </div>
            <button class="btn btn-secondary mb-3" onclick="showForm()">Powrót do edycji</button>
            <div class="chart-container">
                <div class="chart">
                    <canvas id="obligacjeChart"></canvas>
                </div>
                <div class="chart-legend">
                    <div>Kapitał: <span id="valueKapital">-</span></div>
                    <div>Odsetki: <span id="valueOdsetki">-</span></div>
                    <div>Podatek: <span id="valuePodatek">-</span></div>
                </div>
            </div>
            <div>Zysk netto: <span id="zyskNetto">-</span></div>
            <div class="harmonogram">
                <h5>Harmonogram odsetek</h5>
                <table>
                    <thead id="harmonogramNaglowek">
                        <tr>
                            <th>Okres</th>
                            <th>Wartość inwestycji</th>
                            <th>Oprocentowanie</th>
                            <th>Odsetki</th>
                            <th>Zysk netto</th>
                        </tr>
                    </thead>
                    <tbody id="harmonogramTabela"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="script.js"></script>
</body>
</html>
console.log("Skrypt JavaScript został załadowany");

let chart;
let harmonogramData = [];
let lastFormData = { kwota: 10000, typObligacji: "OTS" };

const obligacjeConfig = {
    "OTS": { okres: 3, oprocentowanie: 3.00, zmienne: false, kapitalizacja: false },
    "ROR": { okres: 12, oprocentowanie: 5.75, zmienne: true, marza: 0.00, kapitalizacja: false },
    "DOR": { okres: 24, oprocentowanie: 5.90, zmienne: true, marza: 0.15, kapitalizacja: false },
    "TOS": { okres: 36, oprocentowanie: 5.95, zmienne: false, kapitalizacja: true },
    "COI": { okres: 48, oprocentowanie: 6.30, zmienne: true, marza: 1.50, indeksowaneInflacja: true, kapitalizacja: false },
    "EDO": { okres: 120, oprocentowanie: 6.55, zmienne: true, marza: 2.00, indeksowaneInflacja: true, kapitalizacja: true }
};

function showForm() {
    document.getElementById("formSection").style.display = "block";
    document.getElementById("resultSection").style.display = "none";
    document.getElementById("kwota").value = lastFormData.kwota;
    document.getElementById("typObligacji").value = lastFormData.typObligacji;
}

function obliczObligacje() {
    console.log("Funkcja obliczObligacje została wywołana");
    const kwota = parseFloat(document.getElementById("kwota").value) || 0;
    const typ = document.getElementById("typObligacji").value;
    const config = obligacjeConfig[typ];
    const miesiace = config.okres;
    const podatekBelki = 0.19;

    lastFormData = { kwota: kwota, typObligacji: typ };

    if (kwota < 100 || miesiace <= 0) {
        alert("Proszę podać poprawną kwotę (min. 100 zł).");
        return;
    }

    document.getElementById("resultHeader").textContent = `Wynik inwestycji dla obligacji ${typ}`;

    let kapital = kwota;
    let odsetkiCalkowite = 0;
    let zyskNettoCalkowity = 0;
    let harmonogram = [];

    let liczbaCykli = ["OTS", "ROR", "DOR"].includes(typ) ? miesiace : miesiace / 12;

    for (let i = 1; i <= liczbaCykli; i++) {
        let oprocentowanieRoczne = config.oprocentowanie / 100;
        let miesiecyWCyklu = ["OTS", "ROR", "DOR"].includes(typ) ? 1 : 12;
        let odsetkiCykl = kapital * (oprocentowanieRoczne / 12) * miesiecyWCyklu;

        let podatekCykl = odsetkiCykl * podatekBelki;
        let odsetkiNettoCykl = odsetkiCykl - podatekCykl;

        odsetkiCalkowite += odsetkiCykl;
        zyskNettoCalkowity += odsetkiNettoCykl;

        if (config.kapitalizacja) {
            kapital += odsetkiCykl;
        }

        harmonogram.push({
            okres: i,
            wartoscInwestycji: kapital.toFixed(2),
            oprocentowanie: (oprocentowanieRoczne * 100).toFixed(2) + "%",
            odsetki: odsetkiCykl.toFixed(2),
            zyskNetto: odsetkiNettoCykl.toFixed(2)
        });
    }

    harmonogramData = harmonogram;

    document.getElementById("valueKapital").textContent = `${kwota.toLocaleString('pl-PL')} zł`;
    document.getElementById("valueOdsetki").textContent = `${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
    document.getElementById("valuePodatek").textContent = `${(odsetkiCalkowite * podatekBelki).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
    document.getElementById("zyskNetto").textContent = `${zyskNettoCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;

    if (chart) chart.destroy();
    const ctx = document.getElementById("obligacjeChart").getContext("2d");
    chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Kapitał', 'Odsetki', 'Podatek'],
            datasets: [{
                data: [kwota, odsetkiCalkowite, odsetkiCalkowite * podatekBelki],
                backgroundColor: ['#28a745', '#007bff', '#dc3545'],
                borderWidth: 1
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    let tabela = document.getElementById("harmonogramTabela");
    tabela.innerHTML = "";
    harmonogram.forEach(wiersz => {
        tabela.innerHTML += `
            <tr>
                <td>${wiersz.okres}</td>
                <td>${wiersz.wartoscInwestycji} zł</td>
                <td>${wiersz.oprocentowanie}</td>
                <td>${wiersz.odsetki} zł</td>
                <td>${wiersz.zyskNetto} zł</td>
            </tr>
        `;
    });

    document.getElementById("formSection").style.display = "none";
    document.getElementById("resultSection").style.display = "block";
}

document.getElementById("obliczBtn").addEventListener("click", obliczObligacje);

// Poprawiona funkcja generowania PDF
document.getElementById("generatePdfBtn").addEventListener("click", function() {
    console.log("Przycisk Generuj PDF został kliknięty");

    if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("Błąd: Biblioteka jsPDF nie jest załadowana. Sprawdź połączenie internetowe.");
        console.error("jsPDF nie jest dostępne.");
        return;
    }

    if (!harmonogramData.length) {
        alert("Najpierw kliknij 'Oblicz', aby wygenerować dane.");
        console.warn("harmonogramData jest puste.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
    const typ = lastFormData.typObligacji;
    const headerText = `Wynik inwestycji dla obligacji ${typ}`;
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 10;

    // Nagłówek
    doc.setFontSize(16);
    doc.setFont("helvetica", "bold");
    const headerWidth = doc.getTextWidth(headerText);
    doc.text(headerText, (pageWidth - headerWidth) / 2, 15);

    // Podsumowanie
    doc.setFontSize(12);
    doc.setFont("helvetica", "normal");
    const podsumowanie = [
        `Kapitał: ${document.getElementById("valueKapital").textContent}`,
        `Odsetki: ${document.getElementById("valueOdsetki").textContent}`,
        `Podatek: ${document.getElementById("valuePodatek").textContent}`,
        `Zysk netto: ${document.getElementById("zyskNetto").textContent}`
    ];
    let y = 25;
    podsumowanie.forEach(line => {
        doc.text(line, margin, y);
        y += 7;
    });

    // Tabela harmonogramu
    const headers = ["Okres", "Wartość inwestycji", "Oprocentowanie", "Odsetki", "Zysk netto"];
    const data = harmonogramData.map(wiersz => [
        wiersz.okres.toString(),
        `${wiersz.wartoscInwestycji} zł`,
        wiersz.oprocentowanie,
        `${wiersz.odsetki} zł`,
        `${wiersz.zyskNetto} zł`
    ]);

    doc.autoTable({
        head: [headers],
        body: data,
        startY: y + 10,
        theme: 'grid',
        headStyles: { fillColor: [194, 178, 128], textColor: [0, 0, 0], fontStyle: 'bold' },
        styles: { fontSize: 10, cellPadding: 2 }
    });

    // Zapis pliku
    doc.save(`Wynik_inwestycji_${typ}.pdf`);
    console.log("PDF został wygenerowany i zapisany.");
});
