<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Obligacji Skarbu Państwa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Dodajemy PDFMake zamiast jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.js"></script>
    <style>
        /* Twój istniejący CSS - bez zmian */
        body {
            background-color: #f5f6f5;
            font-family: 'Montserrat', sans-serif;
            padding: 10px;
        }
        /* ... reszta Twojego CSS pozostaje taka sama ... */
    </style>
</head>
<body>
    <div class="logo-container">
        <a href="https://finance-brothers.pl">
            <img src="cropped-logo-FB-1.png" alt="Twoje Logo" class="logo d-block mx-auto">
        </a>
    </div>
    <div class="container">
        <div class="form-section" id="formSection">
            <div class="header-row">
                <h4>Kalkulator Obligacji Skarbu Państwa</h4>
                <label class="checkbox-label header-checkbox">
                    <input type="checkbox" id="ikeIkzeBtn">
                    <span class="checkbox-custom"></span>
                    Inwestycje w IKE lub IKZE
                </label>
            </div>
            <div class="form-container">
                <div class="form-wrapper">
                    <form id="obligacjeForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="kwota" class="form-label">Kwota inwestycji</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="kwota" min="100" max="5000000" step="100" value="10000">
                                    <span class="input-group-text">zł</span>
                                </div>
                                <input type="range" class="form-range" id="kwotaRange" min="100" max="5000000" step="100" value="10000">
                                <div class="sub-info" id="iloscObligacji">Ilość obligacji: 100</div>
                            </div>
                            <div class="form-group">
                                <label for="typObligacji" class="form-label">Typ obligacji*</label>
                                <select class="form-control" id="typObligacji">
                                    <option value="OTS" selected>3-miesięczne (OTS)</option>
                                    <option value="ROR">12-miesięczne (ROR)</option>
                                    <option value="DOR">24-miesięczne (DOR)</option>
                                    <option value="TOS">3-letnie (TOS)</option>
                                    <option value="COI">4-letnie (COI)</option>
                                    <option value="EDO">10-letnie (EDO)</option>
                                    <option value="ROS">6-letnie (ROS)</option>
                                    <option value="ROD">12-letnie (ROD)</option>
                                </select>
                                <div class="sub-info"></div>
                            </div>
                            <div class="form-group" id="dynamicRateGroup" style="display: none;">
                                <label for="dynamicRate" class="form-label" id="dynamicRateLabel">Stopa Ref. NBP</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="dynamicRate" min="0" max="50" step="0.05" value="4.90">
                                    <span class="input-group-text">%</span>
                                </div>
                                <input type="range" class="form-range" id="dynamicRateRange" min="0" max="50" step="0.05" value="4.90">
                                <div class="sub-info"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="okres" class="form-label">Okres inwestycji</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="okres" min="3" max="144" step="1" value="3" readonly>
                                    <span class="input-group-text">mc-y</span>
                                </div>
                                <div class="sub-info" id="lata"></div>
                            </div>
                            <div class="form-group">
                                <label for="oprocentowanie" class="form-label">Oprocentowanie</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="oprocentowanie" min="0.1" max="25" step="0.1" value="3" readonly>
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="sub-info" id="oprocentowanieInfo"></div>
                            </div>
                        </div>
                        <!-- Reszta formularza bez zmian -->
                        <div class="form-row">
                            <button type="button" class="btn btn-primary" id="obliczBtn" style="margin: 25px auto 0;">Oblicz</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="opis-container">
                <div class="obligacje-opis" id="obligacjeOpis"></div>
            </div>
            <div class="data-container">
                <div class="data-info"><strong>Dane z dnia:</strong> <span class="data-date"><strong>01.03.2025r.</strong></span></div>
            </div>
        </div>
        <div class="result-section" id="resultSection" style="display: none;">
            <div class="result-header">
                <h4 id="resultHeader">Podsumowanie wyników</h4>
                <button id="generatePdfBtn" class="btn btn-primary btn-sm">Generuj PDF</button>
            </div>
            <button class="btn btn-secondary mb-3" onclick="showForm()">Powrót do edycji</button>
            <!-- Reszta sekcji wyników bez zmian -->
        </div>
    </div>
</body>
</html>
<script>
console.log("Skrypt JavaScript został załadowany");

let chart, chartLine;
let harmonogramData = [];
let isIkeIkzeMode = false;
let variableInflacjaChanges = [];
let variableStopaChanges = [];
let lastFormData = {
    kwota: 10000,
    typObligacji: "OTS",
    dynamicRate: 5.75,
    okres: 3,
    oprocentowanie: 3,
    ikeIkze: false,
    isInflacja: false,
    inflacjaZmienna: false,
    stopaZmienna: false,
    variableInflacjaChanges: [],
    variableStopaChanges: []
};

const maxVariableChanges = {
    "ROR": 11,
    "DOR": 23,
    "COI": 3,
    "EDO": 9,
    "ROS": 5,
    "ROD": 11
};

const obligacjeConfig = {
    "OTS": { okres: 3, oprocentowanie: 3.00, zmienne: false, kapitalizacja: false, oplataWykup: 0.00 },
    "ROR": { okres: 12, oprocentowanie: 5.75, zmienne: true, marza: 0.00, kapitalizacja: false, oplataWykup: 0.005 },
    "DOR": { okres: 24, oprocentowanie: 5.90, zmienne: true, marza: 0.15, kapitalizacja: false, oplataWykup: 0.007 },
    "TOS": { okres: 36, oprocentowanie: 5.95, zmienne: false, kapitalizacja: true, oplataWykup: 0.01 },
    "COI": { okres: 48, oprocentowanie: 6.30, zmienne: true, marza: 1.50, indeksowaneInflacja: true, kapitalizacja: false, oplataWykup: 0.02 },
    "EDO": { okres: 120, oprocentowanie: 6.55, zmienne: true, marza: 2.00, indeksowaneInflacja: true, kapitalizacja: true, oplataWykup: 0.03 },
    "ROS": { okres: 72, oprocentowanie: 6.50, zmienne: true, marza: 2.00, indeksowaneInflacja: true, kapitalizacja: true, oplataWykup: 0.02 },
    "ROD": { okres: 144, oprocentowanie: 6.80, zmienne: true, marza: 2.50, indeksowaneInflacja: true, kapitalizacja: true, oplataWykup: 0.03 }
};

const opisyObligacji = {
    "OTS": "* <strong>OTS (3-miesięczne) </strong>: stałe oprocentowanie <strong>3,00%</strong> na okres <strong>3-miesięcy</strong>...",
    "ROR": "* <strong>ROR (12-miesięczne) </strong>: <strong>oprocentowanie zmienne</strong>, w pierwszym miesiącu <strong>5,75%</strong>...",
    // Reszta opisów jak w Twoim kodzie
};

const nazwyObligacji = {
    "OTS": "3-miesięcznych (OTS)", "ROR": "12-miesięcznych (ROR)", "DOR": "24-miesięcznych (DOR)", "TOS": "3-letnich (TOS)",
    "COI": "4-letnich (COI)", "EDO": "10-letnich (EDO)", "ROS": "6-letnich (ROS)", "ROD": "12-letnich (ROD)"
};

// Funkcje obsługi formularza i obliczeń - bez zmian
document.getElementById("dynamicRateRange").addEventListener("input", function() {
    document.getElementById("dynamicRate").value = this.value;
});

// Reszta funkcji jak updateDynamicRateField, updateIloscObligacji itd. pozostaje taka sama

function obliczObligacje() {
    console.log("Funkcja obliczObligacje została wywołana");
    const kwota = parseFloat(document.getElementById("kwota").value) || 0;
    const typ = document.getElementById("typObligacji").value;
    const config = obligacjeConfig[typ];
    const miesiace = config.okres;
    const dynamicRate = parseFloat(document.getElementById("dynamicRate").value) / 100 || (["COI", "EDO", "ROS", "ROD"].includes(typ) ? 0.0490 : 0.0575);
    const isInflacja = ["COI", "EDO", "ROS", "ROD"].includes(typ);
    const podatekBelki = isIkeIkzeMode ? 0 : 0.19;

    lastFormData = {
        kwota: kwota,
        typObligacji: typ,
        dynamicRate: dynamicRate * 100,
        okres: miesiace,
        oprocentowanie: config.oprocentowanie,
        ikeIkze: isIkeIkzeMode
    };

    if (kwota < 100 || miesiace <= 0) {
        alert("Proszę wypełnić wszystkie wymagane pola poprawnymi wartościami.");
        return;
    }

    let kapital = kwota;
    let odsetkiCalkowite = 0;
    let zyskNettoCalkowity = 0;
    let harmonogram = [];
    let skumulowaneOdsetki = 0;

    let liczbaCykli = ["OTS", "ROR", "DOR"].includes(typ) ? miesiace : miesiace / 12;

    for (let i = 1; i <= liczbaCykli; i++) {
        let oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (dynamicRate + (config.marza || 0) / 100);
        let oprocentowanieMiesieczne = oprocentowanieRoczne / 12;
        let miesiecyWCyklu = ["OTS", "ROR", "DOR"].includes(typ) ? 1 : 12;
        let odsetkiCykl = kapital * oprocentowanieMiesieczne * miesiecyWCyklu;

        let podatekCykl = odsetkiCykl * podatekBelki;
        let odsetkiNettoCykl = isIkeIkzeMode ? odsetkiCykl : (odsetkiCykl - podatekCykl);

        odsetkiCalkowite += odsetkiCykl;
        skumulowaneOdsetki += odsetkiCykl;
        zyskNettoCalkowity += odsetkiNettoCykl;

        let wartoscInwestycji = kwota;
        if (config.kapitalizacja) {
            kapital += odsetkiCykl;
            wartoscInwestycji = kapital;
        }

        let kwotaPoCyklu = isIkeIkzeMode ? (config.kapitalizacja ? wartoscInwestycji : kwota + zyskNettoCalkowity) : 
            (config.kapitalizacja ? (wartoscInwestycji - skumulowaneOdsetki * 0.19) : kwota + zyskNettoCalkowity);

        harmonogram.push({
            okres: i,
            wartoscInwestycji: wartoscInwestycji.toFixed(2),
            oprocentowanieNaCykl: (oprocentowanieRoczne * 100).toFixed(2) + "%",
            odsetkiBrutto: odsetkiCykl.toFixed(2),
            skumulowaneOdsetki: skumulowaneOdsetki.toFixed(2),
            podatek: podatekCykl.toFixed(2),
            zyskNetto: odsetkiNettoCykl.toFixed(2),
            oplataZaWykup: (i < liczbaCykli ? kwota * config.oplataWykup : 0).toFixed(2),
            stopaRefLubInflacja: isInflacja ? (dynamicRate * 100).toFixed(2) + "%" : "-",
            kwotaPoZakonczeniuCyklu: kwotaPoCyklu.toFixed(2)
        });
    }

    harmonogramData = harmonogram;

    document.getElementById("valueKapital").textContent = `${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
    document.getElementById("valueOdsetki").textContent = `${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
    const podatekCalkowity = odsetkiCalkowite * (isIkeIkzeMode ? 0 : 0.19);
    document.getElementById("valuePodatek").textContent = `${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
    document.getElementById("okresInwestycji").textContent = miesiace;
    document.getElementById("zyskNetto").textContent = `${zyskNettoCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2 })}`;

    // Reszta kodu generowania wykresów i tabeli pozostaje taka sama
    document.getElementById("formSection").style.display = "none";
    document.getElementById("resultSection").style.display = "block";
}

document.getElementById("obliczBtn").addEventListener("click", obliczObligacje);
</script>
<script>
document.getElementById("generatePdfBtn").addEventListener("click", function() {
    console.log("Przycisk Generuj PDF został kliknięty");

    if (!harmonogramData.length) {
        alert("Najpierw kliknij 'Oblicz', aby wygenerować dane.");
        return;
    }

    const typ = lastFormData.typObligacji;
    const nazwaObligacji = nazwyObligacji[typ];
    const headerText = `Wynik inwestycji dla obligacji ${nazwaObligacji}${isIkeIkzeMode ? " (IKE/IKZE)" : ""}`;
    const opis = opisyObligacji[typ].replace(/<[^>]+>/g, ""); // Usuwamy tagi HTML

    // Przygotowanie danych tabeli
    const headers = ["OTS", "ROR", "DOR"].includes(typ) ?
        ["Miesiąc", "Wartość inwestycji", "Oproc.", "Odsetki", "Suma odsetek", "Podatek", isIkeIkzeMode ? "Zysk" : "Zysk netto", "Opłata za wykup", "Stopa/Inflacja", "Suma netto"] :
        ["Rok", "Wartość inwestycji", "Oproc.", "Odsetki", "Suma odsetek", "Podatek", isIkeIkzeMode ? "Zysk" : "Zysk netto", "Opłata za wykup", "Inflacja", "Suma netto"];
    if (["OTS", "TOS"].includes(typ)) headers.splice(8, 1);

    const tableBody = harmonogramData.map(wiersz => {
        const row = [
            wiersz.okres,
            `${parseFloat(wiersz.wartoscInwestycji).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
            wiersz.oprocentowanieNaCykl,
            `${parseFloat(wiersz.odsetkiBrutto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
            `${parseFloat(wiersz.skumulowaneOdsetki).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
            isIkeIkzeMode ? "0,00 zł*" : `${parseFloat(wiersz.podatek).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
            `${parseFloat(wiersz.zyskNetto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
            `${parseFloat(wiersz.oplataZaWykup).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`
        ];
        if (!["OTS", "TOS"].includes(typ)) row.push(wiersz.stopaRefLubInflacja);
        row.push(`${parseFloat(wiersz.kwotaPoZakonczeniuCyklu).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`);
        return row;
    });

    // Definicja dokumentu PDFMake
    const docDefinition = {
        content: [
            { text: headerText, style: 'header', alignment: 'center' },
            { text: opis, style: 'subheader', margin: [0, 10, 0, 10] },
            { text: 'Podsumowanie:', style: 'subheader' },
            {
                ul: [
                    `Kapitał: ${lastFormData.kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                    `Odsetki: ${parseFloat(document.getElementById("valueOdsetki").textContent.replace(" zł", "").replace(/\s/g, "")).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                    `Podatek: ${parseFloat(document.getElementById("valuePodatek").textContent.replace(" zł", "").replace(/\s/g, "")).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                    `Okres inwestycji: ${lastFormData.okres} miesięcy`,
                    `Zysk netto: ${parseFloat(document.getElementById("zyskNetto").textContent.replace(/\s/g, "")).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`
                ],
                margin: [0, 0, 0, 10]
            },
            { text: 'Harmonogram odsetek:', style: 'subheader', margin: [0, 10, 0, 5] },
            {
                table: {
                    headerRows: 1,
                    widths: headers.map(() => 'auto'),
                    body: [headers, ...tableBody]
                }
            }
        ],
        styles: {
            header: { fontSize: 18, bold: true },
            subheader: { fontSize: 14, bold: true }
        },
        footer: function(currentPage, pageCount) {
            return { text: `Data: 01.03.2025r. | Strona ${currentPage} z ${pageCount}`, alignment: 'center', fontSize: 8 };
        }
    };

    // Dodanie wykresów jako obrazy
    const chartCanvas = document.getElementById("obligacjeChart");
    if (chartCanvas) {
        const chartImg = chartCanvas.toDataURL("image/png");
        docDefinition.content.splice(4, 0, { image: chartImg, width: 150, alignment: 'center', margin: [0, 10, 0, 10] });
    }

    const chartLineCanvas = document.getElementById("obligacjeChartLine");
    if (chartLineCanvas) {
        const chartLineImg = chartLineCanvas.toDataURL("image/png");
        docDefinition.content.push({ image: chartLineImg, width: 400, alignment: 'center', margin: [0, 10, 0, 10] });
    }

    // Generowanie i zapis PDF-a
    pdfMake.createPdf(docDefinition).download(`Wynik_inwestycji_${nazwaObligacji.replace(/\s/g, "_")}.pdf`);
    console.log("PDF został wygenerowany i zapisany.");
});
</script>
