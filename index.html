<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Obligacji Skarbu Państwa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #f5f6f5;
            font-family: 'Montserrat', sans-serif;
            padding: 10px;
        }
        .logo-container {
            background-color: #e9ecef;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        .logo {
            max-width: 200px;
            margin-bottom: 0;
            cursor: pointer;
        }
        .container {
            max-width: 1200px;
            margin: 30px auto 0;
            background: #FFFFFF;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .header-row {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
        }
        .header-row h4 {
            font-size: 1.2em;
            color: #333333;
            font-weight: 700;
            margin: 0;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            font-size: 0.8em;
            color: #333333;
            cursor: pointer;
        }
        .checkbox-label input {
            display: none;
        }
        .checkbox-custom {
            width: 16px;
            height: 16px;
            border: 2px solid #C2B280;
            background-color: #fff;
            margin-right: 5px;
            display: inline-block;
            position: relative;
        }
        .checkbox-label input:checked + .checkbox-custom {
            background-color: #C2B280;
        }
        .checkbox-label input:checked + .checkbox-custom::after {
            content: '✔';
            color: #000;
            font-size: 12px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .checkbox-label.header-checkbox {
            position: absolute;
            top: 0;
            right: 10px;
        }
        .form-section {
            padding: 10px;
            position: relative;
        }
        .form-row {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
            gap: 10px;
            align-items: flex-start;
        }
        .form-group {
            flex: 1;
            min-width: 0;
            max-width: 150px;
        }
        .form-label {
            font-size: 0.7em;
            text-transform: uppercase;
            margin-bottom: 2px;
            color: #333333;
        }
        .form-control, .form-select, .form-range {
            height: 22px;
            font-size: 0.7em;
            padding: 2px;
            text-align: center;
        }
        .form-select {
            max-width: 100px;
            appearance: none;
            background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAQ0lEQVR42mNgwAfKy8Q/Y//+Ii//3jVAYQzsIFyQ0dOaWq992zxcnN5+9NmyZACV40DmGhPZtzwUAxhUaoLntdha0DqQbtz4E9DzN6XgI0P2VYFlQrUwoQDIgbChLE/0awXiwV5rhugPX6A8BSsYFDqU+rEFdkGZA7+G9HMqaAU6l+0w+NdJD7ADhzhR/4KDZnWOw0QKrVqYc1G+1Dczfx8DR0uv+QJqDRvQxdizFAQAwsy39EZhAAAwAAJ4+Q1XFlAAAAABJRU5ErkJggg==') no-repeat right 5px center;
        }
        .form-range {
            margin-top: 2px;
            height: 8px;
            background: #d3d3d3;
            border-radius: 5px;
        }
        .form-range::-webkit-slider-thumb {
            background: #C2B280;
            border: none;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            cursor: pointer;
            -webkit-appearance: none;
        }
        .form-range::-moz-range-thumb {
            background: #C2B280;
            border: none;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            cursor: pointer;
        }
        .input-group-text {
            font-size: 0.7em;
            padding: 2px 5px;
        }
        .sub-info {
            font-size: 0.4em;
            color: #333333;
            margin-top: 2px;
            text-align: left;
        }
        .opis-container {
            margin-top: 20px;
            text-align: center;
            margin-bottom: 10px;
        }
        .obligacje-opis, .harmonogram-opis {
            font-size: 0.6em;
            color: #333333;
            text-align: center;
            max-width: 400px;
            margin: 10px auto 0;
            line-height: 1.4;
        }
        .data-container {
            text-align: right;
            margin-top: 5px;
        }
        .data-info {
            font-size: 0.8em;
            color: #C2B280;
        }
        .data-date {
            font-size: 0.8em;
        }
        .result-section {
            display: none;
            padding: 10px;
            max-width: 1200px;
            margin: 0 auto;
            background: #FFFFFF;
        }
        .result-header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        .result-header h4 {
            font-size: 1.2em;
            color: #333333;
            font-weight: 700;
            display: inline-block;
        }
        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: visible;
        }
        .chart {
            flex: 0 0 auto;
            width: 120px;
            height: 120px;
            position: relative;
            z-index: 25;
        }
        .chart-legend {
            flex: 0 0 auto;
            max-width: 200px;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .chart-legend .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.7em;
            color: #333333;
            cursor: pointer;
            transition: transform 0.3s ease;
            padding-left: 8px;
        }
        .chart-legend .color-box {
            width: 90px;
            height: 18px;
            border-radius: 5px;
            text-align: center;
            font-weight: 500;
            line-height: 18px;
            font-size: 0.8em;
            white-space: nowrap;
            overflow: hidden;
            position: relative;
            color: #fff;
            margin-right: 6px;
        }
        .chart-legend .color-box .value {
            display: block;
        }
        .chart-legend .color-box:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            color: #fff;
            font-size: 0.8em;
            line-height: 18px;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 30;
        }
        .chart-legend .color-box:hover .value {
            display: none;
        }
        .chart-legend .legend-text {
            opacity: 1;
            transition: opacity 0.3s ease;
            font-size: 0.7em;
        }
        .summary-footer {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }
        .summary-footer .highlight {
            font-size: 0.8em;
            padding: 4px 6px;
            border-radius: 5px;
            position: relative;
            cursor: pointer;
        }
        .highlight.yellow {
            background-color: #17a2b8;
            color: #ffffff;
        }
        .highlight.yellow:hover {
            color: transparent;
        }
        .highlight.yellow:hover::after {
            content: attr(data-hover);
            font-weight: bold;
            font-size: 1.1em;
            color: #ffffff;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .highlight.green {
            background-color: #28a745;
            color: #ffffff;
        }
        .highlight.green:hover {
            color: transparent;
        }
        .highlight.green:hover::after {
            content: attr(data-hover);
            font-weight: bold;
            font-size: 1.1em;
            color: #ffffff;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .harmonogram {
            margin-top: 20px;
            font-size: 0.8em;
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 10px;
        }
        .harmonogram table {
            margin: 0 auto;
            width: auto;
            max-width: 1000px;
            display: table;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            background: #f9f9f9;
        }
        .harmonogram th {
            background: linear-gradient(90deg, #C2B280, #b0a070);
            color: #000000;
            padding: 12px;
            text-align: center;
            vertical-align: middle;
            font-weight: 500;
            border-bottom: 2px solid #ddd;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .harmonogram td {
            padding: 10px;
            text-align: center;
            font-weight: 400;
            border-bottom: 1px solid #eee;
            background-color: #f9f9f9;
            color: #000000;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .btn-toggle {
            cursor: pointer;
            font-size: 0.8em;
            color: #007bff;
            text-decoration: underline;
            margin-bottom: 10px;
        }
        .btn-primary, .btn-secondary {
            background: linear-gradient(135deg, #C2B280, #b0a070);
            border: none;
            color: #000000;
            font-size: 0.9em;
            padding: 8px 20px;
            width: auto;
            margin: 25px auto 0;
            display: block;
            border-radius: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.3s ease;
        }
        .btn-primary:hover, .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, #b0a070, #C2B280);
            color: #000000;
        }
        .btn-sm {
            font-size: 0.7em;
            padding: 3px 10px;
        }
        #generatePdfBtn {
            position: absolute;
            top: 0;
            right: 10px;
        }
        #harmonogramContent {
            display: block;
        }
        .form-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            position: relative;
        }
        .form-wrapper {
            flex: 1;
            max-width: 400px;
        }
        .result-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            position: relative;
        }
        .harmonogram-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
            position: relative;
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 10px;
        }
        .result-wrapper-chart {
            flex: 1;
            max-width: 1000px;
        }
        .result-wrapper-harmonogram {
            flex: 1;
            max-width: 1000px;
        }
        .result-wrapper-chart h5, .result-wrapper-harmonogram h5 {
            font-size: 1em;
            text-align: center;
            margin-bottom: 10px;
            color: #333333;
        }
        .chart-container-line {
            margin-top: 20px;
            width: 100%;
            height: 400px;
        }
        .chart-line {
            width: 100%;
            height: 100%;
        }
        .variable-rate-container {
            margin-top: 15px;
            text-align: center;
        }
        .checkbox-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
        }
        .variable-inputs {
            margin-top: 10px;
        }
        .variable-input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            align-items: center;
        }
        .fields-wrapper {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .variable-input-group .form-group {
            max-width: 120px;
        }
        .remove-btn-wrapper {
            display: flex;
            justify-content: center;
            margin-top: 5px;
        }
        .variable-input-group .form-label {
            text-align: left !important;
            width: 100%;
            padding-left: 0;
        }
        .variable-input-group .input-group {
            justify-content: center;
        }
        .variable-input-group .btn-danger {
            font-size: 0.7em;
            padding: 2px 8px;
            height: 22px;
            line-height: 18px;
            background: #dc3545;
            border: none;
            border-radius: 5px;
            color: #fff;
        }
        .variable-input-group .btn-danger:hover {
            background: #c82333;
        }
        #addVariableBtn {
            background: linear-gradient(135deg, #C2B280, #b0a070);
            color: #000;
            font-size: 0.7em;
            padding: 3px 10px;
            border-radius: 15px;
            margin: 0 auto;
            display: block;
        }
        #addVariableBtn:hover {
            background: linear-gradient(135deg, #b0a070, #C2B280);
        }
    </style>
</head>
<body>
    <div class="logo-container">
        <a href="https://finance-brothers.pl">
            <img src="cropped-logo-FB-1.png" alt="Finance Brothers Logo" class="logo d-block mx-auto">
        </a>
    </div>
    <div class="container">
        <div class="form-section" id="formSection">
            <div class="header-row">
                <h4>Kalkulator Obligacji Skarbu Państwa</h4>
                <label class="checkbox-label header-checkbox" for="ikeIkzeBtn">
                    <input type="checkbox" id="ikeIkzeBtn">
                    <span class="checkbox-custom"></span>
                    Inwestycje w IKE lub IKZE
                </label>
            </div>
            <div class="form-container">
                <div class="form-wrapper">
                    <form id="obligacjeForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="kwota" class="form-label">Kwota inwestycji</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="kwota" min="100" max="5000000" step="100" value="10000">
                                    <span class="input-group-text">zł</span>
                                </div>
                                <input type="range" class="form-range" id="kwotaRange" min="100" max="5000000" step="100" value="10000">
                                <div class="sub-info" id="iloscObligacji">Ilość obligacji: 100</div>
                            </div>
                            <div class="form-group">
                                <label for="typObligacji" class="form-label">Typ obligacji*</label>
                                <select class="form-control" id="typObligacji">
                                    <option value="OTS" selected>3-miesięczne (OTS)</option>
                                    <option value="ROR">12-miesięczne (ROR)</option>
                                    <option value="DOR">24-miesięczne (DOR)</option>
                                    <option value="TOS">3-letnie (TOS)</option>
                                    <option value="COI">4-letnie (COI)</option>
                                    <option value="EDO">10-letnie (EDO)</option>
                                    <option value="ROS">6-letnie (ROS)</option>
                                    <option value="ROD">12-letnie (ROD)</option>
                                </select>
                                <div class="sub-info"></div>
                            </div>
                            <div class="form-group" id="dynamicRateGroup" style="display: none;">
                                <label for="dynamicRate" class="form-label" id="dynamicRateLabel">Stopa Ref. NBP</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="dynamicRate" min="0" max="50" step="0.05" value="4.90">
                                    <span class="input-group-text">%</span>
                                </div>
                                <input type="range" class="form-range" id="dynamicRateRange" min="0" max="50" step="0.05" value="4.90">
                                <div class="sub-info"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="okres" class="form-label">Okres inwestycji</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="okres" min="3" max="144" step="1" value="3" readonly>
                                    <span class="input-group-text">mc-y</span>
                                </div>
                                <div class="sub-info" id="lata"></div>
                            </div>
                            <div class="form-group">
                                <label for="oprocentowanie" class="form-label">Oprocentowanie</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="oprocentowanie" min="0.1" max="25" step="0.1" value="3" readonly>
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="sub-info" id="oprocentowanieInfo"></div>
                            </div>
                        </div>
                        <div class="variable-rate-container">
                            <div class="checkbox-row" id="variableCheckboxRow">
                                <label class="checkbox-label" id="inflacjaZmiennaLabel" for="inflacjaZmiennaBtn" style="display: none;">
                                    <input type="checkbox" id="inflacjaZmiennaBtn">
                                    <span class="checkbox-custom"></span>
                                    Inflacja zmienna
                                </label>
                                <label class="checkbox-label" id="stopaZmiennaLabel" for="stopaZmiennaBtn" style="display: none;">
                                    <input type="checkbox" id="stopaZmiennaBtn">
                                    <span class="checkbox-custom"></span>
                                    Zmienna Stopa Ref. NBP
                                </label>
                            </div>
                            <div class="variable-inputs" id="variableInputs" style="display: none;">
                                <div class="variable-inputs-wrapper" id="variableInputsWrapper"></div>
                                <button type="button" class="btn btn-secondary btn-sm" id="addVariableBtn" style="display: none;" aria-label="Dodaj kolejne zmienne oprocentowanie">Dodaj kolejne</button>
                            </div>
                        </div>
                        <div class="form-row">
                            <button type="button" class="btn btn-primary" id="obliczBtn" style="margin: 25px auto 0;" aria-label="Oblicz wyniki inwestycji">Oblicz</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="opis-container">
                <div class="obligacje-opis" id="obligacjeOpis"></div>
            </div>
            <div class="data-container">
                <div class="data-info"><strong>Dane z dnia:</strong> <span class="data-date"><strong>01.03.2025r.</strong></span></div>
            </div>
        </div>
        <div class="result-section" id="resultSection">
            <div class="result-header">
                <h4 id="resultHeader">Podsumowanie wyników</h4>
                <button id="generatePdfBtn" class="btn btn-primary btn-sm" aria-label="Generuj PDF z wynikami">Generuj PDF</button>
            </div>
            <button class="btn btn-secondary mb-3" onclick="showForm()" aria-label="Powrót do edycji formularza">Powrót do edycji</button>
            <div class="result-container">
                <div class="result-wrapper-chart">
                    <div class="chart-container">
                        <div class="chart">
                            <canvas id="obligacjeChart" aria-label="Wykres kołowy wyników inwestycji"></canvas>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item" data-index="0">
                                <div class="color-box" style="background-color: #28a745;" data-tooltip="">
                                    <span class="value" id="valueKapital">-</span>
                                </div>
                                <span class="legend-text" id="legendKapital">Kapitał</span>
                            </div>
                            <div class="legend-item" data-index="1">
                                <div class="color-box" style="background-color: #007bff;" data-tooltip="">
                                    <span class="value" id="valueOdsetki">-</span>
                                </div>
                                <span class="legend-text" id="legendOdsetki">Odsetki</span>
                            </div>
                            <div class="legend-item" data-index="2">
                                <div class="color-box" style="background-color: #dc3545;" data-tooltip="">
                                    <span class="value" id="valuePodatek">-</span>
                                </div>
                                <span class="legend-text" id="legendPodatek">Podatek</span>
                            </div>
                        </div>
                    </div>
                    <div class="summary-footer">
                        <span class="highlight yellow" data-hover="3 miesięcy">Okres inwestycji: <span id="okresInwestycji">-</span> mc-y</span>
                        <span class="highlight green" data-hover="">Zysk netto: <span id="zyskNetto">-</span> zł</span>
                    </div>
                    <div class="obligacje-opis" id="obligacjeOpisPodsumowanie"></div>
                </div>
            </div>
            <div class="harmonogram-container">
                <div class="result-wrapper-harmonogram">
                    <div class="harmonogram">
                        <h5 class="btn-toggle" onclick="toggleHarmonogram('harmonogramContent')" aria-label="Przełącz widoczność harmonogramu odsetek">Harmonogram odsetek ▼</h5>
                        <div id="harmonogramContent">
                            <table class="table table-striped">
                                <thead id="harmonogramNaglowek">
                                    <tr>
                                        <th id="pierwszaKolumnaNaglowek">Rok</th>
                                        <th>Wartość inwestycji</th>
                                        <th>Oproc.</th>
                                        <th>Odsetki</th>
                                        <th>Suma odsetek</th>
                                        <th>Podatek</th>
                                        <th id="zyskKolumnaNaglowek">Zysk netto</th>
                                        <th>Opłata za wykup</th>
                                        <th id="kolumnaStopaInflacja">Inflacja</th>
                                        <th>Suma netto</th>
                                    </tr>
                                </thead>
                                <tbody id="harmonogramTabela"></tbody>
                            </table>
                            <div class="harmonogram-opis" id="harmonogramOpis"></div>
                        </div>
                    </div>
                    <div class="chart-container-line">
                        <div class="chart-line">
                            <canvas id="obligacjeChartLine" aria-label="Wykres liniowy wartości inwestycji w czasie"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Skrypty JavaScript w osobnych plikach -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="scripts.js"></script>
    <script src="pdfGenerator.js"></script>
</body>
</html>
<script>
// Przechowywanie elementów DOM
const elements = {
    formSection: document.getElementById("formSection"),
    resultSection: document.getElementById("resultSection"),
    kwota: document.getElementById("kwota"),
    kwotaRange: document.getElementById("kwotaRange"),
    typObligacji: document.getElementById("typObligacji"),
    dynamicRate: document.getElementById("dynamicRate"),
    dynamicRateRange: document.getElementById("dynamicRateRange"),
    okres: document.getElementById("okres"),
    oprocentowanie: document.getElementById("oprocentowanie"),
    ikeIkzeBtn: document.getElementById("ikeIkzeBtn"),
    inflacjaZmiennaBtn: document.getElementById("inflacjaZmiennaBtn"),
    stopaZmiennaBtn: document.getElementById("stopaZmiennaBtn"),
    obliczBtn: document.getElementById("obliczBtn"),
    addVariableBtn: document.getElementById("addVariableBtn"),
    resultHeader: document.getElementById("resultHeader"),
    obligacjeChart: document.getElementById("obligacjeChart"),
    obligacjeChartLine: document.getElementById("obligacjeChartLine"),
    generatePdfBtn: document.getElementById("generatePdfBtn")
};

// Stan aplikacji
const state = {
    chart: null,
    chartLine: null,
    harmonogramData: [],
    isIkeIkzeMode: false,
    variableInflacjaChanges: [],
    variableStopaChanges: [],
    lastFormData: {
        kwota: 10000,
        typObligacji: "OTS",
        dynamicRate: 5.75,
        okres: 3,
        oprocentowanie: 3,
        ikeIkze: false,
        isInflacja: false,
        inflacjaZmienna: false,
        stopaZmienna: false,
        variableInflacjaChanges: [],
        variableStopaChanges: []
    },
    isCalculating: false
};

const maxVariableChanges = {
    "ROR": 11,
    "DOR": 23,
    "COI": 3,
    "EDO": 9,
    "ROS": 5,
    "ROD": 11
};

const obligacjeConfig = {
    "OTS": { okres: 3, oprocentowanie: 3.00, zmienne: false, kapitalizacja: false, oplataWykup: 0.00 },
    "ROR": { okres: 12, oprocentowanie: 5.75, zmienne: true, marza: 0.00, kapitalizacja: false, oplataWykup: 0.005 },
    "DOR": { okres: 24, oprocentowanie: 5.90, zmienne: true, marza: 0.15, kapitalizacja: false, oplataWykup: 0.007 },
    "TOS": { okres: 36, oprocentowanie: 5.95, zmienne: false, kapitalizacja: true, oplataWykup: 0.01 },
    "COI": { okres: 48, oprocentowanie: 6.30, zmienne: true, marza: 1.50, indeksowaneInflacja: true, kapitalizacja: false, oplataWykup: 0.02 },
    "EDO": { okres: 120, oprocentowanie: 6.55, zmienne: true, marza: 2.00, indeksowaneInflacja: true, kapitalizacja: true, oplataWykup: 0.03 },
    "ROS": { okres: 72, oprocentowanie: 6.50, zmienne: true, marza: 2.00, indeksowaneInflacja: true, kapitalizacja: true, oplataWykup: 0.02 },
    "ROD": { okres: 144, oprocentowanie: 6.80, zmienne: true, marza: 2.50, indeksowaneInflacja: true, kapitalizacja: true, oplataWykup: 0.03 }
};

const opisyObligacji = {
    "OTS": "* OTS (3-miesięczne): stałe oprocentowanie 3,00% na okres 3-miesięcy, wypłata odsetek nastąpi przy wykupie obligacji. Wcześniejszy odkup powoduje nienaliczenie odsetek, natomiast nie ma opłat za wcześniejszy odkup. Obligacje OTS są idealne dla krótkoterminowych inwestycji.",
    "ROR": "* ROR (12-miesięczne): oprocentowanie zmienne, w pierwszym miesiącu 5,75%, w pozostałych 11 miesiącach oprocentowanie oparte na stopie referencyjnej NBP + 0%. Wypłata odsetek następuje co miesiąc, jest możliwość wcześniejszego odkupu, niestety wiąże się to z opłatą w wysokości 0,5% wartości obligacji (0,5 zł za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Obligacje ROR przeznaczone są dla krótko i średnioterminowych inwestorów.",
    "DOR": "* DOR (24-miesięczne): oprocentowanie zmienne, 5,90% w pierwszym miesiącu, w pozostałych 23 miesiącach oprocentowanie oparte na stopie referencyjnej NBP + 0,15%. Wypłata odsetek następuje co miesiąc, jest możliwość wcześniejszego odkupu, niestety wiąże się to z opłatą w wysokości 0,7% wartości obligacji (0,7 zł za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Obligacje DOR przeznaczone są dla średnioterminowych inwestorów.",
    "TOS": "* TOS (3-letnie): stałe oprocentowanie 5,95% na okres 3-lat, wypłata odsetek nastąpi przy wykupie obligacji po 3 latach inwestycji. Wcześniejszy odkup wiąże się z opłatą w wysokości 1% wartości obligacji (1 zł za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Roczna kapitalizacja odsetek zwiększa efektywności inwestycji. Obligacje TOS przeznaczone dla stabilnych średnioterminowych inwestycji.",
    "COI": "* COI (4-letnie): obligacje indeksowane inflacją, 6,30% w pierwszym roku, w kolejnych 3 latach oprocentowanie wynosi wartość inflacji + 1,50%. Wypłata odsetek następuje po każdym roku inwestycji, jest możliwość wcześniejszego odkupu, niestety wiąże się to z opłatą w wysokości 2% wartości obligacji (2 zł za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Obligacje COI są idealne dla średnio i długoterminowych inwestycji oraz dla ochrony przed wzrostem inflacji.",
    "EDO": "* EDO (10-letnie): obligacje indeksowane inflacją, 6,55% w pierwszym roku, w kolejnych 9 latach oprocentowanie wynosi wartość inflacji + 2,00%. Wypłata odsetek następuje przy wykupie obligacji po 10 latach inwestycji. Wcześniejszy odkup niestety wiąże się z opłatą w wysokości 3% wartości obligacji (3 zł za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Roczna kapitalizacja odsetek zwiększa efektywności inwestycji. Obligacje EDO są idealne dla długoterminowych inwestycji oraz dla ochrony przed wzrostem inflacji.",
    "ROS": "* ROS (6-letnie): rodzinne obligacje przeznaczone są wyłącznie dla beneficjentów programu 800+. Obligacje indeksowane inflacją, 6,50% w pierwszym roku, w kolejnych 5 latach oprocentowanie wynosi wartość inflacji + 2,00%. Wypłata odsetek następuje przy wykupie obligacji po 6 latach inwestycji. Wcześniejszy odkup niestety wiąże się z opłatą w wysokości 2% wartości obligacji (2 zł za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Roczna kapitalizacja odsetek zwiększa efektywności inwestycji. Obligacje ROS są idealne dla rodzinnych inwestycji oraz dla ochrony przed wzrostem inflacji.",
    "ROD": "* ROD (12-letnie): rodzinne obligacje przeznaczone są wyłącznie dla beneficjentów programu 800+. Obligacje indeksowane inflacją, 6,80% w pierwszym roku, w kolejnych 11 latach oprocentowanie wynosi wartość inflacji + 2,50%. Wypłata odsetek następuje przy wykupie obligacji po 12 latach inwestycji. Wcześniejszy odkup niestety wiąże się z opłatą w wysokości 3% wartości obligacji (3 zł za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Roczna kapitalizacja odsetek zwiększa efektywności inwestycji. Obligacje ROD są idealne dla długoterminowych rodzinnych inwestycji oraz dla ochrony przed wzrostem inflacji."
};

const nazwyObligacji = {
    "OTS": "3-miesięcznych (OTS)", "ROR": "12-miesięcznych (ROR)", "DOR": "24-miesięcznych (DOR)", "TOS": "3-letnich (TOS)",
    "COI": "4-letnich (COI)", "EDO": "10-letnich (EDO)", "ROS": "6-letnich (ROS)", "ROD": "12-letnich (ROD)"
};

// Event Listeners
elements.dynamicRateRange.addEventListener("input", () => elements.dynamicRate.value = elements.dynamicRateRange.value);
elements.dynamicRate.addEventListener("input", () => elements.dynamicRateRange.value = elements.dynamicRate.value);
elements.kwotaRange.addEventListener("input", () => { elements.kwota.value = elements.kwotaRange.value; updateIloscObligacji(); });
elements.kwota.addEventListener("input", () => { elements.kwotaRange.value = elements.kwota.value; updateIloscObligacji(); });
elements.typObligacji.addEventListener("change", updateDynamicRateField);
elements.ikeIkzeBtn.addEventListener("change", updateDynamicRateField);
elements.inflacjaZmiennaBtn.addEventListener("change", () => { state.lastFormData.inflacjaZmienna = elements.inflacjaZmiennaBtn.checked; updateVariableInputs(); });
elements.stopaZmiennaBtn.addEventListener("change", () => { state.lastFormData.stopaZmienna = elements.stopaZmiennaBtn.checked; updateVariableInputs(); });
elements.obliczBtn.addEventListener("click", obliczObligacje);
elements.addVariableBtn.addEventListener("click", addVariableChange);
elements.generatePdfBtn.addEventListener("click", generatePdf); // Funkcja zdefiniowana w pdfGenerator.js

// Funkcje pomocnicze
function setDynamicRateField(label, value, step, max) {
    const dynamicRateLabel = document.getElementById("dynamicRateLabel");
    dynamicRateLabel.textContent = label;
    elements.dynamicRate.value = value;
    elements.dynamicRateRange.value = value;
    elements.dynamicRate.step = step;
    elements.dynamicRateRange.step = step;
    elements.dynamicRate.max = max;
    elements.dynamicRateRange.max = max;
    document.getElementById("dynamicRateGroup").style.display = "block";
}

function updateDynamicRateField() {
    state.isIkeIkzeMode = elements.ikeIkzeBtn.checked;
    const select = elements.typObligacji;
    const previousTyp = select.value;

    select.innerHTML = state.isIkeIkzeMode ? `
        <option value="ROR">12-miesięczne (ROR)</option>
        <option value="DOR">24-miesięczne (DOR)</option>
        <option value="TOS" selected>3-letnie (TOS)</option>
        <option value="COI">4-letnie (COI)</option>
        <option value="EDO">10-letnie (EDO)</option>
    ` : `
        <option value="OTS" selected>3-miesięczne (OTS)</option>
        <option value="ROR">12-miesięczne (ROR)</option>
        <option value="DOR">24-miesięczne (DOR)</option>
        <option value="TOS">3-letnie (TOS)</option>
        <option value="COI">4-letnie (COI)</option>
        <option value="EDO">10-letnie (EDO)</option>
        <option value="ROS">6-letnie (ROS)</option>
        <option value="ROD">12-letnie (ROD)</option>
    `;

    const availableOptions = Array.from(select.options).map(opt => opt.value);
    select.value = availableOptions.includes(previousTyp) ? previousTyp : (state.isIkeIkzeMode ? "TOS" : "OTS");

    const typ = select.value;
    const config = obligacjeConfig[typ];

    elements.okres.value = config.okres;
    elements.oprocentowanie.value = config.oprocentowanie;
    updateLata();
    updateOprocentowanieInfo();
    updateOpisObligacji();

    if (["COI", "EDO", "ROS", "ROD"].includes(typ)) {
        setDynamicRateField("Inflacja", state.lastFormData.isInflacja ? (state.lastFormData.dynamicRate || 4.90) : 4.90, "0.1", "50");
        state.lastFormData.isInflacja = true;
    } else if (["ROR", "DOR"].includes(typ)) {
        setDynamicRateField("Stopa Ref. NBP", state.lastFormData.isInflacja ? 5.75 : (state.lastFormData.dynamicRate || 5.75), "0.05", "20");
        state.lastFormData.isInflacja = false;
    } else {
        document.getElementById("dynamicRateGroup").style.display = "none";
        state.lastFormData.isInflacja = false;
    }

    document.getElementById("inflacjaZmiennaLabel").style.display = ["COI", "EDO", "ROS", "ROD"].includes(typ) ? "flex" : "none";
    document.getElementById("stopaZmiennaLabel").style.display = ["ROR", "DOR"].includes(typ) ? "flex" : "none";

    elements.inflacjaZmiennaBtn.checked = state.lastFormData.inflacjaZmienna || false;
    elements.stopaZmiennaBtn.checked = state.lastFormData.stopaZmienna || false;
    state.variableInflacjaChanges = state.lastFormData.variableInflacjaChanges ? [...state.lastFormData.variableInflacjaChanges] : [];
    state.variableStopaChanges = state.lastFormData.variableStopaChanges ? [...state.lastFormData.variableStopaChanges] : [];
    updateVariableInputs();
}

function updateIloscObligacji() {
    const kwota = parseFloat(elements.kwota.value) || 0;
    const ilosc = Math.floor(kwota / 100);
    document.getElementById("iloscObligacji").textContent = `Ilość obligacji: ${ilosc}`;
}

function updateLata() {
    const miesiace = parseInt(elements.okres.value) || 0;
    const lata = (miesiace / 12).toFixed(0);
    document.getElementById("lata").textContent = `Ilość lat: ${miesiace >= 12 ? lata : 0}`;
}

function updateOprocentowanieInfo() {
    const typ = elements.typObligacji.value;
    const config = obligacjeConfig[typ];
    let info = config.zmienne ? 
        (config.indeksowaneInflacja ? 
            `Pierwszy rok: ${config.oprocentowanie}%, kolejne: inflacja + ${config.marza}%` : 
            `Pierwszy miesiąc: ${config.oprocentowanie}%, kolejne: stopa NBP + ${config.marza}%`) : 
        `Stałe: ${config.oprocentowanie}%`;
    document.getElementById("oprocentowanieInfo").textContent = info;
}

function updateOpisObligacji() {
    const typ = elements.typObligacji.value;
    const opis = opisyObligacji[typ] || "";
    document.getElementById("obligacjeOpis").innerHTML = opis;
    document.getElementById("obligacjeOpisPodsumowanie").innerHTML = opis;
}

function toggleHarmonogram(sectionId) {
    const content = document.getElementById(sectionId);
    const toggleBtn = content.previousElementSibling;
    content.style.display = content.style.display === "none" ? "block" : "none";
    toggleBtn.textContent = content.style.display === "none" ? "Harmonogram odsetek ►" : "Harmonogram odsetek ▼";
}

function showForm() {
    elements.formSection.style.display = "block";
    elements.resultSection.style.display = "none";

    elements.kwota.value = state.lastFormData.kwota;
    elements.kwotaRange.value = state.lastFormData.kwota;
    elements.dynamicRate.value = state.lastFormData.dynamicRate;
    elements.dynamicRateRange.value = state.lastFormData.dynamicRate;
    elements.okres.value = state.lastFormData.okres;
    elements.oprocentowanie.value = state.lastFormData.oprocentowanie;
    elements.ikeIkzeBtn.checked = state.lastFormData.ikeIkze;
    state.isIkeIkzeMode = state.lastFormData.ikeIkze;
    elements.typObligacji.value = state.lastFormData.typObligacji;
    elements.inflacjaZmiennaBtn.checked = state.lastFormData.inflacjaZmienna || false;
    elements.stopaZmiennaBtn.checked = state.lastFormData.stopaZmienna || false;
    state.variableInflacjaChanges = state.lastFormData.variableInflacjaChanges ? [...state.lastFormData.variableInflacjaChanges] : [];
    state.variableStopaChanges = state.lastFormData.variableStopaChanges ? [...state.lastFormData.variableStopaChanges] : [];

    updateDynamicRateField();
    updateIloscObligacji();
    updateLata();
    updateOprocentowanieInfo();
    updateOpisObligacji();
}

function updateVariableInputs() {
    const typ = elements.typObligacji.value;
    const isInflacjaZmienna = elements.inflacjaZmiennaBtn.checked && ["COI", "EDO", "ROS", "ROD"].includes(typ);
    const isStopaZmienna = elements.stopaZmiennaBtn.checked && ["ROR", "DOR"].includes(typ);
    const variableInputs = document.getElementById("variableInputs");
    const addVariableBtn = elements.addVariableBtn;
    const wrapper = document.getElementById("variableInputsWrapper");
    const config = obligacjeConfig[typ];
    const maxCykl = ["ROR", "DOR"].includes(typ) ? config.okres : config.okres / 12;

    if (isInflacjaZmienna || isStopaZmienna) {
        variableInputs.style.display = "block";
        addVariableBtn.style.display = "block";

        if ((isInflacjaZmienna && state.variableInflacjaChanges.length === 0) || (isStopaZmienna && state.variableStopaChanges.length === 0)) {
            addVariableChange();
        }

        wrapper.innerHTML = "";
        const changes = isInflacjaZmienna ? state.variableInflacjaChanges : state.variableStopaChanges;

        changes.forEach((change, index) => {
            const inputGroup = document.createElement("div");
            inputGroup.className = "variable-input-group";

            const fieldsWrapper = document.createElement("div");
            fieldsWrapper.className = "fields-wrapper";

            const cyklGroup = document.createElement("div");
            cyklGroup.className = "form-group";
            cyklGroup.innerHTML = `
                <label class="form-label">Od ${["ROR", "DOR"].includes(typ) ? "miesiąca" : "roku"}</label>
                <div class="input-group">
                    <input type="number" class="form-control variable-cykl" min="1" max="${maxCykl}" step="1" value="${change.cykl}">
                    <span class="input-group-text">${["ROR", "DOR"].includes(typ) ? "mc" : "rok"}</span>
                </div>
                <input type="range" class="form-range variable-cykl-range" min="1" max="${maxCykl}" step="1" value="${change.cykl}">
            `;

            const rateGroup = document.createElement("div");
            rateGroup.className = "form-group";
            rateGroup.innerHTML = `
                <label class="form-label">${isInflacjaZmienna ? "Inflacja" : "Stopa NBP"}</label>
                <div class="input-group">
                    <input type="number" class="form-control variable-rate" min="0" max="${isInflacjaZmienna ? 50 : 20}" step="${isInflacjaZmienna ? 0.1 : 0.05}" value="${change.wartosc}">
                    <span class="input-group-text">%</span>
                </div>
                <input type="range" class="form-range variable-rate-range" min="0" max="${isInflacjaZmienna ? 50 : 20}" step="${isInflacjaZmienna ? 0.1 : 0.05}" value="${change.wartosc}">
            `;

            fieldsWrapper.appendChild(cyklGroup);
            fieldsWrapper.appendChild(rateGroup);
            inputGroup.appendChild(fieldsWrapper);

            if (index === changes.length - 1 && changes.length > 1) {
                const removeBtnWrapper = document.createElement("div");
                removeBtnWrapper.className = "remove-btn-wrapper";
                const removeBtn = document.createElement("button");
                removeBtn.className = "btn btn-danger btn-sm";
                removeBtn.textContent = "Usuń";
                removeBtn.onclick = () => removeVariableChange();
                removeBtnWrapper.appendChild(removeBtn);
                inputGroup.appendChild(removeBtnWrapper);
            }

            wrapper.appendChild(inputGroup);

            const cyklInput = inputGroup.querySelector(".variable-cykl");
            const cyklRange = inputGroup.querySelector(".variable-cykl-range");
            const rateInput = inputGroup.querySelector(".variable-rate");
            const rateRange = inputGroup.querySelector(".variable-rate-range");

            cyklInput.addEventListener("input", () => {
                let value = parseInt(cyklInput.value);
                if (value < 1 || value > maxCykl) cyklInput.value = Math.max(1, Math.min(maxCykl, value));
                cyklRange.value = cyklInput.value;
                changes[index].cykl = parseInt(cyklInput.value);
            });
            cyklRange.addEventListener("input", () => {
                cyklInput.value = cyklRange.value;
                changes[index].cykl = parseInt(cyklRange.value);
            });
            rateInput.addEventListener("input", () => {
                let value = parseFloat(rateInput.value);
                if (value < 0 || value > (isInflacjaZmienna ? 50 : 20)) rateInput.value = Math.max(0, Math.min(isInflacjaZmienna ? 50 : 20, value));
                rateRange.value = rateInput.value;
                changes[index].wartosc = parseFloat(rateInput.value);
            });
            rateRange.addEventListener("input", () => {
                rateInput.value = rateRange.value;
                changes[index].wartosc = parseFloat(rateInput.value);
            });
        });

        const maxChanges = maxVariableChanges[typ] || 0;
        addVariableBtn.style.display = changes.length < maxChanges ? "block" : "none";
    } else {
        variableInputs.style.display = "none";
        addVariableBtn.style.display = "none";
        wrapper.innerHTML = "";
    }
}

function addVariableChange() {
    const typ = elements.typObligacji.value;
    const isInflacjaZmienna = elements.inflacjaZmiennaBtn.checked && ["COI", "EDO", "ROS", "ROD"].includes(typ);
    const changes = isInflacjaZmienna ? state.variableInflacjaChanges : state.variableStopaChanges;
    const maxCykl = ["ROR", "DOR"].includes(typ) ? obligacjeConfig[typ].okres : obligacjeConfig[typ].okres / 12;
    const maxChanges = maxVariableChanges[typ] || 0;

    if (changes.length >= maxChanges) {
        alert(`Osiągnięto maksymalną liczbę zmian dla obligacji ${typ} (${maxChanges}).`);
        return;
    }

    const lastCykl = changes.length > 0 ? changes[changes.length - 1].cykl : 1;
    const newCykl = Math.min(lastCykl + 1, maxCykl);
    changes.push({ cykl: newCykl, wartosc: isInflacjaZmienna ? 4.90 : 5.75 });
    updateVariableInputs();
}

function removeVariableChange() {
    const typ = elements.typObligacji.value;
    const isInflacjaZmienna = elements.inflacjaZmiennaBtn.checked && ["COI", "EDO", "ROS", "ROD"].includes(typ);
    const changes = isInflacjaZmienna ? state.variableInflacjaChanges : state.variableStopaChanges;
    if (changes.length > 1) {
        changes.pop();
        updateVariableInputs();
    }
}

function obliczObligacje() {
    if (state.isCalculating) return;
    state.isCalculating = true;

    if (typeof Chart === "undefined") {
        console.error("Biblioteka Chart.js nie została załadowana.");
        alert("Błąd: Nie można załadować wykresów. Spróbuj ponownie później.");
        state.isCalculating = false;
        return;
    }

    const kwota = parseFloat(elements.kwota.value) || 0;
    const typ = elements.typObligacji.value;
    const config = obligacjeConfig[typ];
    const miesiace = config.okres;
    const dynamicRate = parseFloat(elements.dynamicRate.value) / 100 || (["COI", "EDO", "ROS", "ROD"].includes(typ) ? 0.0490 : 0.0575);
    const isInflacja = ["COI", "EDO", "ROS", "ROD"].includes(typ);
    const inflacjaZmienna = elements.inflacjaZmiennaBtn.checked && ["COI", "EDO", "ROS", "ROD"].includes(typ);
    const stopaZmienna = elements.stopaZmiennaBtn.checked && ["ROR", "DOR"].includes(typ);
    const inflacja = isInflacja ? dynamicRate : 0;
    const stopaRel = !isInflacja ? dynamicRate : 0.0575;
    const podatekBelki = state.isIkeIkzeMode ? 0 : 0.19;

    state.lastFormData = {
        kwota: kwota,
        typObligacji: typ,
        dynamicRate: dynamicRate * 100,
        okres: miesiace,
        oprocentowanie: config.oprocentowanie,
        ikeIkze: state.isIkeIkzeMode,
        isInflacja: isInflacja,
        inflacjaZmienna: inflacjaZmienna,
        stopaZmienna: stopaZmienna,
        variableInflacjaChanges: [...state.variableInflacjaChanges],
        variableStopaChanges: [...state.variableStopaChanges]
    };

    if (kwota < 100 || miesiace <= 0) {
        alert("Proszę wypełnić wszystkie wymagane pola poprawnymi wartościami.");
        state.isCalculating = false;
        return;
    }

    elements.resultHeader.textContent = `Wynik inwestycji dla obligacji ${nazwyObligacji[typ]}${state.isIkeIkzeMode ? " (IKE/IKZE)" : ""}`;
    const pierwszaKolumnaNaglowek = document.getElementById("pierwszaKolumnaNaglowek");
    const kolumnaStopaInflacja = document.getElementById("kolumnaStopaInflacja");
    const zyskKolumnaNaglowek = document.getElementById("zyskKolumnaNaglowek");

    if (["OTS", "ROR", "DOR"].includes(typ)) {
        pierwszaKolumnaNaglowek.textContent = "Miesiąc";
        kolumnaStopaInflacja.textContent = ["ROR", "DOR"].includes(typ) ? "Stopa Ref. NBP" : "Inflacja";
        kolumnaStopaInflacja.style.display = ["OTS"].includes(typ) ? "none" : "table-cell";
    } else {
        pierwszaKolumnaNaglowek.textContent = "Rok";
        kolumnaStopaInflacja.textContent = "Inflacja";
        kolumnaStopaInflacja.style.display = ["TOS"].includes(typ) ? "none" : "table-cell";
    }
    zyskKolumnaNaglowek.textContent = state.isIkeIkzeMode ? "Zysk" : "Zysk netto";

    let kapital = kwota;
    let odsetkiCalkowite = 0;
    let zyskNettoCalkowity = 0;
    state.harmonogramData = [];
    let skumulowaneOdsetki = 0;

    let liczbaCykli = ["OTS", "ROR", "DOR"].includes(typ) ? miesiace : miesiace / 12;
    let changes = inflacjaZmienna ? state.variableInflacjaChanges : (stopaZmienna ? state.variableStopaChanges : []);
    changes.sort((a, b) => a.cykl - b.cykl);

    for (let i = 1; i <= liczbaCykli; i++) {
        let okresWiersz = i;
        let changeApplied = false;
        let stopaRefLubInflacja = "-";

        let oprocentowanieRoczne;
        if (inflacjaZmienna || stopaZmienna) {
            let dynamicValue = (inflacjaZmienna ? 4.90 : 5.75) / 100;
            for (const change of changes) {
                if (i >= change.cykl) {
                    dynamicValue = change.wartosc / 100;
                    if (i === change.cykl) changeApplied = true;
                }
            }
            oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (dynamicValue + config.marza / 100);
            stopaRefLubInflacja = (dynamicValue * 100).toFixed(2) + "%";
        } else if (["COI", "EDO", "ROS", "ROD"].includes(typ)) {
            oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (inflacja + config.marza / 100);
            stopaRefLubInflacja = (inflacja * 100).toFixed(2) + "%";
        } else if (["ROR", "DOR"].includes(typ)) {
            oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (stopaRel + config.marza / 100);
            stopaRefLubInflacja = (stopaRel * 100).toFixed(2) + "%";
        } else {
            oprocentowanieRoczne = config.oprocentowanie / 100;
        }

        let oprocentowanieMiesieczne = oprocentowanieRoczne / 12;
        let miesiecyWCyklu = ["OTS", "ROR", "DOR"].includes(typ) ? 1 : 12;
        let odsetkiCykl = kapital * oprocentowanieMiesieczne * miesiecyWCyklu;

        let podatekCykl = odsetkiCykl * podatekBelki;
        let odsetkiNettoCykl = state.isIkeIkzeMode ? odsetkiCykl : (odsetkiCykl - podatekCykl);

        odsetkiCalkowite += odsetkiCykl;
        skumulowaneOdsetki += odsetkiCykl;
        zyskNettoCalkowity += odsetkiNettoCykl;

        let wartoscInwestycji = kwota;
        if (config.kapitalizacja) {
            kapital += odsetkiCykl;
            wartoscInwestycji = kapital;
        }

        let kwotaPoCyklu = state.isIkeIkzeMode ? (config.kapitalizacja ? wartoscInwestycji : kwota + zyskNettoCalkowity) : 
            (config.kapitalizacja ? (wartoscInwestycji - skumulowaneOdsetki * 0.19) : kwota + zyskNettoCalkowity);

        let oplataZaWykup = i < liczbaCykli ? kwota * config.oplataWykup : 0;

        state.harmonogramData.push({
            okres: okresWiersz,
            wartoscInwestycji: wartoscInwestycji.toFixed(2),
            oprocentowanieNaCykl: (oprocentowanieRoczne * 100).toFixed(2) + "%",
            odsetkiBrutto: odsetkiCykl.toFixed(2),
            skumulowaneOdsetki: skumulowaneOdsetki.toFixed(2),
            podatek: podatekCykl.toFixed(2),
            zyskNetto: odsetkiNettoCykl.toFixed(2),
            oplataZaWykup: oplataZaWykup.toFixed(2),
            stopaRefLubInflacja: stopaRefLubInflacja,
            kwotaPoZakonczeniuCyklu: kwotaPoCyklu.toFixed(2),
            changeApplied: changeApplied
        });
    }

    document.getElementById("valueKapital").textContent = `${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
    document.querySelector('.result-wrapper-chart .legend-item[data-index="0"] .color-box').setAttribute('data-tooltip', `Kapitał: ${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`);
    document.getElementById("valueOdsetki").textContent = `${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
    document.querySelector('.result-wrapper-chart .legend-item[data-index="1"] .color-box').setAttribute('data-tooltip', `Odsetki: ${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`);
    const podatekCalkowity = odsetkiCalkowite * (state.isIkeIkzeMode ? 0 : 0.19);
    document.getElementById("valuePodatek").textContent = `${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
    document.querySelector('.result-wrapper-chart .legend-item[data-index="2"] .color-box').setAttribute('data-tooltip', `Podatek: ${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`);
    document.getElementById("okresInwestycji").textContent = miesiace;
    document.querySelector('.result-wrapper-chart .highlight.yellow').setAttribute('data-hover', `${miesiace} miesięcy`);
    document.getElementById("zyskNetto").textContent = `${zyskNettoCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    document.querySelector('.result-wrapper-chart .highlight.green').setAttribute('data-hover', `${zyskNettoCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`);

    if (state.chart) state.chart.destroy();
    if (state.chartLine) state.chartLine.destroy();

    const ctx = elements.obligacjeChart.getContext("2d");
    state.chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Kapitał', 'Odsetki', 'Podatek'],
            datasets: [{
                data: [kwota, odsetkiCalkowite, podatekCalkowity],
                backgroundColor: ['#28a745', '#007bff', '#dc3545'],
                borderWidth: 1,
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });

    document.querySelectorAll('.result-wrapper-chart .legend-item').forEach(item => {
        item.addEventListener('mouseenter', function() {
            const index = parseInt(this.getAttribute('data-index'));
            state.chart.setActiveElements([{ datasetIndex: 0, index: index }]);
            state.chart.update();
            const currentLegend = document.querySelector(`#legend${['Kapital', 'Odsetki', 'Podatek'][index]}`);
            if (currentLegend) currentLegend.style.opacity = 0;
            const valueElements = document.querySelectorAll('#valueKapital, #valueOdsetki, #valuePodatek');
            valueElements.forEach((value, idx) => {
                if (idx === index) value.textContent = `${['Kapitał', 'Odsetki', 'Podatek'][idx]}: ${value.textContent}`;
            });
        });

        item.addEventListener('mouseleave', function() {
            const index = parseInt(this.getAttribute('data-index'));
            state.chart.setActiveElements([]);
            state.chart.update();
            const currentLegend = document.querySelector(`#legend${['Kapital', 'Odsetki', 'Podatek'][index]}`);
            if (currentLegend) currentLegend.style.opacity = 1;
            document.getElementById("valueKapital").textContent = `${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
            document.getElementById("valueOdsetki").textContent = `${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
            document.getElementById("valuePodatek").textContent = `${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
        });
    });

    let tabela = document.getElementById("harmonogramTabela");
    tabela.innerHTML = "";
    state.harmonogramData.forEach(wiersz => {
        let rowHTML = `
            <tr>
                <td>${wiersz.okres}</td>
                <td>${parseFloat(wiersz.wartoscInwestycji).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                <td>${wiersz.oprocentowanieNaCykl}${wiersz.changeApplied ? ' ★' : ''}</td>
                <td>${parseFloat(wiersz.odsetkiBrutto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                <td>${parseFloat(wiersz.skumulowaneOdsetki).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                <td>${state.isIkeIkzeMode ? "0,00 zł*" : parseFloat(wiersz.podatek).toLocaleString('pl-PL', { minimumFractionDigits: 2 }) + " zł"}</td>
                <td>${parseFloat(wiersz.zyskNetto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                <td>${parseFloat(wiersz.oplataZaWykup).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
        `;
        if (!["OTS", "TOS"].includes(typ)) {
            rowHTML += `<td>${wiersz.stopaRefLubInflacja}</td>`;
        }
        rowHTML += `
                <td>${parseFloat(wiersz.kwotaPoZakonczeniuCyklu).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
            </tr>
        `;
        tabela.innerHTML += rowHTML;
    });

    if (state.isIkeIkzeMode) {
        document.getElementById("harmonogramOpis").innerHTML = "* Podatek wyniesie 0 zł po osiągnięciu wieku emerytalnego i 55 roku życia lub 60 roku życia w przypadku IKE oraz 10 % zryczałtowanego podatku po osiągnięciu 65 roku życia w przypadku IKZE.";
    } else {
        document.getElementById("harmonogramOpis").textContent = "";
    }

    const maxKwotaPoCyklu = Math.max(...state.harmonogramData.map(wiersz => parseFloat(wiersz.kwotaPoZakonczeniuCyklu)));
    const minKwota = kwota;
    const range = maxKwotaPoCyklu - minKwota;
    const padding = range * 0.1;
    const yMin = minKwota - padding;
    const yMax = maxKwotaPoCyklu + padding;
    const stepSize = range / 5;

    const ctxLine = elements.obligacjeChartLine.getContext("2d");
    state.chartLine = new Chart(ctxLine, {
        type: 'line',
        data: {
            labels: state.harmonogramData.map(wiersz => ["OTS", "ROR", "DOR"].includes(typ) ? `Miesiąc ${wiersz.okres}` : `Rok ${wiersz.okres}`),
            datasets: [
                {
                    label: 'Zainwestowana kwota',
                    data: state.harmonogramData.map(() => kwota),
                    borderColor: '#8B7D47',
                    backgroundColor: 'rgba(139, 125, 71, 0.1)',
                    fill: false,
                    tension: 0,
                    borderWidth: 2
                },
                {
                    label: 'Kwota po zakończeniu cyklu',
                    data: state.harmonogramData.map(wiersz => parseFloat(wiersz.kwotaPoZakonczeniuCyklu)),
                    borderColor: '#D4C791',
                    backgroundColor: 'rgba(212, 199, 145, 0.2)',
                    fill: true,
                    tension: 0.1,
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { title: { display: true, text: ["OTS", "ROR", "DOR"].includes(typ) ? 'Okres (miesiące)' : 'Okres (lata)', font: { size: 14 } }, ticks: { font: { size: 12 } } },
                y: { title: { display: true, text: 'Wartość (PLN)', font: { size: 14 } }, min: yMin, max: yMax, ticks: { stepSize: stepSize, font: { size: 12 } } }
            },
            plugins: { legend: { display: true, position: 'top', labels: { font: { size: 12 } } }, tooltip: { enabled: true, backgroundColor: 'rgba(0, 0, 0, 0.8)' } }
        }
    });

    elements.formSection.style.display = "none";
    elements.resultSection.style.display = "block";
    state.isCalculating = false;
}

// Inicjalizacja
updateIloscObligacji();
updateLata();
updateOprocentowanieInfo();
updateOpisObligacji();
updateDynamicRateField();
</script>
<script>
    const { jsPDF } = window.jspdf || {};
if (!jsPDF) console.error("Biblioteka jsPDF nie została załadowana.");
else if (!jsPDF.prototype.autoTable) console.warn("Plugin autoTable nie został załadowany.");

function generatePdf() {
    if (!jsPDF) {
        alert("Błąd: Biblioteka jsPDF nie jest załadowana.");
        return;
    }

    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
    });

    // Ustawienie fontu z polskimi znakami
    doc.setFont("times"); // Domyślny font obsługujący polskie znaki
    doc.setFontSize(16);

    const typ = state.lastFormData.typObligacji;
    const nazwaObligacji = nazwyObligacji[typ];
    const headerText = `Wynik inwestycji dla obligacji ${nazwaObligacji}${state.isIkeIkzeMode ? " (IKE/IKZE)" : ""}`;
    const opis = opisyObligacji[typ] || "";

    // Nagłówek
    doc.text(headerText, 10, 10);

    // Opis obligacji
    doc.setFontSize(10);
    const opisLines = doc.splitTextToSize(opis.replace(/<[^>]+>/g, ""), 190); // Usunięcie HTML
    doc.text(opisLines, 10, 20);

    // Podsumowanie
    const summary = [
        `Kapitał: ${parseFloat(state.lastFormData.kwota).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
        `Odsetki: ${parseFloat(document.getElementById("valueOdsetki").textContent.replace(/[^\d,.]/g, "").replace(",", ".")).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
        `Podatek: ${parseFloat(document.getElementById("valuePodatek").textContent.replace(/[^\d,.]/g, "").replace(",", ".")).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
        `Okres inwestycji: ${state.lastFormData.okres} miesięcy`,
        `Zysk netto: ${parseFloat(document.getElementById("zyskNetto").textContent.replace(/[^\d,.]/g, "").replace(",", ".")).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`
    ];

    doc.setFontSize(12);
    doc.text("Podsumowanie:", 10, 20 + opisLines.length * 5 + 5);
    doc.setFontSize(10);
    summary.forEach((line, index) => {
        doc.text(line, 10, 20 + opisLines.length * 5 + 10 + index * 5);
    });

    // Tabela harmonogramu
    const headers = ["OTS", "ROR", "DOR"].includes(typ) ?
        ["Miesiąc", "Wartość inwestycji", "Oproc.", "Odsetki", "Suma odsetek", "Podatek", "Zysk netto", "Opłata za wykup", "Stopa Ref. NBP", "Suma netto"] :
        ["Rok", "Wartość inwestycji", "Oproc.", "Odsetki", "Suma odsetek", "Podatek", "Zysk netto", "Opłata za wykup", "Inflacja", "Suma netto"];
    if (["OTS", "TOS"].includes(typ)) headers.splice(8, 1);

    const tableData = state.harmonogramData.map(wiersz => {
        const row = [
            wiersz.okres,
            `${parseFloat(wiersz.wartoscInwestycji).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
            wiersz.oprocentowanieNaCykl,
            `${parseFloat(wiersz.odsetkiBrutto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
            `${parseFloat(wiersz.skumulowaneOdsetki).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
            state.isIkeIkzeMode ? "0,00 zł*" : `${parseFloat(wiersz.podatek).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
            `${parseFloat(wiersz.zyskNetto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
            `${parseFloat(wiersz.oplataZaWykup).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`
        ];
        if (!["OTS", "TOS"].includes(typ)) row.push(wiersz.stopaRefLubInflacja);
        row.push(`${parseFloat(wiersz.kwotaPoZakonczeniuCyklu).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`);
        return row;
    });

    doc.autoTable({
        head: [headers],
        body: tableData,
        startY: 20 + opisLines.length * 5 + summary.length * 5 + 10,
        styles: { font: "times", fontSize: 8, cellPadding: 2 }, // Font z polskimi znakami
        headStyles: { fillColor: [194, 178, 128], textColor: [0, 0, 0] },
        alternateRowStyles: { fillColor: [245, 245, 245] }
    });

    // Dodatkowy opis dla IKE/IKZE
    if (state.isIkeIkzeMode) {
        doc.setFontSize(8);
        const ikeIkzeText = "* Podatek wyniesie 0 zł po osiągnięciu wieku emerytalnego i 55 roku życia lub 60 roku życia w przypadku IKE oraz 10 % zryczałtowanego podatku po osiągnięciu 65 roku życia w przypadku IKZE.";
        const ikeIkzeLines = doc.splitTextToSize(ikeIkzeText, 190);
        doc.text(ikeIkzeLines, 10, doc.lastAutoTable.finalY + 5);
    }

    // Dodanie wykresu kołowego
    const chartCanvas = document.getElementById("obligacjeChart");
    const chartImage = chartCanvas.toDataURL("image/png");
    const chartWidth = 60; // Szerokość w mm
    const chartHeight = 60; // Wysokość w mm
    const pageWidth = doc.internal.pageSize.getWidth();
    const chartX = (pageWidth - chartWidth) / 2; // Centrowanie
    let currentY = doc.lastAutoTable.finalY + (state.isIkeIkzeMode ? 15 : 10);

    doc.setFontSize(12);
    doc.text("Wykres kołowy wyników inwestycji", 10, currentY + 5);
    doc.addImage(chartImage, "PNG", chartX, currentY + 10, chartWidth, chartHeight);

    // Sprawdzenie, czy potrzebna jest nowa strona
    currentY += chartHeight + 20;
    if (currentY + 60 > doc.internal.pageSize.getHeight()) {
        doc.addPage();
        currentY = 10;
    }

    // Dodanie wykresu liniowego
    const lineChartCanvas = document.getElementById("obligacjeChartLine");
    const lineChartImage = lineChartCanvas.toDataURL("image/png");
    const lineChartWidth = 180; // Szerokość w mm (większa dla wykresu liniowego)
    const lineChartHeight = 100; // Wysokość w mm
    const lineChartX = (pageWidth - lineChartWidth) / 2; // Centrowanie

    doc.setFontSize(12);
    doc.text("Wykres liniowy wartości inwestycji w czasie", 10, currentY + 5);
    doc.addImage(lineChartImage, "PNG", lineChartX, currentY + 10, lineChartWidth, lineChartHeight);

    // Zapis pliku
    doc.save(`Wynik_inwestycji_${nazwaObligacji.replace(/\s+/g, "_")}.pdf`);
}
</script>
