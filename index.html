<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Obligacji Skarbowych</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .form-section, .result-section {
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result-section {
            display: none;
        }
        .result-wrapper-chart {
            display: flex;
            flex-wrap: wrap; /* Pozwala na zawijanie na mniejszych ekranach */
            justify-content: space-between;
            align-items: flex-start;
            margin-top: 20px;
            gap: 20px;
        }
        .chart-container {
            flex: 1 1 45%; /* Elastyczna szerokość, minimum 45% */
            min-width: 300px; /* Minimalna szerokość dla czytelności */
            text-align: center;
        }
        .chart {
            width: 100% !important; /* Nadpisuje sztywne wartości Chart.js */
            height: auto !important;
            max-width: 300px;
            margin: 0 auto;
        }
        .chart-legend {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .color-box {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        .highlight {
            font-size: 1.2em;
            font-weight: bold;
        }
        .yellow { color: #ffc107; }
        .green { color: #28a745; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto; /* Scroll na małych ekranach */
            display: block;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
            white-space: nowrap; /* Zapobiega zawijaniu tekstu */
        }
        th {
            background-color: #f8f9fa;
        }
        .harmonogram-opis {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }
        .variable-rate-section {
            display: none;
            margin-top: 20px;
        }
        .variable-rate-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        /* Responsywność */
        @media (max-width: 768px) {
            .chart-container {
                flex: 1 1 100%; /* Pełna szerokość na małych ekranach */
            }
            .result-wrapper-chart {
                flex-direction: column;
            }
            table {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Kalkulator Obligacji Skarbowych</h1>
        
        <div class="form-section" id="formSection">
            <div class="form-group">
                <label for="kwota">Kwota inwestycji (PLN):</label>
                <input type="number" id="kwota" min="100" step="100" value="1000">
            </div>
            <div class="form-group">
                <label for="typObligacji">Typ obligacji:</label>
                <select id="typObligacji">
                    <option value="OTS">3-miesięczne (OTS)</option>
                    <option value="ROR">1-roczne (ROR)</option>
                    <option value="DOR">2-letnie (DOR)</option>
                    <option value="TOS">3-letnie (TOS)</option>
                    <option value="COI">4-letnie (COI)</option>
                    <option value="EDO">10-letnie (EDO)</option>
                    <option value="ROS">6-letnie (ROS)</option>
                    <option value="ROD">12-letnie (ROD)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ilość sztuk:</label>
                <span id="iloscObligacji"></span>
            </div>
            <div class="form-group">
                <label>Okres inwestycji:</label>
                <span id="lata"></span>
            </div>
            <div class="form-group">
                <label>Oprocentowanie:</label>
                <span id="oprocentowanieInfo"></span>
            </div>
            <div class="form-group">
                <label>Opis:</label>
                <div id="opisObligacji"></div>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="ikeIkzeMode"> IKE/IKZE (bez podatku Belki)</label>
            </div>
            <div class="form-group" id="dynamicRateGroup" style="display: none;">
                <label for="dynamicRate">Inflacja lub stopa referencyjna NBP (%):</label>
                <input type="number" id="dynamicRate" step="0.01" min="0">
            </div>
            <div class="variable-rate-section" id="variableRateSection">
                <label><input type="checkbox" id="inflacjaZmiennaBtn"> Zmienna inflacja</label>
                <label><input type="checkbox" id="stopaZmiennaBtn"> Zmienna stopa referencyjna</label>
                <div id="variableRateInputs"></div>
                <button id="addVariableRate">Dodaj zmianę</button>
            </div>
            <button id="obliczBtn">Oblicz</button>
        </div>

        <div class="result-section" id="resultSection">
            <h2 id="resultHeader"></h2>
            <div class="result-wrapper-chart">
                <div class="chart-container">
                    <canvas id="obligacjeChart" class="chart"></canvas>
                    <div class="chart-legend">
                        <div class="legend-item" data-index="0">
                            <div class="color-box" style="background-color: #28a745;" data-tooltip="Kapitał"></div>
                            <span id="legendKapital">Kapitał</span>
                        </div>
                        <div class="legend-item" data-index="1">
                            <div class="color-box" style="background-color: #007bff;" data-tooltip="Odsetki"></div>
                            <span id="legendOdsetki">Odsetki</span>
                        </div>
                        <div class="legend-item" data-index="2">
                            <div class="color-box" style="background-color: #dc3545;" data-tooltip="Podatek"></div>
                            <span id="legendPodatek">Podatek</span>
                        </div>
                    </div>
                    <p><strong>Kwota:</strong> <span id="valueKapital"></span></p>
                    <p><strong>Odsetki:</strong> <span id="valueOdsetki"></span></p>
                    <p><strong>Podatek:</strong> <span id="valuePodatek"></span></p>
                </div>
                <div class="chart-container">
                    <canvas id="obligacjeChartLine" class="chart"></canvas>
                    <p>Okres inwestycji: <span class="highlight yellow" id="okresInwestycji"></span></p>
                    <p>Zysk netto: <span class="highlight green" id="zyskNetto"></span></p>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th id="pierwszaKolumnaNaglowek"></th>
                        <th>Wartość inwestycji</th>
                        <th>Oprocentowanie</th>
                        <th>Odsetki brutto</th>
                        <th>Skumulowane odsetki</th>
                        <th>Podatek</th>
                        <th id="zyskKolumnaNaglowek"></th>
                        <th>Opłata za wykup</th>
                        <th id="kolumnaStopaInflacja"></th>
                        <th>Suma netto</th>
                    </tr>
                </thead>
                <tbody id="harmonogramTabela"></tbody>
            </table>
            <div class="harmonogram-opis" id="harmonogramOpis"></div>
            <div class="button-group">
                <button id="generatePdfBtn">Generuj PDF</button>
                <button id="powrotBtn">Powrót</button>
            </div>
        </div>
    </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const elements = {
            formSection: document.getElementById("formSection"),
            resultSection: document.getElementById("resultSection"),
            kwota: document.getElementById("kwota"),
            kwotaRange: document.getElementById("kwotaRange"),
            typObligacji: document.getElementById("typObligacji"),
            dynamicRate: document.getElementById("dynamicRate"),
            dynamicRateRange: document.getElementById("dynamicRateRange"),
            okres: document.getElementById("okres"),
            oprocentowanie: document.getElementById("oprocentowanie"),
            ikeIkzeBtn: document.getElementById("ikeIkzeBtn"),
            inflacjaZmiennaBtn: document.getElementById("inflacjaZmiennaBtn"),
            stopaZmiennaBtn: document.getElementById("stopaZmiennaBtn"),
            obliczBtn: document.getElementById("obliczBtn"),
            addVariableBtn: document.getElementById("addVariableBtn"),
            resultHeader: document.getElementById("resultHeader"),
            obligacjeChart: document.getElementById("obligacjeChart"),
            obligacjeChartLine: document.getElementById("obligacjeChartLine"),
            generatePdfBtn: document.getElementById("generatePdfBtn")
        };

        const state = {
            chart: null,
            chartLine: null,
            harmonogramData: [],
            isIkeIkzeMode: false,
            variableInflacjaChanges: [],
            variableStopaChanges: [],
            lastFormData: {
                kwota: 10000,
                typObligacji: "OTS",
                dynamicRate: 5.75,
                okres: 3,
                oprocentowanie: 3,
                ikeIkze: false,
                isInflacja: false,
                inflacjaZmienna: false,
                stopaZmienna: false,
                variableInflacjaChanges: [],
                variableStopaChanges: []
            },
            isCalculating: false
        };

        const maxVariableChanges = {
            "ROR": 11,
            "DOR": 23,
            "COI": 3,
            "EDO": 9,
            "ROS": 5,
            "ROD": 11
        };

        const obligacjeConfig = {
            "OTS": { okres: 3, oprocentowanie: 3.00, zmienne: false, kapitalizacja: false, oplataWykup: 0.00 },
            "ROR": { okres: 12, oprocentowanie: 5.75, zmienne: true, marza: 0.00, kapitalizacja: false, oplataWykup: 0.005 },
            "DOR": { okres: 24, oprocentowanie: 5.90, zmienne: true, marza: 0.15, kapitalizacja: false, oplataWykup: 0.007 },
            "TOS": { okres: 36, oprocentowanie: 5.95, zmienne: false, kapitalizacja: true, oplataWykup: 0.01 },
            "COI": { okres: 48, oprocentowanie: 6.30, zmienne: true, marza: 1.50, indeksowaneInflacja: true, kapitalizacja: false, oplataWykup: 0.02 },
            "EDO": { okres: 120, oprocentowanie: 6.55, zmienne: true, marza: 2.00, indeksowaneInflacja: true, kapitalizacja: true, oplataWykup: 0.03 },
            "ROS": { okres: 72, oprocentowanie: 6.50, zmienne: true, marza: 2.00, indeksowaneInflacja: true, kapitalizacja: true, oplataWykup: 0.02 },
            "ROD": { okres: 144, oprocentowanie: 6.80, zmienne: true, marza: 2.50, indeksowaneInflacja: true, kapitalizacja: true, oplataWykup: 0.03 }
        };

        const opisyObligacji = {
            "OTS": "* OTS (3-miesięczne): stałe oprocentowanie 3,00% na okres 3-miesięcy, wypłata odsetek nastąpi przy wykupie obligacji. Wcześniejszy odkup powoduje nienaliczenie odsetek, natomiast nie ma opłat za wcześniejszy odkup. Obligacje OTS są idealne dla krótkoterminowych inwestycji.",
            "ROR": "* ROR (12-miesięczne): oprocentowanie zmienne, w pierwszym miesiącu 5,75%, w pozostałych 11 miesiącach oprocentowanie oparte na stopie referencyjnej NBP + 0%. Wypłata odsetek następuje co miesiąc, jest możliwość wcześniejszego odkupu, niestety wiąże się to z opłatą w wysokości 0,5% wartości obligacji (0,5 zł za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Obligacje ROR przeznaczone są dla krótko i średnioterminowych inwestorów.",
            "DOR": "* DOR (24-miesięczne): oprocentowanie zmienne, 5,90% w pierwszym miesiącu, w pozostałych 23 miesiącach oprocentowanie oparte na stopie referencyjnej NBP + 0,15%. Wypłata odsetek następuje co miesiąc, jest możliwość wcześniejszego odkupu, niestety wiąże się to z opłatą w wysokości 0,7% wartości obligacji (0,7 zł za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Obligacje DOR przeznaczone są dla średnioterminowych inwestorów.",
            "TOS": "* TOS (3-letnie): stałe oprocentowanie 5,95% na okres 3-lat, wypłata odsetek nastąpi przy wykupie obligacji po 3 latach inwestycji. Wcześniejszy odkup wiąże się z opłatą w wysokości 1% wartości obligacji (1 zł za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Roczna kapitalizacja odsetek zwiększa efektywności inwestycji. Obligacje TOS przeznaczone dla stabilnych średnioterminowych inwestycji.",
            "COI": "* COI (4-letnie): obligacje indeksowane inflacją, 6,30% w pierwszym roku, w kolejnych 3 latach oprocentowanie wynosi wartość inflacji + 1,50%. Wypłata odsetek następuje po każdym roku inwestycji, jest możliwość wcześniejszego odkupu, niestety wiąże się to z opłatą w wysokości 2% wartości obligacji (2 zł za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Obligacje COI są idealne dla średnio i długoterminowych inwestycji oraz dla ochrony przed wzrostem inflacji.",
            "EDO": "* EDO (10-letnie): obligacje indeksowane inflacją, 6,55% w pierwszym roku, w kolejnych 9 latach oprocentowanie wynosi wartość inflacji + 2,00%. Wypłata odsetek następuje przy wykupie obligacji po 10 latach inwestycji. Wcześniejszy odkup niestety wiąże się z opłatą w wysokości 3% wartości obligacji (3 zł za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Roczna kapitalizacja odsetek zwiększa efektywności inwestycji. Obligacje EDO są idealne dla długoterminowych inwestycji oraz dla ochrony przed wzrostem inflacji.",
            "ROS": "* ROS (6-letnie): rodzinne obligacje przeznaczone są wyłącznie dla beneficjentów programu 800+. Obligacje indeksowane inflacją, 6,50% w pierwszym roku, w kolejnych 5 latach oprocentowanie wynosi wartość inflacji + 2,00%. Wypłata odsetek następuje przy wykupie obligacji po 6 latach inwestycji. Wcześniejszy odkup niestety wiąże się z opłatą w wysokości 2% wartości obligacji (2 zł za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Roczna kapitalizacja odsetek zwiększa efektywności inwestycji. Obligacje ROS są idealne dla rodzinnych inwestycji oraz dla ochrony przed wzrostem inflacji.",
            "ROD": "* ROD (12-letnie): rodzinne obligacje przeznaczone są wyłącznie dla beneficjentów programu 800+. Obligacje indeksowane inflacją, 6,80% w pierwszym roku, w kolejnych 11 latach oprocentowanie wynosi wartość inflacji + 2,50%. Wypłata odsetek następuje przy wykupie obligacji po 12 latach inwestycji. Wcześniejszy odkup niestety wiąże się z opłatą w wysokości 3% wartości obligacji (3 zł za każdą obligację) lub do wartości narosłych odsetek, gdy wartość narosłych odsetek jest mniejsza od wartości opłaty, nie powoduje utraty należnych odsetek. Roczna kapitalizacja odsetek zwiększa efektywności inwestycji. Obligacje ROD są idealne dla długoterminowych rodzinnych inwestycji oraz dla ochrony przed wzrostem inflacji."
        };

        const nazwyObligacji = {
            "OTS": "3-miesięcznych (OTS)", "ROR": "12-miesięcznych (ROR)", "DOR": "24-miesięcznych (DOR)", "TOS": "3-letnich (TOS)",
            "COI": "4-letnich (COI)", "EDO": "10-letnich (EDO)", "ROS": "6-letnich (ROS)", "ROD": "12-letnich (ROD)"
        };

        elements.dynamicRateRange.addEventListener("input", () => elements.dynamicRate.value = elements.dynamicRateRange.value);
        elements.dynamicRate.addEventListener("input", () => elements.dynamicRateRange.value = elements.dynamicRate.value);
        elements.kwotaRange.addEventListener("input", () => { elements.kwota.value = elements.kwotaRange.value; updateIloscObligacji(); });
        elements.kwota.addEventListener("input", () => { elements.kwotaRange.value = elements.kwota.value; updateIloscObligacji(); });
        elements.typObligacji.addEventListener("change", updateDynamicRateField);
        elements.ikeIkzeBtn.addEventListener("change", updateDynamicRateField);
        elements.inflacjaZmiennaBtn.addEventListener("change", () => { state.lastFormData.inflacjaZmienna = elements.inflacjaZmiennaBtn.checked; updateVariableInputs(); });
        elements.stopaZmiennaBtn.addEventListener("change", () => { state.lastFormData.stopaZmienna = elements.stopaZmiennaBtn.checked; updateVariableInputs(); });
        elements.obliczBtn.addEventListener("click", obliczObligacje);
        elements.addVariableBtn.addEventListener("click", addVariableChange);
        elements.generatePdfBtn.addEventListener("click", generatePdf);
                function setDynamicRateField(label, value, step, max) {
            const dynamicRateLabel = document.getElementById("dynamicRateLabel");
            dynamicRateLabel.textContent = label;
            elements.dynamicRate.value = value;
            elements.dynamicRateRange.value = value;
            elements.dynamicRate.step = step;
            elements.dynamicRateRange.step = step;
            elements.dynamicRate.max = max;
            elements.dynamicRateRange.max = max;
            document.getElementById("dynamicRateGroup").style.display = "block";
        }

        function updateDynamicRateField() {
            state.isIkeIkzeMode = elements.ikeIkzeBtn.checked;
            const select = elements.typObligacji;
            const previousTyp = select.value;

            select.innerHTML = state.isIkeIkzeMode ? `
                <option value="ROR">12-miesięczne (ROR)</option>
                <option value="DOR">24-miesięczne (DOR)</option>
                <option value="TOS" selected>3-letnie (TOS)</option>
                <option value="COI">4-letnie (COI)</option>
                <option value="EDO">10-letnie (EDO)</option>
            ` : `
                <option value="OTS" selected>3-miesięczne (OTS)</option>
                <option value="ROR">12-miesięczne (ROR)</option>
                <option value="DOR">24-miesięczne (DOR)</option>
                <option value="TOS">3-letnie (TOS)</option>
                <option value="COI">4-letnie (COI)</option>
                <option value="EDO">10-letnie (EDO)</option>
                <option value="ROS">6-letnie (ROS)</option>
                <option value="ROD">12-letnie (ROD)</option>
            `;

            const availableOptions = Array.from(select.options).map(opt => opt.value);
            select.value = availableOptions.includes(previousTyp) ? previousTyp : (state.isIkeIkzeMode ? "TOS" : "OTS");

            const typ = select.value;
            const config = obligacjeConfig[typ];

            elements.okres.value = config.okres;
            elements.oprocentowanie.value = config.oprocentowanie;
            updateLata();
            updateOprocentowanieInfo();
            updateOpisObligacji();

            if (["COI", "EDO", "ROS", "ROD"].includes(typ)) {
                setDynamicRateField("Inflacja", state.lastFormData.isInflacja ? (state.lastFormData.dynamicRate || 4.90) : 4.90, "0.1", "50");
                state.lastFormData.isInflacja = true;
            } else if (["ROR", "DOR"].includes(typ)) {
                setDynamicRateField("Stopa Ref. NBP", state.lastFormData.isInflacja ? 5.75 : (state.lastFormData.dynamicRate || 5.75), "0.05", "20");
                state.lastFormData.isInflacja = false;
            } else {
                document.getElementById("dynamicRateGroup").style.display = "none";
                state.lastFormData.isInflacja = false;
            }

            document.getElementById("inflacjaZmiennaLabel").style.display = ["COI", "EDO", "ROS", "ROD"].includes(typ) ? "flex" : "none";
            document.getElementById("stopaZmiennaLabel").style.display = ["ROR", "DOR"].includes(typ) ? "flex" : "none";

            elements.inflacjaZmiennaBtn.checked = state.lastFormData.inflacjaZmienna || false;
            elements.stopaZmiennaBtn.checked = state.lastFormData.stopaZmienna || false;
            state.variableInflacjaChanges = state.lastFormData.variableInflacjaChanges ? [...state.lastFormData.variableInflacjaChanges] : [];
            state.variableStopaChanges = state.lastFormData.variableStopaChanges ? [...state.lastFormData.variableStopaChanges] : [];
            updateVariableInputs();
        }

        function updateIloscObligacji() {
            const kwota = parseFloat(elements.kwota.value) || 0;
            const ilosc = Math.floor(kwota / 100);
            document.getElementById("iloscObligacji").textContent = `Ilość obligacji: ${ilosc}`;
        }

        function updateLata() {
            const miesiace = parseInt(elements.okres.value) || 0;
            const lata = (miesiace / 12).toFixed(0);
            document.getElementById("lata").textContent = `Ilość lat: ${miesiace >= 12 ? lata : 0}`;
        }

        function updateOprocentowanieInfo() {
            const typ = elements.typObligacji.value;
            const config = obligacjeConfig[typ];
            let info = config.zmienne ? 
                (config.indeksowaneInflacja ? 
                    `Pierwszy rok: ${config.oprocentowanie}%, kolejne: inflacja + ${config.marza}%` : 
                    `Pierwszy miesiąc: ${config.oprocentowanie}%, kolejne: stopa NBP + ${config.marza}%`) : 
                `Stałe: ${config.oprocentowanie}%`;
            document.getElementById("oprocentowanieInfo").textContent = info;
        }

        function updateOpisObligacji() {
            const typ = elements.typObligacji.value;
            const opis = opisyObligacji[typ] || "";
            document.getElementById("obligacjeOpis").innerHTML = opis;
            document.getElementById("obligacjeOpisPodsumowanie").innerHTML = opis;
        }

        function toggleHarmonogram(sectionId) {
            const content = document.getElementById(sectionId);
            const toggleBtn = content.previousElementSibling;
            content.style.display = content.style.display === "none" ? "block" : "none";
            toggleBtn.textContent = content.style.display === "none" ? "Harmonogram odsetek ►" : "Harmonogram odsetek ▼";
        }

        function showForm() {
            elements.formSection.style.display = "block";
            elements.resultSection.style.display = "none";

            elements.kwota.value = state.lastFormData.kwota;
            elements.kwotaRange.value = state.lastFormData.kwota;
            elements.dynamicRate.value = state.lastFormData.dynamicRate;
            elements.dynamicRateRange.value = state.lastFormData.dynamicRate;
            elements.okres.value = state.lastFormData.okres;
            elements.oprocentowanie.value = state.lastFormData.oprocentowanie;
            elements.ikeIkzeBtn.checked = state.lastFormData.ikeIkze;
            state.isIkeIkzeMode = state.lastFormData.ikeIkze;
            elements.typObligacji.value = state.lastFormData.typObligacji;
            elements.inflacjaZmiennaBtn.checked = state.lastFormData.inflacjaZmienna || false;
            elements.stopaZmiennaBtn.checked = state.lastFormData.stopaZmienna || false;
            state.variableInflacjaChanges = state.lastFormData.variableInflacjaChanges ? [...state.lastFormData.variableInflacjaChanges] : [];
            state.variableStopaChanges = state.lastFormData.variableStopaChanges ? [...state.lastFormData.variableStopaChanges] : [];

            updateDynamicRateField();
            updateIloscObligacji();
            updateLata();
            updateOprocentowanieInfo();
            updateOpisObligacji();
        }

        function updateVariableInputs() {
            const typ = elements.typObligacji.value;
            const isInflacjaZmienna = elements.inflacjaZmiennaBtn.checked && ["COI", "EDO", "ROS", "ROD"].includes(typ);
            const isStopaZmienna = elements.stopaZmiennaBtn.checked && ["ROR", "DOR"].includes(typ);
            const variableInputs = document.getElementById("variableInputs");
            const addVariableBtn = elements.addVariableBtn;
            const wrapper = document.getElementById("variableInputsWrapper");
            const config = obligacjeConfig[typ];
            const maxCykl = ["ROR", "DOR"].includes(typ) ? config.okres : config.okres / 12;

            if (isInflacjaZmienna || isStopaZmienna) {
                variableInputs.style.display = "block";
                addVariableBtn.style.display = "block";

                if ((isInflacjaZmienna && state.variableInflacjaChanges.length === 0) || (isStopaZmienna && state.variableStopaChanges.length === 0)) {
                    addVariableChange();
                }

                wrapper.innerHTML = "";
                const changes = isInflacjaZmienna ? state.variableInflacjaChanges : state.variableStopaChanges;

                changes.forEach((change, index) => {
                    const inputGroup = document.createElement("div");
                    inputGroup.className = "variable-input-group";

                    const fieldsWrapper = document.createElement("div");
                    fieldsWrapper.className = "fields-wrapper";

                    const cyklGroup = document.createElement("div");
                    cyklGroup.className = "form-group";
                    cyklGroup.innerHTML = `
                        <label class="form-label">Od ${["ROR", "DOR"].includes(typ) ? "miesiąca" : "roku"}</label>
                        <div class="input-group">
                            <input type="number" class="form-control variable-cykl" min="1" max="${maxCykl}" step="1" value="${change.cykl}">
                            <span class="input-group-text">${["ROR", "DOR"].includes(typ) ? "mc" : "rok"}</span>
                        </div>
                        <input type="range" class="form-range variable-cykl-range" min="1" max="${maxCykl}" step="1" value="${change.cykl}">
                    `;

                    const rateGroup = document.createElement("div");
                    rateGroup.className = "form-group";
                    rateGroup.innerHTML = `
                        <label class="form-label">${isInflacjaZmienna ? "Inflacja" : "Stopa NBP"}</label>
                        <div class="input-group">
                            <input type="number" class="form-control variable-rate" min="0" max="${isInflacjaZmienna ? 50 : 20}" step="${isInflacjaZmienna ? 0.1 : 0.05}" value="${change.wartosc}">
                            <span class="input-group-text">%</span>
                        </div>
                        <input type="range" class="form-range variable-rate-range" min="0" max="${isInflacjaZmienna ? 50 : 20}" step="${isInflacjaZmienna ? 0.1 : 0.05}" value="${change.wartosc}">
                    `;

                    fieldsWrapper.appendChild(cyklGroup);
                    fieldsWrapper.appendChild(rateGroup);
                    inputGroup.appendChild(fieldsWrapper);

                    if (index === changes.length - 1 && changes.length > 1) {
                        const removeBtnWrapper = document.createElement("div");
                        removeBtnWrapper.className = "remove-btn-wrapper";
                        const removeBtn = document.createElement("button");
                        removeBtn.className = "btn btn-danger btn-sm";
                        removeBtn.textContent = "Usuń";
                        removeBtn.onclick = () => removeVariableChange();
                        removeBtnWrapper.appendChild(removeBtn);
                        inputGroup.appendChild(removeBtnWrapper);
                    }

                    wrapper.appendChild(inputGroup);

                    const cyklInput = inputGroup.querySelector(".variable-cykl");
                    const cyklRange = inputGroup.querySelector(".variable-cykl-range");
                    const rateInput = inputGroup.querySelector(".variable-rate");
                    const rateRange = inputGroup.querySelector(".variable-rate-range");

                    cyklInput.addEventListener("input", () => {
                        let value = parseInt(cyklInput.value);
                        if (value < 1 || value > maxCykl) cyklInput.value = Math.max(1, Math.min(maxCykl, value));
                        cyklRange.value = cyklInput.value;
                        changes[index].cykl = parseInt(cyklInput.value);
                    });
                    cyklRange.addEventListener("input", () => {
                        cyklInput.value = cyklRange.value;
                        changes[index].cykl = parseInt(cyklRange.value);
                    });
                    rateInput.addEventListener("input", () => {
                        let value = parseFloat(rateInput.value);
                        if (value < 0 || value > (isInflacjaZmienna ? 50 : 20)) rateInput.value = Math.max(0, Math.min(isInflacjaZmienna ? 50 : 20, value));
                        rateRange.value = rateInput.value;
                        changes[index].wartosc = parseFloat(rateInput.value);
                    });
                    rateRange.addEventListener("input", () => {
                        rateInput.value = rateRange.value;
                        changes[index].wartosc = parseFloat(rateInput.value);
                    });
                });

                const maxChanges = maxVariableChanges[typ] || 0;
                addVariableBtn.style.display = changes.length < maxChanges ? "block" : "none";
            } else {
                variableInputs.style.display = "none";
                addVariableBtn.style.display = "none";
                wrapper.innerHTML = "";
            }
        }

        function addVariableChange() {
            const typ = elements.typObligacji.value;
            const isInflacjaZmienna = elements.inflacjaZmiennaBtn.checked && ["COI", "EDO", "ROS", "ROD"].includes(typ);
            const changes = isInflacjaZmienna ? state.variableInflacjaChanges : state.variableStopaChanges;
            const maxCykl = ["ROR", "DOR"].includes(typ) ? obligacjeConfig[typ].okres : obligacjeConfig[typ].okres / 12;
            const maxChanges = maxVariableChanges[typ] || 0;

            if (changes.length >= maxChanges) {
                alert(`Osiągnięto maksymalną liczbę zmian dla obligacji ${typ} (${maxChanges}).`);
                return;
            }

            const lastCykl = changes.length > 0 ? changes[changes.length - 1].cykl : 1;
            const newCykl = Math.min(lastCykl + 1, maxCykl);
            changes.push({ cykl: newCykl, wartosc: isInflacjaZmienna ? 4.90 : 5.75 });
            updateVariableInputs();
        }

        function removeVariableChange() {
            const typ = elements.typObligacji.value;
            const isInflacjaZmienna = elements.inflacjaZmiennaBtn.checked && ["COI", "EDO", "ROS", "ROD"].includes(typ);
            const changes = isInflacjaZmienna ? state.variableInflacjaChanges : state.variableStopaChanges;
            if (changes.length > 1) {
                changes.pop();
                updateVariableInputs();
            }
        }
        <script>
    const elements = {
        kwota: document.getElementById("kwota"),
        typObligacji: document.getElementById("typObligacji"),
        iloscObligacji: document.getElementById("iloscObligacji"),
        lata: document.getElementById("lata"),
        oprocentowanieInfo: document.getElementById("oprocentowanieInfo"),
        opisObligacji: document.getElementById("opisObligacji"),
        ikeIkzeMode: document.getElementById("ikeIkzeMode"),
        dynamicRate: document.getElementById("dynamicRate"),
        dynamicRateGroup: document.getElementById("dynamicRateGroup"),
        variableRateSection: document.getElementById("variableRateSection"),
        inflacjaZmiennaBtn: document.getElementById("inflacjaZmiennaBtn"),
        stopaZmiennaBtn: document.getElementById("stopaZmiennaBtn"),
        variableRateInputs: document.getElementById("variableRateInputs"),
        addVariableRate: document.getElementById("addVariableRate"),
        obliczBtn: document.getElementById("obliczBtn"),
        formSection: document.getElementById("formSection"),
        resultSection: document.getElementById("resultSection"),
        resultHeader: document.getElementById("resultHeader"),
        obligacjeChart: document.getElementById("obligacjeChart"),
        obligacjeChartLine: document.getElementById("obligacjeChartLine"),
        generatePdfBtn: document.getElementById("generatePdfBtn"),
        powrotBtn: document.getElementById("powrotBtn")
    };

    const state = {
        isIkeIkzeMode: false,
        isCalculating: false,
        chart: null,
        chartLine: null,
        harmonogramData: [],
        lastFormData: null,
        variableInflacjaChanges: [],
        variableStopaChanges: []
    };

    const obligacjeConfig = {
        OTS: { okres: 3, oprocentowanie: 3.00, marza: 0, kapitalizacja: false, oplataWykup: 0 },
        ROR: { okres: 12, oprocentowanie: 5.25, marza: 0, kapitalizacja: false, oplataWykup: 0.0070 },
        DOR: { okres: 24, oprocentowanie: 5.50, marza: 0.25, kapitalizacja: false, oplataWykup: 0.0070 },
        TOS: { okres: 36, oprocentowanie: 5.85, marza: 0, kapitalizacja: false, oplataWykup: 0 },
        COI: { okres: 48, oprocentowanie: 6.25, marza: 0.75, kapitalizacja: false, oplataWykup: 0.0070 },
        EDO: { okres: 120, oprocentowanie: 6.50, marza: 1.25, kapitalizacja: true, oplataWykup: 0.0150 },
        ROS: { okres: 72, oprocentowanie: 5.90, marza: 1.00, kapitalizacja: false, oplataWykup: 0.0100 },
        ROD: { okres: 144, oprocentowanie: 6.10, marza: 1.50, kapitalizacja: true, oplataWykup: 0.0200 }
    };

    const nazwyObligacji = {
        OTS: "3-miesięcznych (OTS)",
        ROR: "1-rocznych (ROR)",
        DOR: "2-letnich (DOR)",
        TOS: "3-letnich (TOS)",
        COI: "4-letnich (COI)",
        EDO: "10-letnich (EDO)",
        ROS: "6-letnich (ROS)",
        ROD: "12-letnich (ROD)"
    };

    const opisyObligacji = {
        OTS: "OTS (3-miesięczne): stałe oprocentowanie 3,00% na okres 3-miesiące, wypłata odsetek na koniec okresu. Wcześniejszy odkup powoduje nienaliczenie odsetek, natomiast nie ma opłat za wcześniejszy wykup. Idealne dla krótkoterminowych inwestycji.",
        ROR: "ROR (1-roczne): zmienne oprocentowanie oparte na stopie referencyjnej NBP, pierwsza rata 5,25%, następnie stopa + 0% marży. Wypłata odsetek na koniec okresu, opłata za wcześniejszy wykup: 0,70 zł za sztukę.",
        DOR: "DOR (2-letnie): zmienne oprocentowanie oparte na stopie referencyjnej NBP, pierwsza rata 5,50%, następnie stopa + 0,25% marży. Wypłata odsetek co 6 miesięcy, opłata za wcześniejszy wykup: 0,70 zł za sztukę.",
        TOS: "TOS (3-letnie): stałe oprocentowanie 5,85% na okres 3 lat, wypłata odsetek na koniec okresu. Brak opłat za wcześniejszy wykup.",
        COI: "COI (4-letnie): zmienne oprocentowanie oparte na inflacji, pierwsza rata 6,25%, następnie inflacja + 0,75% marży. Wypłata odsetek co roku, opłata za wcześniejszy wykup: 0,70 zł za sztukę.",
        EDO: "EDO (10-letnie): zmienne oprocentowanie oparte na inflacji, pierwsza rata 6,50%, następnie inflacja + 1,25% marży. Kapitalizacja odsetek, wypłata na koniec okresu, opłata za wcześniejszy wykup: 1,50 zł za sztukę.",
        ROS: "ROS (6-letnie): zmienne oprocentowanie oparte na inflacji, pierwsza rata 5,90%, następnie inflacja + 1,00% marży. Wypłata odsetek co roku, opłata za wcześniejszy wykup: 1,00 zł za sztukę. Dla rodzin 500+.",
        ROD: "ROD (12-letnie): zmienne oprocentowanie oparte na inflacji, pierwsza rata 6,10%, następnie inflacja + 1,50% marży. Kapitalizacja odsetek, wypłata na koniec okresu, opłata za wcześniejszy wykup: 2,00 zł za sztukę. Dla rodzin 500+."
    };

    function updateIloscObligacji() {
        const kwota = parseFloat(elements.kwota.value) || 0;
        const ilosc = Math.floor(kwota / 100);
        elements.iloscObligacji.textContent = `${ilosc} szt. (min. 1 szt., wielokrotność 100 zł)`;
    }

    function updateLata() {
        const typ = elements.typObligacji.value;
        const miesiace = obligacjeConfig[typ].okres;
        elements.lata.textContent = `${miesiace} miesięcy (${(miesiace / 12).toFixed(2)} lat)`;
    }

    function updateOprocentowanieInfo() {
        const typ = elements.typObligacji.value;
        const config = obligacjeConfig[typ];
        let info = `Pierwsza rata: ${config.oprocentowanie.toFixed(2)}%`;
        if (["COI", "EDO", "ROS", "ROD"].includes(typ)) {
            info += `, kolejne: inflacja + ${config.marza.toFixed(2)}% marży`;
        } else if (["ROR", "DOR"].includes(typ)) {
            info += `, kolejne: stopa referencyjna NBP + ${config.marza.toFixed(2)}% marży`;
        }
        elements.oprocentowanieInfo.textContent = info;
    }

    function updateOpisObligacji() {
        const typ = elements.typObligacji.value;
        elements.opisObligacji.innerHTML = opisyObligacji[typ] || "";
    }

    function updateDynamicRateField() {
        const typ = elements.typObligacji.value;
        const isInflacja = ["COI", "EDO", "ROS", "ROD"].includes(typ);
        const isStopa = ["ROR", "DOR"].includes(typ);
        elements.dynamicRateGroup.style.display = (isInflacja || isStopa) ? "block" : "none";
        elements.variableRateSection.style.display = (isInflacja || isStopa) ? "block" : "none";
        elements.inflacjaZmiennaBtn.style.display = isInflacja ? "inline" : "none";
        elements.stopaZmiennaBtn.style.display = isStopa ? "inline" : "none";
        elements.dynamicRate.value = isInflacja ? "4.90" : (isStopa ? "5.75" : "");
    }

    elements.kwota.addEventListener("input", updateIloscObligacji);
    elements.typObligacji.addEventListener("change", () => {
        updateIloscObligacji();
        updateLata();
        updateOprocentowanieInfo();
        updateOpisObligacji();
        updateDynamicRateField();
        state.variableInflacjaChanges = [];
        state.variableStopaChanges = [];
        elements.variableRateInputs.innerHTML = "";
    });
    elements.ikeIkzeMode.addEventListener("change", () => {
        state.isIkeIkzeMode = elements.ikeIkzeMode.checked;
    });
    elements.addVariableRate.addEventListener("click", () => {
        const typ = elements.typObligacji.value;
        const isInflacja = ["COI", "EDO", "ROS", "ROD"].includes(typ);
        const container = elements.variableRateInputs;
        const index = container.children.length + 1;
        const div = document.createElement("div");
        div.className = "variable-rate-input";
        div.innerHTML = `
            <label>Cykl ${index}:</label>
            <input type="number" class="cykl" min="2" placeholder="Cykl">
            <input type="number" class="wartosc" step="0.01" min="0" placeholder="${isInflacja ? 'Inflacja' : 'Stopa'} (%)">
            <button class="remove">Usuń</button>
        `;
        container.appendChild(div);

        const cyklInput = div.querySelector(".cykl");
        const wartoscInput = div.querySelector(".wartosc");
        const removeBtn = div.querySelector(".remove");

        function updateChanges() {
            const cykl = parseInt(cyklInput.value) || 0;
            const wartosc = parseFloat(wartoscInput.value) || 0;
            const changes = isInflacja ? state.variableInflacjaChanges : state.variableStopaChanges;
            const existingIndex = changes.findIndex(c => c.cykl === cykl);
            if (existingIndex >= 0) {
                changes[existingIndex].wartosc = wartosc;
            } else if (cykl > 1) {
                changes.push({ cykl, wartosc });
            }
        }

        cyklInput.addEventListener("input", updateChanges);
        wartoscInput.addEventListener("input", updateChanges);
        removeBtn.addEventListener("click", () => {
            const cykl = parseInt(cyklInput.value) || 0;
            const changes = isInflacja ? state.variableInflacjaChanges : state.variableStopaChanges;
            const index = changes.findIndex(c => c.cykl === cykl);
            if (index >= 0) changes.splice(index, 1);
            div.remove();
        });
    });
    elements.inflacjaZmiennaBtn.addEventListener("change", () => {
        elements.variableRateInputs.innerHTML = "";
        state.variableInflacjaChanges = [];
        if (!elements.inflacjaZmiennaBtn.checked) elements.stopaZmiennaBtn.checked = false;
    });
    elements.stopaZmiennaBtn.addEventListener("change", () => {
        elements.variableRateInputs.innerHTML = "";
        state.variableStopaChanges = [];
        if (!elements.stopaZmiennaBtn.checked) elements.inflacjaZmiennaBtn.checked = false;
    });
    elements.obliczBtn.addEventListener("click", obliczObligacje);
    elements.powrotBtn.addEventListener("click", () => {
        elements.formSection.style.display = "block";
        elements.resultSection.style.display = "none";
        if (state.chart) state.chart.destroy();
        if (state.chartLine) state.chartLine.destroy();
    });
    elements.generatePdfBtn.addEventListener("click", generatePdf);

    function obliczObligacje() {
        if (state.isCalculating) return;
        state.isCalculating = true;

        if (typeof Chart === "undefined") {
            console.error("Biblioteka Chart.js nie została załadowana.");
            alert("Błąd: Nie można załadować wykresów. Spróbuj ponownie później.");
            state.isCalculating = false;
            return;
        }

        const kwota = parseFloat(elements.kwota.value) || 0;
        const typ = elements.typObligacji.value;
        const config = obligacjeConfig[typ];
        const miesiace = config.okres;
        const dynamicRate = parseFloat(elements.dynamicRate.value) / 100 || (["COI", "EDO", "ROS", "ROD"].includes(typ) ? 0.0490 : 0.0575);
        const isInflacja = ["COI", "EDO", "ROS", "ROD"].includes(typ);
        const inflacjaZmienna = elements.inflacjaZmiennaBtn.checked && ["COI", "EDO", "ROS", "ROD"].includes(typ);
        const stopaZmienna = elements.stopaZmiennaBtn.checked && ["ROR", "DOR"].includes(typ);
        const inflacja = isInflacja ? dynamicRate : 0;
        const stopaRel = !isInflacja ? dynamicRate : 0.0575;
        const podatekBelki = state.isIkeIkzeMode ? 0 : 0.19;

        state.lastFormData = {
            kwota: kwota,
            typObligacji: typ,
            dynamicRate: dynamicRate * 100,
            okres: miesiace,
            oprocentowanie: config.oprocentowanie,
            ikeIkze: state.isIkeIkzeMode,
            isInflacja: isInflacja,
            inflacjaZmienna: inflacjaZmienna,
            stopaZmienna: stopaZmienna,
            variableInflacjaChanges: [...state.variableInflacjaChanges],
            variableStopaChanges: [...state.variableStopaChanges]
        };

        if (kwota < 100 || miesiace <= 0) {
            alert("Proszę wypełnić wszystkie wymagane pola poprawnymi wartościami.");
            state.isCalculating = false;
            return;
        }

        elements.resultHeader.textContent = `Wynik inwestycji dla obligacji ${nazwyObligacji[typ]}${state.isIkeIkzeMode ? " (IKE/IKZE)" : ""}`;
        const pierwszaKolumnaNaglowek = document.getElementById("pierwszaKolumnaNaglowek");
        const kolumnaStopaInflacja = document.getElementById("kolumnaStopaInflacja");
        const zyskKolumnaNaglowek = document.getElementById("zyskKolumnaNaglowek");

        if (["OTS", "ROR", "DOR"].includes(typ)) {
            pierwszaKolumnaNaglowek.textContent = "Miesiąc";
            kolumnaStopaInflacja.textContent = ["ROR", "DOR"].includes(typ) ? "Stopa Ref. NBP" : "Inflacja";
            kolumnaStopaInflacja.style.display = ["OTS"].includes(typ) ? "none" : "table-cell";
        } else {
            pierwszaKolumnaNaglowek.textContent = "Rok";
            kolumnaStopaInflacja.textContent = "Inflacja";
            kolumnaStopaInflacja.style.display = ["TOS"].includes(typ) ? "none" : "table-cell";
        }
        zyskKolumnaNaglowek.textContent = state.isIkeIkzeMode ? "Zysk" : "Zysk netto";

        let kapital = kwota;
        let odsetkiCalkowite = 0;
        let zyskNettoCalkowity = 0;
        state.harmonogramData = [];
        let skumulowaneOdsetki = 0;

        let liczbaCykli = ["OTS", "ROR", "DOR"].includes(typ) ? miesiace : miesiace / 12;
        let changes = inflacjaZmienna ? state.variableInflacjaChanges : (stopaZmienna ? state.variableStopaChanges : []);
        changes.sort((a, b) => a.cykl - b.cykl);

        for (let i = 1; i <= liczbaCykli; i++) {
            let okresWiersz = i;
            let changeApplied = false;
            let stopaRefLubInflacja = "-";

            let oprocentowanieRoczne;
            if (inflacjaZmienna || stopaZmienna) {
                let dynamicValue = (inflacjaZmienna ? 4.90 : 5.75) / 100;
                for (const change of changes) {
                    if (i >= change.cykl) {
                        dynamicValue = change.wartosc / 100;
                        if (i === change.cykl) changeApplied = true;
                    }
                }
                oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (dynamicValue + config.marza / 100);
                stopaRefLubInflacja = (dynamicValue * 100).toFixed(2) + "%";
            } else if (["COI", "EDO", "ROS", "ROD"].includes(typ)) {
                oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (inflacja + config.marza / 100);
                stopaRefLubInflacja = (inflacja * 100).toFixed(2) + "%";
            } else if (["ROR", "DOR"].includes(typ)) {
                oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (stopaRel + config.marza / 100);
                stopaRefLubInflacja = (stopaRel * 100).toFixed(2) + "%";
            } else {
                oprocentowanieRoczne = config.oprocentowanie / 100;
            }

            let oprocentowanieMiesieczne = oprocentowanieRoczne / 12;
            let miesiecyWCyklu = ["OTS", "ROR", "DOR"].includes(typ) ? 1 : 12;
            let odsetkiCykl = kapital * oprocentowanieMiesieczne * miesiecyWCyklu;

            let podatekCykl = odsetkiCykl * podatekBelki;
            let odsetkiNettoCykl = state.isIkeIkzeMode ? odsetkiCykl : (odsetkiCykl - podatekCykl);

            odsetkiCalkowite += odsetkiCykl;
            skumulowaneOdsetki += odsetkiCykl;
            zyskNettoCalkowity += odsetkiNettoCykl;

            let wartoscInwestycji = kwota;
            if (config.kapitalizacja) {
                kapital += odsetkiCykl;
                wartoscInwestycji = kapital;
            }

            let kwotaPoCyklu = state.isIkeIkzeMode ? (config.kapitalizacja ? wartoscInwestycji : kwota + zyskNettoCalkowity) : 
                (config.kapitalizacja ? (wartoscInwestycji - skumulowaneOdsetki * 0.19) : kwota + zyskNettoCalkowity);

            let oplataZaWykup = i < liczbaCykli ? kwota * config.oplataWykup : 0;

            state.harmonogramData.push({
                okres: okresWiersz,
                wartoscInwestycji: wartoscInwestycji.toFixed(2),
                oprocentowanieNaCykl: (oprocentowanieRoczne * 100).toFixed(2) + "%",
                odsetkiBrutto: odsetkiCykl.toFixed(2),
                skumulowaneOdsetki: skumulowaneOdsetki.toFixed(2),
                podatek: podatekCykl.toFixed(2),
                zyskNetto: odsetkiNettoCykl.toFixed(2),
                oplataZaWykup: oplataZaWykup.toFixed(2),
                stopaRefLubInflacja: stopaRefLubInflacja,
                kwotaPoZakonczeniuCyklu: kwotaPoCyklu.toFixed(2),
                changeApplied: changeApplied
            });
        }

        document.getElementById("valueKapital").textContent = `${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
        document.querySelector('.result-wrapper-chart .legend-item[data-index="0"] .color-box').setAttribute('data-tooltip', `Kapitał: ${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`);
        document.getElementById("valueOdsetki").textContent = `${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
        document.querySelector('.result-wrapper-chart .legend-item[data-index="1"] .color-box').setAttribute('data-tooltip', `Odsetki: ${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`);
        const podatekCalkowity = odsetkiCalkowite * (state.isIkeIkzeMode ? 0 : 0.19);
        document.getElementById("valuePodatek").textContent = `${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
        document.querySelector('.result-wrapper-chart .legend-item[data-index="2"] .color-box').setAttribute('data-tooltip', `Podatek: ${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`);
        document.getElementById("okresInwestycji").textContent = miesiace;
        document.querySelector('.result-wrapper-chart .highlight.yellow').setAttribute('data-hover', `${miesiace} miesięcy`);
        document.getElementById("zyskNetto").textContent = `${zyskNettoCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.querySelector('.result-wrapper-chart .highlight.green').setAttribute('data-hover', `${zyskNettoCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`);

        if (state.chart) state.chart.destroy();
        if (state.chartLine) state.chartLine.destroy();

        const ctx = elements.obligacjeChart.getContext("2d");
        state.chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Kapitał', 'Odsetki', 'Podatek'],
                datasets: [{
                    data: [kwota, odsetkiCalkowite, podatekCalkowity],
                    backgroundColor: ['#28a745', '#007bff', '#dc3545'],
                    borderWidth: 1,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });

        document.querySelectorAll('.result-wrapper-chart .legend-item').forEach(item => {
            item.addEventListener('mouseenter', function() {
                const index = parseInt(this.getAttribute('data-index'));
                state.chart.setActiveElements([{ datasetIndex: 0, index: index }]);
                state.chart.update();
                const currentLegend = document.querySelector(`#legend${['Kapital', 'Odsetki', 'Podatek'][index]}`);
                if (currentLegend) currentLegend.style.opacity = 0;
                const valueElements = document.querySelectorAll('#valueKapital, #valueOdsetki, #valuePodatek');
                valueElements.forEach((value, idx) => {
                    if (idx === index) value.textContent = `${['Kapitał', 'Odsetki', 'Podatek'][idx]}: ${value.textContent}`;
                });
            });

            item.addEventListener('mouseleave', function() {
                const index = parseInt(this.getAttribute('data-index'));
                state.chart.setActiveElements([]);
                state.chart.update();
                const currentLegend = document.querySelector(`#legend${['Kapital', 'Odsetki', 'Podatek'][index]}`);
                if (currentLegend) currentLegend.style.opacity = 1;
                document.getElementById("valueKapital").textContent = `${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
                document.getElementById("valueOdsetki").textContent = `${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
                document.getElementById("valuePodatek").textContent = `${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
            });
        });

        let tabela = document.getElementById("harmonogramTabela");
        tabela.innerHTML = "";
        state.harmonogramData.forEach(wiersz => {
            let rowHTML = `
                <tr>
                    <td>${wiersz.okres}</td>
                    <td>${parseFloat(wiersz.wartoscInwestycji).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                    <td>${wiersz.oprocentowanieNaCykl}${wiersz.changeApplied ? ' ★' : ''}</td>
                    <td>${parseFloat(wiersz.odsetkiBrutto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                    <td>${parseFloat(wiersz.skumulowaneOdsetki).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                    <td>${state.isIkeIkzeMode ? "0,00 zł*" : parseFloat(wiersz.podatek).toLocaleString('pl-PL', { minimumFractionDigits: 2 }) + " zł"}</td>
                    <td>${parseFloat(wiersz.zyskNetto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                    <td>${parseFloat(wiersz.oplataZaWykup).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
            `;
            if (!["OTS", "TOS"].includes(typ)) {
                rowHTML += `<td>${wiersz.stopaRefLubInflacja}</td>`;
            }
            rowHTML += `
                    <td>${parseFloat(wiersz.kwotaPoZakonczeniuCyklu).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                </tr>
            `;
            tabela.innerHTML += rowHTML;
        });

        if (state.isIkeIkzeMode) {
            document.getElementById("harmonogramOpis").innerHTML = "* Podatek wyniesie 0 zł po osiągnięciu wieku emerytalnego i 55 roku życia lub 60 roku życia w przypadku IKE oraz 10 % zryczałtowanego podatku po osiągnięciu 65 roku życia w przypadku IKZE.";
        } else {
            document.getElementById("harmonogramOpis").textContent = "";
        }

        const maxKwotaPoCyklu = Math.max(...state.harmonogramData.map(wiersz => parseFloat(wiersz.kwotaPoZakonczeniuCyklu)));
        const minKwota = kwota;
        const range = maxKwotaPoCyklu - minKwota;
        const padding = range * 0.1;
        const yMin = minKwota - padding;
        const yMax = maxKwotaPoCyklu + padding;
        const stepSize = range / 5;

        const ctxLine = elements.obligacjeChartLine.getContext("2d");
        state.chartLine = new Chart(ctxLine, {
            type: 'line',
            data: {
                labels: state.harmonogramData.map(wiersz => ["OTS", "ROR", "DOR"].includes(typ) ? `Miesiąc ${wiersz.okres}` : `Rok ${wiersz.okres}`),
                datasets: [
                    {
                        label: 'Zainwestowana kwota',
                        data: state.harmonogramData.map(() => kwota),
                        borderColor: '#8B7D47',
                        backgroundColor: 'rgba(139, 125, 71, 0.1)',
                        fill: false,
                        tension: 0,
                        borderWidth: 2
                    },
                    {
                        label: 'Kwota po zakończeniu cyklu',
                        data: state.harmonogramData.map(wiersz => parseFloat(wiersz.kwotaPoZakonczeniuCyklu)),
                        borderColor: '#D4C791',
                        backgroundColor: 'rgba(212, 199, 145, 0.2)',
                        fill: true,
                        tension: 0.1,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: ["OTS", "ROR", "DOR"].includes(typ) ? 'Okres (miesiące)' : 'Okres (lata)', font: { size: 14 } }, ticks: { font: { size: 12 } } },
                    y: { title: { display: true, text: 'Wartość (PLN)', font: { size: 14 } }, min: yMin, max: yMax, ticks: { stepSize: stepSize, font: { size: 12 } } }
                },
                plugins: { legend: { display: true, position: 'top', labels: { font: { size: 12 } } }, tooltip: { enabled: true, backgroundColor: 'rgba(0, 0, 0, 0.8)' } }
            }
        });

        elements.formSection.style.display = "none";
        elements.resultSection.style.display = "block";
        state.isCalculating = false;
    }

    function generatePdf() {
        if (typeof pdfMake === "undefined") {
            console.error("Biblioteka pdfMake nie została załadowana.");
            alert("Błąd: Biblioteka pdfMake nie jest załadowana.");
            return;
        }

        const typ = state.lastFormData.typObligacji;
        const nazwaObligacji = nazwyObligacji[typ];
        const headerText = `Wynik inwestycji dla obligacji ${nazwaObligacji}${state.isIkeIkzeMode ? " (IKE/IKZE)" : ""}`;
        const opis = opisyObligacji[typ] ? opisyObligacji[typ].replace(/<[^>]+>/g, "") : "";

        const summary = [
            `Kapitał: ${parseFloat(state.lastFormData.kwota).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
            `Odsetki: ${parseFloat(document.getElementById("valueOdsetki").textContent.replace(/[^\d,.]/g, "").replace(",", ".")).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
            `Podatek: ${parseFloat(document.getElementById("valuePodatek").textContent.replace(/[^\d,.]/g, "").replace(",", ".")).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
            `Okres inwestycji: ${state.lastFormData.okres} miesięcy`,
            `Zysk netto: ${parseFloat(document.getElementById("zyskNetto").textContent.replace(/[^\d,.]/g, "").replace(",", ".")).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`
        ];

        const headers = ["OTS", "ROR", "DOR"].includes(typ) ?
            ["Miesiąc", "Wartość inwestycji", "Oproc.", "Odsetki", "Suma odsetek", "Podatek", "Zysk netto", "Opłata za wykup", "Stopa Ref. NBP", "Suma netto"] :
            ["Rok", "Wartość inwestycji", "Oproc.", "Odsetki", "Suma odsetek", "Podatek", "Zysk netto", "Opłata za wykup", "Inflacja", "Suma netto"];
        if (["OTS", "TOS"].includes(typ)) headers.splice(8, 1);

        const tableData = state.harmonogramData.map(wiersz => {
            const row = [
                wiersz.okres.toString(),
                `${parseFloat(wiersz.wartoscInwestycji).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                wiersz.oprocentowanieNaCykl,
                `${parseFloat(wiersz.odsetkiBrutto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                `${parseFloat(wiersz.skumulowaneOdsetki).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                state.isIkeIkzeMode ? "0,00 zł*" : `${parseFloat(wiersz.podatek).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                `${parseFloat(wiersz.zyskNetto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                `${parseFloat(wiersz.oplataZaWykup).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`
            ];
            if (!["OTS", "TOS"].includes(typ)) row.push(wiersz.stopaRefLubInflacja);
            row.push(`${parseFloat(wiersz.kwotaPoZakonczeniuCyklu).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`);
            return row;
        });

        const lineChartCanvas = document.getElementById("obligacjeChartLine");
        const lineChartImage = lineChartCanvas.toDataURL("image/png");

        const docDefinition = {
            content: [
                { text: headerText, style: 'header' },
                { text: opis, style: 'subheader', margin: [0, 5, 0, 10] },
                { text: 'Podsumowanie:', style: 'subheader', margin: [0, 0, 0, 5] },
                {
                    ul: summary.map(line => ({ text: line, style: 'listItem' }))
                },
                {
                    table: {
                        headerRows: 1,
                        widths: headers.map(() => '*'),
                        body: [
                            headers.map(h => ({ text: h, style: 'tableHeader' })),
                            ...tableData
                        ]
                    },
                    margin: [0, 10, 0, 10]
                },
                state.isIkeIkzeMode ? {
                    text: "* Podatek wyniesie 0 zł po osiągnięciu wieku emerytalnego i 55 roku życia lub 60 roku życia w przypadku IKE oraz 10 % zryczałtowanego podatku po osiągnięciu 65 roku życia w przypadku IKZE.",
                    style: 'note',
                    margin: [0, 0, 0, 10]
                } : {},
                { text: 'Wykres liniowy wartości inwestycji w czasie', style: 'subheader', margin: [0, 0, 0, 5], pageBreak: tableData.length > 10 ? 'before' : 'none' },
                { image: lineChartImage, width: 500, height: 250, alignment: 'center' }
            ],
            styles: {
                header: { fontSize: 18, bold: true, margin: [0, 0, 0, 10] },
                subheader: { fontSize: 14, bold: true },
                listItem: { fontSize: 10, margin: [0, 2, 0, 2] },
                tableHeader: { fontSize: 10, bold: true, fillColor: '#c2b280', color: 'black', alignment: 'center' },
                note: { fontSize: 8, italics: true }
            },
            defaultStyle: { fontSize: 10 }
        };

        pdfMake.createPdf(docDefinition).download(`Wynik_inwestycji_${nazwaObligacji.replace(/\s+/g, "_")}.pdf`);
    }

    // Inicjalizacja
    updateIloscObligacji();
    updateLata();
    updateOprocentowanieInfo();
    updateOpisObligacji();
    updateDynamicRateField();
</script>
</body>
</html>
