<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Obligacji Skarbowych</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .form-section, .result-section {
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result-section {
            display: none;
        }
        .result-wrapper-chart {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        .chart-container {
            width: 50%;
        }
        .chart {
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }
        .chart-legend {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .color-box {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        .highlight {
            font-size: 1.2em;
            font-weight: bold;
        }
        .yellow {
            color: #ffc107;
        }
        .green {
            color: #28a745;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }
        th {
            background-color: #f8f9fa;
        }
        .harmonogram-opis {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }
        .variable-rate-section {
            display: none;
            margin-top: 20px;
        }
        .variable-rate-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Kalkulator Obligacji Skarbowych</h1>
        
        <div class="form-section" id="formSection">
            <div class="form-group">
                <label for="kwota">Kwota inwestycji (PLN):</label>
                <input type="number" id="kwota" min="100" step="100" value="1000">
            </div>
            <div class="form-group">
                <label for="typObligacji">Typ obligacji:</label>
                <select id="typObligacji">
                    <option value="OTS">3-miesięczne (OTS)</option>
                    <option value="ROR">1-roczne (ROR)</option>
                    <option value="DOR">2-letnie (DOR)</option>
                    <option value="TOS">3-letnie (TOS)</option>
                    <option value="COI">4-letnie (COI)</option>
                    <option value="EDO">10-letnie (EDO)</option>
                    <option value="ROS">6-letnie (ROS)</option>
                    <option value="ROD">12-letnie (ROD)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ilość sztuk:</label>
                <span id="iloscObligacji"></span>
            </div>
            <div class="form-group">
                <label>Okres inwestycji:</label>
                <span id="lata"></span>
            </div>
            <div class="form-group">
                <label>Oprocentowanie:</label>
                <span id="oprocentowanieInfo"></span>
            </div>
            <div class="form-group">
                <label>Opis:</label>
                <div id="opisObligacji"></div>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="ikeIkzeMode"> IKE/IKZE (bez podatku Belki)</label>
            </div>
            <div class="form-group" id="dynamicRateGroup" style="display: none;">
                <label for="dynamicRate">Inflacja lub stopa referencyjna NBP (%):</label>
                <input type="number" id="dynamicRate" step="0.01" min="0">
            </div>
            <div class="variable-rate-section" id="variableRateSection">
                <label><input type="checkbox" id="inflacjaZmiennaBtn"> Zmienna inflacja</label>
                <label><input type="checkbox" id="stopaZmiennaBtn"> Zmienna stopa referencyjna</label>
                <div id="variableRateInputs"></div>
                <button id="addVariableRate">Dodaj zmianę</button>
            </div>
            <button id="obliczBtn">Oblicz</button>
        </div>

        <div class="result-section" id="resultSection">
            <h2 id="resultHeader"></h2>
            <div class="result-wrapper-chart">
                <div class="chart-container">
                    <canvas id="obligacjeChart"></canvas>
                    <div class="chart-legend">
                        <div class="legend-item" data-index="0">
                            <div class="color-box" style="background-color: #28a745;" data-tooltip="Kapitał"></div>
                            <span id="legendKapital">Kapitał</span>
                        </div>
                        <div class="legend-item" data-index="1">
                            <div class="color-box" style="background-color: #007bff;" data-tooltip="Odsetki"></div>
                            <span id="legendOdsetki">Odsetki</span>
                        </div>
                        <div class="legend-item" data-index="2">
                            <div class="color-box" style="background-color: #dc3545;" data-tooltip="Podatek"></div>
                            <span id="legendPodatek">Podatek</span>
                        </div>
                    </div>
                    <p><strong>Kwota:</strong> <span id="valueKapital"></span></p>
                    <p><strong>Odsetki:</strong> <span id="valueOdsetki"></span></p>
                    <p><strong>Podatek:</strong> <span id="valuePodatek"></span></p>
                </div>
                <div class="chart-container">
                    <canvas id="obligacjeChartLine"></canvas>
                    <p>Okres inwestycji: <span class="highlight yellow" id="okresInwestycji"></span></p>
                    <p>Zysk netto: <span class="highlight green" id="zyskNetto"></span></p>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th id="pierwszaKolumnaNaglowek"></th>
                        <th>Wartość inwestycji</th>
                        <th>Oprocentowanie</th>
                        <th>Odsetki brutto</th>
                        <th>Skumulowane odsetki</th>
                        <th>Podatek</th>
                        <th id="zyskKolumnaNaglowek"></th>
                        <th>Opłata za wykup</th>
                        <th id="kolumnaStopaInflacja"></th>
                        <th>Suma netto</th>
                    </tr>
                </thead>
                <tbody id="harmonogramTabela"></tbody>
            </table>
            <div class="harmonogram-opis" id="harmonogramOpis"></div>
            <button id="generatePdfBtn">Generuj PDF</button>
            <button id="powrotBtn">Powrót</button>
        </div>
    </div>

    <script>
        const elements = {
            kwota: document.getElementById("kwota"),
            typObligacji: document.getElementById("typObligacji"),
            iloscObligacji: document.getElementById("iloscObligacji"),
            lata: document.getElementById("lata"),
            oprocentowanieInfo: document.getElementById("oprocentowanieInfo"),
            opisObligacji: document.getElementById("opisObligacji"),
            ikeIkzeMode: document.getElementById("ikeIkzeMode"),
            dynamicRate: document.getElementById("dynamicRate"),
            dynamicRateGroup: document.getElementById("dynamicRateGroup"),
            variableRateSection: document.getElementById("variableRateSection"),
            inflacjaZmiennaBtn: document.getElementById("inflacjaZmiennaBtn"),
            stopaZmiennaBtn: document.getElementById("stopaZmiennaBtn"),
            variableRateInputs: document.getElementById("variableRateInputs"),
            addVariableRate: document.getElementById("addVariableRate"),
            obliczBtn: document.getElementById("obliczBtn"),
            formSection: document.getElementById("formSection"),
            resultSection: document.getElementById("resultSection"),
            resultHeader: document.getElementById("resultHeader"),
            obligacjeChart: document.getElementById("obligacjeChart"),
            obligacjeChartLine: document.getElementById("obligacjeChartLine"),
            generatePdfBtn: document.getElementById("generatePdfBtn"),
            powrotBtn: document.getElementById("powrotBtn")
        };

        const state = {
            isIkeIkzeMode: false,
            isCalculating: false,
            chart: null,
            chartLine: null,
            harmonogramData: [],
            lastFormData: null,
            variableInflacjaChanges: [],
            variableStopaChanges: []
        };

        const obligacjeConfig = {
            OTS: { okres: 3, oprocentowanie: 3.00, marza: 0, kapitalizacja: false, oplataWykup: 0 },
            ROR: { okres: 12, oprocentowanie: 5.25, marza: 0, kapitalizacja: false, oplataWykup: 0.0070 },
            DOR: { okres: 24, oprocentowanie: 5.50, marza: 0.25, kapitalizacja: false, oplataWykup: 0.0070 },
            TOS: { okres: 36, oprocentowanie: 5.85, marza: 0, kapitalizacja: false, oplataWykup: 0 },
            COI: { okres: 48, oprocentowanie: 6.25, marza: 0.75, kapitalizacja: false, oplataWykup: 0.0070 },
            EDO: { okres: 120, oprocentowanie: 6.50, marza: 1.25, kapitalizacja: true, oplataWykup: 0.0150 },
            ROS: { okres: 72, oprocentowanie: 5.90, marza: 1.00, kapitalizacja: false, oplataWykup: 0.0100 },
            ROD: { okres: 144, oprocentowanie: 6.10, marza: 1.50, kapitalizacja: true, oplataWykup: 0.0200 }
        };

        const nazwyObligacji = {
            OTS: "3-miesięcznych (OTS)",
            ROR: "1-rocznych (ROR)",
            DOR: "2-letnich (DOR)",
            TOS: "3-letnich (TOS)",
            COI: "4-letnich (COI)",
            EDO: "10-letnich (EDO)",
            ROS: "6-letnich (ROS)",
            ROD: "12-letnich (ROD)"
        };

        const opisyObligacji = {
            OTS: "OTS (3-miesięczne): stałe oprocentowanie 3,00% na okres 3-miesiące, wypłata odsetek na koniec okresu. Wcześniejszy odkup powoduje nienaliczenie odsetek, natomiast nie ma opłat za wcześniejszy wykup. Idealne dla krótkoterminowych inwestycji.",
            ROR: "ROR (1-roczne): zmienne oprocentowanie oparte na stopie referencyjnej NBP, pierwsza rata 5,25%, następnie stopa + 0% marży. Wypłata odsetek na koniec okresu, opłata za wcześniejszy wykup: 0,70 zł za sztukę.",
            DOR: "DOR (2-letnie): zmienne oprocentowanie oparte na stopie referencyjnej NBP, pierwsza rata 5,50%, następnie stopa + 0,25% marży. Wypłata odsetek co 6 miesięcy, opłata za wcześniejszy wykup: 0,70 zł za sztukę.",
            TOS: "TOS (3-letnie): stałe oprocentowanie 5,85% na okres 3 lat, wypłata odsetek na koniec okresu. Brak opłat za wcześniejszy wykup.",
            COI: "COI (4-letnie): zmienne oprocentowanie oparte na inflacji, pierwsza rata 6,25%, następnie inflacja + 0,75% marży. Wypłata odsetek co roku, opłata za wcześniejszy wykup: 0,70 zł za sztukę.",
            EDO: "EDO (10-letnie): zmienne oprocentowanie oparte na inflacji, pierwsza rata 6,50%, następnie inflacja + 1,25% marży. Kapitalizacja odsetek, wypłata na koniec okresu, opłata za wcześniejszy wykup: 1,50 zł za sztukę.",
            ROS: "ROS (6-letnie): zmienne oprocentowanie oparte na inflacji, pierwsza rata 5,90%, następnie inflacja + 1,00% marży. Wypłata odsetek co roku, opłata za wcześniejszy wykup: 1,00 zł za sztukę. Dla rodzin 500+.",
            ROD: "ROD (12-letnie): zmienne oprocentowanie oparte na inflacji, pierwsza rata 6,10%, następnie inflacja + 1,50% marży. Kapitalizacja odsetek, wypłata na koniec okresu, opłata za wcześniejszy wykup: 2,00 zł za sztukę. Dla rodzin 500+."
        };

        function updateIloscObligacji() {
            const kwota = parseFloat(elements.kwota.value) || 0;
            const ilosc = Math.floor(kwota / 100);
            elements.iloscObligacji.textContent = `${ilosc} szt. (min. 1 szt., wielokrotność 100 zł)`;
        }

        function updateLata() {
            const typ = elements.typObligacji.value;
            const miesiace = obligacjeConfig[typ].okres;
            elements.lata.textContent = `${miesiace} miesięcy (${(miesiace / 12).toFixed(2)} lat)`;
        }

        function updateOprocentowanieInfo() {
            const typ = elements.typObligacji.value;
            const config = obligacjeConfig[typ];
            let info = `Pierwsza rata: ${config.oprocentowanie.toFixed(2)}%`;
            if (["COI", "EDO", "ROS", "ROD"].includes(typ)) {
                info += `, kolejne: inflacja + ${config.marza.toFixed(2)}% marży`;
            } else if (["ROR", "DOR"].includes(typ)) {
                info += `, kolejne: stopa referencyjna NBP + ${config.marza.toFixed(2)}% marży`;
            }
            elements.oprocentowanieInfo.textContent = info;
        }

        function updateOpisObligacji() {
            const typ = elements.typObligacji.value;
            elements.opisObligacji.innerHTML = opisyObligacji[typ] || "";
        }

        function updateDynamicRateField() {
            const typ = elements.typObligacji.value;
            const isInflacja = ["COI", "EDO", "ROS", "ROD"].includes(typ);
            const isStopa = ["ROR", "DOR"].includes(typ);
            elements.dynamicRateGroup.style.display = (isInflacja || isStopa) ? "block" : "none";
            elements.variableRateSection.style.display = (isInflacja || isStopa) ? "block" : "none";
            elements.inflacjaZmiennaBtn.style.display = isInflacja ? "inline" : "none";
            elements.stopaZmiennaBtn.style.display = isStopa ? "inline" : "none";
            elements.dynamicRate.value = isInflacja ? "4.90" : (isStopa ? "5.75" : "");
        }

        elements.kwota.addEventListener("input", () => {
            updateIloscObligacji();
        });

        elements.typObligacji.addEventListener("change", () => {
            updateIloscObligacji();
            updateLata();
            updateOprocentowanieInfo();
            updateOpisObligacji();
            updateDynamicRateField();
            state.variableInflacjaChanges = [];
            state.variableStopaChanges = [];
            elements.variableRateInputs.innerHTML = "";
        });

        elements.ikeIkzeMode.addEventListener("change", () => {
            state.isIkeIkzeMode = elements.ikeIkzeMode.checked;
        });

        elements.addVariableRate.addEventListener("click", () => {
            const typ = elements.typObligacji.value;
            const isInflacja = ["COI", "EDO", "ROS", "ROD"].includes(typ);
            const container = elements.variableRateInputs;
            const index = container.children.length + 1;
            const div = document.createElement("div");
            div.className = "variable-rate-input";
            div.innerHTML = `
                <label>Cykl ${index}:</label>
                <input type="number" class="cykl" min="2" placeholder="Cykl">
                <input type="number" class="wartosc" step="0.01" min="0" placeholder="${isInflacja ? 'Inflacja' : 'Stopa'} (%)">
                <button class="remove">Usuń</button>
            `;
            container.appendChild(div);

            const cyklInput = div.querySelector(".cykl");
            const wartoscInput = div.querySelector(".wartosc");
            const removeBtn = div.querySelector(".remove");

            function updateChanges() {
                const cykl = parseInt(cyklInput.value) || 0;
                const wartosc = parseFloat(wartoscInput.value) || 0;
                const changes = isInflacja ? state.variableInflacjaChanges : state.variableStopaChanges;
                const existingIndex = changes.findIndex(c => c.cykl === cykl);
                if (existingIndex >= 0) {
                    changes[existingIndex].wartosc = wartosc;
                } else if (cykl > 1) {
                    changes.push({ cykl, wartosc });
                }
            }

            cyklInput.addEventListener("input", updateChanges);
            wartoscInput.addEventListener("input", updateChanges);
            removeBtn.addEventListener("click", () => {
                const cykl = parseInt(cyklInput.value) || 0;
                const changes = isInflacja ? state.variableInflacjaChanges : state.variableStopaChanges;
                const index = changes.findIndex(c => c.cykl === cykl);
                if (index >= 0) changes.splice(index, 1);
                div.remove();
            });
        });

        elements.inflacjaZmiennaBtn.addEventListener("change", () => {
            elements.variableRateInputs.innerHTML = "";
            state.variableInflacjaChanges = [];
            if (!elements.inflacjaZmiennaBtn.checked) elements.stopaZmiennaBtn.checked = false;
        });

        elements.stopaZmiennaBtn.addEventListener("change", () => {
            elements.variableRateInputs.innerHTML = "";
            state.variableStopaChanges = [];
            if (!elements.stopaZmiennaBtn.checked) elements.inflacjaZmiennaBtn.checked = false;
        });

        elements.obliczBtn.addEventListener("click", obliczObligacje);
        elements.powrotBtn.addEventListener("click", () => {
            elements.formSection.style.display = "block";
            elements.resultSection.style.display = "none";
            if (state.chart) state.chart.destroy();
            if (state.chartLine) state.chartLine.destroy();
        });

        elements.generatePdfBtn.addEventListener("click", generatePdf);

        function obliczObligacje() {
            if (state.isCalculating) return;
            state.isCalculating = true;

            if (typeof Chart === "undefined") {
                console.error("Biblioteka Chart.js nie została załadowana.");
                alert("Błąd: Nie można załadować wykresów. Spróbuj ponownie później.");
                state.isCalculating = false;
                return;
            }

            const kwota = parseFloat(elements.kwota.value) || 0;
            const typ = elements.typObligacji.value;
            const config = obligacjeConfig[typ];
            const miesiace = config.okres;
            const dynamicRate = parseFloat(elements.dynamicRate.value) / 100 || (["COI", "EDO", "ROS", "ROD"].includes(typ) ? 0.0490 : 0.0575);
            const isInflacja = ["COI", "EDO", "ROS", "ROD"].includes(typ);
            const inflacjaZmienna = elements.inflacjaZmiennaBtn.checked && ["COI", "EDO", "ROS", "ROD"].includes(typ);
            const stopaZmienna = elements.stopaZmiennaBtn.checked && ["ROR", "DOR"].includes(typ);
            const inflacja = isInflacja ? dynamicRate : 0;
            const stopaRel = !isInflacja ? dynamicRate : 0.0575;
            const podatekBelki = state.isIkeIkzeMode ? 0 : 0.19;

            state.lastFormData = {
                kwota: kwota,
                typObligacji: typ,
                dynamicRate: dynamicRate * 100,
                okres: miesiace,
                oprocentowanie: config.oprocentowanie,
                ikeIkze: state.isIkeIkzeMode,
                isInflacja: isInflacja,
                inflacjaZmienna: inflacjaZmienna,
                stopaZmienna: stopaZmienna,
                variableInflacjaChanges: [...state.variableInflacjaChanges],
                variableStopaChanges: [...state.variableStopaChanges]
            };

            if (kwota < 100 || miesiace <= 0) {
                alert("Proszę wypełnić wszystkie wymagane pola poprawnymi wartościami.");
                state.isCalculating = false;
                return;
            }

            elements.resultHeader.textContent = `Wynik inwestycji dla obligacji ${nazwyObligacji[typ]}${state.isIkeIkzeMode ? " (IKE/IKZE)" : ""}`;
            const pierwszaKolumnaNaglowek = document.getElementById("pierwszaKolumnaNaglowek");
            const kolumnaStopaInflacja = document.getElementById("kolumnaStopaInflacja");
            const zyskKolumnaNaglowek = document.getElementById("zyskKolumnaNaglowek");

            if (["OTS", "ROR", "DOR"].includes(typ)) {
                pierwszaKolumnaNaglowek.textContent = "Miesiąc";
                kolumnaStopaInflacja.textContent = ["ROR", "DOR"].includes(typ) ? "Stopa Ref. NBP" : "Inflacja";
                kolumnaStopaInflacja.style.display = ["OTS"].includes(typ) ? "none" : "table-cell";
            } else {
                pierwszaKolumnaNaglowek.textContent = "Rok";
                kolumnaStopaInflacja.textContent = "Inflacja";
                kolumnaStopaInflacja.style.display = ["TOS"].includes(typ) ? "none" : "table-cell";
            }
            zyskKolumnaNaglowek.textContent = state.isIkeIkzeMode ? "Zysk" : "Zysk netto";

            let kapital = kwota;
            let odsetkiCalkowite = 0;
            let zyskNettoCalkowity = 0;
            state.harmonogramData = [];
            let skumulowaneOdsetki = 0;

            let liczbaCykli = ["OTS", "ROR", "DOR"].includes(typ) ? miesiace : miesiace / 12;
            let changes = inflacjaZmienna ? state.variableInflacjaChanges : (stopaZmienna ? state.variableStopaChanges : []);
            changes.sort((a, b) => a.cykl - b.cykl);

            for (let i = 1; i <= liczbaCykli; i++) {
                let okresWiersz = i;
                let changeApplied = false;
                let stopaRefLubInflacja = "-";

                let oprocentowanieRoczne;
                if (inflacjaZmienna || stopaZmienna) {
                    let dynamicValue = (inflacjaZmienna ? 4.90 : 5.75) / 100;
                    for (const change of changes) {
                        if (i >= change.cykl) {
                            dynamicValue = change.wartosc / 100;
                            if (i === change.cykl) changeApplied = true;
                        }
                    }
                    oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (dynamicValue + config.marza / 100);
                    stopaRefLubInflacja = (dynamicValue * 100).toFixed(2) + "%";
                } else if (["COI", "EDO", "ROS", "ROD"].includes(typ)) {
                    oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (inflacja + config.marza / 100);
                    stopaRefLubInflacja = (inflacja * 100).toFixed(2) + "%";
                } else if (["ROR", "DOR"].includes(typ)) {
                    oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (stopaRel + config.marza / 100);
                    stopaRefLubInflacja = (stopaRel * 100).toFixed(2) + "%";
                } else {
                    oprocentowanieRoczne = config.oprocentowanie / 100;
                }

                let oprocentowanieMiesieczne = oprocentowanieRoczne / 12;
                let miesiecyWCyklu = ["OTS", "ROR", "DOR"].includes(typ) ? 1 : 12;
                let odsetkiCykl = kapital * oprocentowanieMiesieczne * miesiecyWCyklu;

                let podatekCykl = odsetkiCykl * podatekBelki;
                let odsetkiNettoCykl = state.isIkeIkzeMode ? odsetkiCykl : (odsetkiCykl - podatekCykl);

                odsetkiCalkowite += odsetkiCykl;
                skumulowaneOdsetki += odsetkiCykl;
                zyskNettoCalkowity += odsetkiNettoCykl;

                let wartoscInwestycji = kwota;
                if (config.kapitalizacja) {
                    kapital += odsetkiCykl;
                    wartoscInwestycji = kapital;
                }

                let kwotaPoCyklu = state.isIkeIkzeMode ? (config.kapitalizacja ? wartoscInwestycji : kwota + zyskNettoCalkowity) : 
                    (config.kapitalizacja ? (wartoscInwestycji - skumulowaneOdsetki * 0.19) : kwota + zyskNettoCalkowity);

                let oplataZaWykup = i < liczbaCykli ? kwota * config.oplataWykup : 0;

                state.harmonogramData.push({
                    okres: okresWiersz,
                    wartoscInwestycji: wartoscInwestycji.toFixed(2),
                    oprocentowanieNaCykl: (oprocentowanieRoczne * 100).toFixed(2) + "%",
                    odsetkiBrutto: odsetkiCykl.toFixed(2),
                    skumulowaneOdsetki: skumulowaneOdsetki.toFixed(2),
                    podatek: podatekCykl.toFixed(2),
                    zyskNetto: odsetkiNettoCykl.toFixed(2),
                    oplataZaWykup: oplataZaWykup.toFixed(2),
                    stopaRefLubInflacja: stopaRefLubInflacja,
                    kwotaPoZakonczeniuCyklu: kwotaPoCyklu.toFixed(2),
                    changeApplied: changeApplied
                });
            }

            document.getElementById("valueKapital").textContent = `${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
            document.querySelector('.result-wrapper-chart .legend-item[data-index="0"] .color-box').setAttribute('data-tooltip', `Kapitał: ${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`);
            document.getElementById("valueOdsetki").textContent = `${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
            document.querySelector('.result-wrapper-chart .legend-item[data-index="1"] .color-box').setAttribute('data-tooltip', `Odsetki: ${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`);
            const podatekCalkowity = odsetkiCalkowite * (state.isIkeIkzeMode ? 0 : 0.19);
            document.getElementById("valuePodatek").textContent = `${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
            document.querySelector('.result-wrapper-chart .legend-item[data-index="2"] .color-box').setAttribute('data-tooltip', `Podatek: ${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`);
            document.getElementById("okresInwestycji").textContent = miesiace;
            document.querySelector('.result-wrapper-chart .highlight.yellow').setAttribute('data-hover', `${miesiace} miesięcy`);
            document.getElementById("zyskNetto").textContent = `${zyskNettoCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.querySelector('.result-wrapper-chart .highlight.green').setAttribute('data-hover', `${zyskNettoCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`);

            if (state.chart) state.chart.destroy();
            if (state.chartLine) state.chartLine.destroy();

            const ctx = elements.obligacjeChart.getContext("2d");
            state.chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Kapitał', 'Odsetki', 'Podatek'],
                    datasets: [{
                        data: [kwota, odsetkiCalkowite, podatekCalkowity],
                        backgroundColor: ['#28a745', '#007bff', '#dc3545'],
                        borderWidth: 1,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            document.querySelectorAll('.result-wrapper-chart .legend-item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    state.chart.setActiveElements([{ datasetIndex: 0, index: index }]);
                    state.chart.update();
                    const currentLegend = document.querySelector(`#legend${['Kapital', 'Odsetki', 'Podatek'][index]}`);
                    if (currentLegend) currentLegend.style.opacity = 0;
                    const valueElements = document.querySelectorAll('#valueKapital, #valueOdsetki, #valuePodatek');
                    valueElements.forEach((value, idx) => {
                        if (idx === index) value.textContent = `${['Kapitał', 'Odsetki', 'Podatek'][idx]}: ${value.textContent}`;
                    });
                });

                item.addEventListener('mouseleave', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    state.chart.setActiveElements([]);
                    state.chart.update();
                    const currentLegend = document.querySelector(`#legend${['Kapital', 'Odsetki', 'Podatek'][index]}`);
                    if (currentLegend) currentLegend.style.opacity = 1;
                    document.getElementById("valueKapital").textContent = `${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
                    document.getElementById("valueOdsetki").textContent = `${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
                    document.getElementById("valuePodatek").textContent = `${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} zł`;
                });
            });

            let tabela = document.getElementById("harmonogramTabela");
            tabela.innerHTML = "";
            state.harmonogramData.forEach(wiersz => {
                let rowHTML = `
                    <tr>
                        <td>${wiersz.okres}</td>
                        <td>${parseFloat(wiersz.wartoscInwestycji).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                        <td>${wiersz.oprocentowanieNaCykl}${wiersz.changeApplied ? ' ★' : ''}</td>
                        <td>${parseFloat(wiersz.odsetkiBrutto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                        <td>${parseFloat(wiersz.skumulowaneOdsetki).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                        <td>${state.isIkeIkzeMode ? "0,00 zł*" : parseFloat(wiersz.podatek).toLocaleString('pl-PL', { minimumFractionDigits: 2 }) + " zł"}</td>
                        <td>${parseFloat(wiersz.zyskNetto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                        <td>${parseFloat(wiersz.oplataZaWykup).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                `;
                if (!["OTS", "TOS"].includes(typ)) {
                    rowHTML += `<td>${wiersz.stopaRefLubInflacja}</td>`;
                }
                rowHTML += `
                        <td>${parseFloat(wiersz.kwotaPoZakonczeniuCyklu).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł</td>
                    </tr>
                `;
                tabela.innerHTML += rowHTML;
            });

            if (state.isIkeIkzeMode) {
                document.getElementById("harmonogramOpis").innerHTML = "* Podatek wyniesie 0 zł po osiągnięciu wieku emerytalnego i 55 roku życia lub 60 roku życia w przypadku IKE oraz 10 % zryczałtowanego podatku po osiągnięciu 65 roku życia w przypadku IKZE.";
            } else {
                document.getElementById("harmonogramOpis").textContent = "";
            }

            const maxKwotaPoCyklu = Math.max(...state.harmonogramData.map(wiersz => parseFloat(wiersz.kwotaPoZakonczeniuCyklu)));
            const minKwota = kwota;
            const range = maxKwotaPoCyklu - minKwota;
            const padding = range * 0.1;
            const yMin = minKwota - padding;
            const yMax = maxKwotaPoCyklu + padding;
            const stepSize = range / 5;

            const ctxLine = elements.obligacjeChartLine.getContext("2d");
            state.chartLine = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: state.harmonogramData.map(wiersz => ["OTS", "ROR", "DOR"].includes(typ) ? `Miesiąc ${wiersz.okres}` : `Rok ${wiersz.okres}`),
                    datasets: [
                        {
                            label: 'Zainwestowana kwota',
                            data: state.harmonogramData.map(() => kwota),
                            borderColor: '#8B7D47',
                            backgroundColor: 'rgba(139, 125, 71, 0.1)',
                            fill: false,
                            tension: 0,
                            borderWidth: 2
                        },
                        {
                            label: 'Kwota po zakończeniu cyklu',
                            data: state.harmonogramData.map(wiersz => parseFloat(wiersz.kwotaPoZakonczeniuCyklu)),
                            borderColor: '#D4C791',
                            backgroundColor: 'rgba(212, 199, 145, 0.2)',
                            fill: true,
                            tension: 0.1,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: ["OTS", "ROR", "DOR"].includes(typ) ? 'Okres (miesiące)' : 'Okres (lata)', font: { size: 14 } }, ticks: { font: { size: 12 } } },
                        y: { title: { display: true, text: 'Wartość (PLN)', font: { size: 14 } }, min: yMin, max: yMax, ticks: { stepSize: stepSize, font: { size: 12 } } }
                    },
                    plugins: { legend: { display: true, position: 'top', labels: { font: { size: 12 } } }, tooltip: { enabled: true, backgroundColor: 'rgba(0, 0, 0, 0.8)' } }
                }
            });

            elements.formSection.style.display = "none";
            elements.resultSection.style.display = "block";
            state.isCalculating = false;
        }

        function generatePdf() {
            if (typeof pdfMake === "undefined") {
                console.error("Biblioteka pdfMake nie została załadowana.");
                alert("Błąd: Biblioteka pdfMake nie jest załadowana.");
                return;
            }

            const typ = state.lastFormData.typObligacji;
            const nazwaObligacji = nazwyObligacji[typ];
            const headerText = `Wynik inwestycji dla obligacji ${nazwaObligacji}${state.isIkeIkzeMode ? " (IKE/IKZE)" : ""}`;
            const opis = opisyObligacji[typ] ? opisyObligacji[typ].replace(/<[^>]+>/g, "") : "";

            const summary = [
                `Kapitał: ${parseFloat(state.lastFormData.kwota).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                `Odsetki: ${parseFloat(document.getElementById("valueOdsetki").textContent.replace(/[^\d,.]/g, "").replace(",", ".")).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                `Podatek: ${parseFloat(document.getElementById("valuePodatek").textContent.replace(/[^\d,.]/g, "").replace(",", ".")).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                `Okres inwestycji: ${state.lastFormData.okres} miesięcy`,
                `Zysk netto: ${parseFloat(document.getElementById("zyskNetto").textContent.replace(/[^\d,.]/g, "").replace(",", ".")).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`
            ];

            const headers = ["OTS", "ROR", "DOR"].includes(typ) ?
                ["Miesiąc", "Wartość inwestycji", "Oproc.", "Odsetki", "Suma odsetek", "Podatek", "Zysk netto", "Opłata za wykup", "Stopa Ref. NBP", "Suma netto"] :
                ["Rok", "Wartość inwestycji", "Oproc.", "Odsetki", "Suma odsetek", "Podatek", "Zysk netto", "Opłata za wykup", "Inflacja", "Suma netto"];
            if (["OTS", "TOS"].includes(typ)) headers.splice(8, 1);

            const tableData = state.harmonogramData.map(wiersz => {
                const row = [
                    wiersz.okres.toString(),
                    `${parseFloat(wiersz.wartoscInwestycji).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                    wiersz.oprocentowanieNaCykl,
                    `${parseFloat(wiersz.odsetkiBrutto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                    `${parseFloat(wiersz.skumulowaneOdsetki).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                    state.isIkeIkzeMode ? "0,00 zł*" : `${parseFloat(wiersz.podatek).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                    `${parseFloat(wiersz.zyskNetto).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`,
                    `${parseFloat(wiersz.oplataZaWykup).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`
                ];
                if (!["OTS", "TOS"].includes(typ)) row.push(wiersz.stopaRefLubInflacja);
                row.push(`${parseFloat(wiersz.kwotaPoZakonczeniuCyklu).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`);
                return row;
            });

            const lineChartCanvas = document.getElementById("obligacjeChartLine");
            const lineChartImage = lineChartCanvas.toDataURL("image/png");

            const docDefinition = {
                content: [
                    { text: headerText, style: 'header' },
                    { text: opis, style: 'subheader', margin: [0, 5, 0, 10] },
                    { text: 'Podsumowanie:', style: 'subheader', margin: [0, 0, 0, 5] },
                    {
                        ul: summary.map(line => ({ text: line, style: 'listItem' }))
                    },
                    {
                        table: {
                            headerRows: 1,
                            widths: headers.map(() => '*'),
                            body: [
                                headers.map(h => ({ text: h, style: 'tableHeader' })),
                                ...tableData
                            ]
                        },
                        margin: [0, 10, 0, 10]
                    },
                    state.isIkeIkzeMode ? {
                        text: "* Podatek wyniesie 0 zł po osiągnięciu wieku emerytalnego i 55 roku życia lub 60 roku życia w przypadku IKE oraz 10 % zryczałtowanego podatku po osiągnięciu 65 roku życia w przypadku IKZE.",
                        style: 'note',
                        margin: [0, 0, 0, 10]
                    } : {},
                    { text: 'Wykres liniowy wartości inwestycji w czasie', style: 'subheader', margin: [0, 0, 0, 5], pageBreak: tableData.length > 10 ? 'before' : 'none' },
                    { image: lineChartImage, width: 500, height: 250, alignment: 'center' }
                ],
                styles: {
                    header: { fontSize: 18, bold: true, margin: [0, 0, 0, 10] },
                    subheader: { fontSize: 14, bold: true },
                    listItem: { fontSize: 10, margin: [0, 2, 0, 2] },
                    tableHeader: { fontSize: 10, bold: true, fillColor: '#c2b280', color: 'black', alignment: 'center' },
                    note: { fontSize: 8, italics: true }
                },
                defaultStyle: { fontSize: 10 }
            };

            pdfMake.createPdf(docDefinition).download(`Wynik_inwestycji_${nazwaObligacji.replace(/\s+/g, "_")}.pdf`);
        }

        // Inicjalizacja
        updateIloscObligacji();
        updateLata();
        updateOprocentowanieInfo();
        updateOpisObligacji();
        updateDynamicRateField();
    </script>
</body>
</html>
