<body>
    <div class="container">
        <div class="form-section" id="formSection">
            <div class="header-row">
                <h4>Kalkulator Obligacji Skarbu Państwa</h4>
                <label class="checkbox-label">
                    <input type="checkbox" id="ikeIkzeBtn">
                    <span class="checkbox-custom"></span>
                    Inwestycje w IKE lub IKZE
                </label>
            </div>
            <div class="form-container">
                <div class="form-wrapper">
                    <form id="obligacjeForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="kwota" class="form-label">Kwota inwestycji</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="kwota" min="100" max="5000000" step="100" value="10000">
                                    <span class="input-group-text">zł</span>
                                </div>
                                <input type="range" class="form-range" id="kwotaRange" min="100" max="5000000" step="100" value="10000">
                                <div class="sub-info" id="iloscObligacji">Ilość obligacji: 100</div>
                            </div>
                            <div class="form-group">
                                <label for="typObligacji" class="form-label">Typ obligacji*</label>
                                <select class="form-control" id="typObligacji">
                                    <option value="OTS" selected>3-miesięczne (OTS)</option>
                                    <option value="ROR">12-miesięczne (ROR)</option>
                                    <option value="DOR">24-miesięczne (DOR)</option>
                                    <option value="TOS">3-letnie (TOS)</option>
                                    <option value="COI">4-letnie (COI)</option>
                                    <option value="EDO">10-letnie (EDO)</option>
                                    <option value="ROS">6-letnie (ROS)</option>
                                    <option value="ROD">12-letnie (ROD)</option>
                                </select>
                                <div class="sub-info"></div>
                            </div>
                            <div class="form-group" id="dynamicRateGroup" style="display: none;">
                                <label for="dynamicRate" class="form-label" id="dynamicRateLabel">Stopa Ref. NBP</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="dynamicRate" min="0" max="50" step="0.05" value="5.75">
                                    <span class="input-group-text">%</span>
                                </div>
                                <input type="range" class="form-range" id="dynamicRateRange" min="0" max="50" step="0.05" value="5.75">
                                <div class="sub-info"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="okres" class="form-label">Okres inwestycji</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="okres" min="3" max="144" step="1" value="3" readonly>
                                    <span class="input-group-text">mc-y</span>
                                </div>
                                <div class="sub-info" id="lata"></div>
                            </div>
                            <div class="form-group">
                                <label for="oprocentowanie" class="form-label">Oprocentowanie</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="oprocentowanie" min="0.1" max="25" step="0.1" value="3" readonly>
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="sub-info" id="oprocentowanieInfo"></div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="variable-rate-container">
                <div class="checkbox-row">
                    <label class="checkbox-label" id="inflacjaZmiennaLabel" style="display: none;">
                        <input type="checkbox" id="inflacjaZmiennaBtn">
                        <span class="checkbox-custom"></span>
                        Inflacja zmienna
                    </label>
                    <label class="checkbox-label" id="stopaZmiennaLabel" style="display: none;">
                        <input type="checkbox" id="stopaZmiennaBtn">
                        <span class="checkbox-custom"></span>
                        Zmienna Stopa Ref. NBP
                    </label>
                </div>
                <div class="variable-inputs" id="variableInputs" style="display: none;">
                    <div class="variable-inputs-wrapper" id="variableInputsWrapper"></div>
                    <button type="button" class="btn btn-secondary btn-sm" id="addVariableBtn" style="display: none;">Dodaj kolejne</button>
                </div>
            </div>
            <div class="form-row">
                <button type="button" class="btn btn-primary" id="obliczBtn">Oblicz</button>
            </div>
        </div>
        <div class="result-section" id="resultSection">
            <div class="result-header">
                <h4 id="resultHeader">Podsumowanie wyników</h4>
                <button id="generatePdfBtn" class="btn btn-primary btn-sm">Generuj PDF</button>
            </div>
            <button class="btn btn-secondary mb-3" onclick="showForm()">Powrót do edycji</button>
            <div class="result-container">
                <div class="result-wrapper">
                    <div class="chart-container">
                        <div class="chart">
                            <canvas id="obligacjeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="harmonogram-container">
                <div class="result-wrapper">
                    <div class="harmonogram">
                        <h5 class="btn-toggle" onclick="toggleHarmonogram('harmonogramContent')">Harmonogram odsetek ▼</h5>
                        <div id="harmonogramContent">
                            <table class="table table-striped">
                                <thead id="harmonogramNaglowek">
                                    <tr>
                                        <th id="pierwszaKolumnaNaglowek">Okres</th>
                                        <th>Wartość inwestycji</th>
                                        <th>Oproc.</th>
                                        <th>Odsetki</th>
                                        <th>Suma odsetek</th>
                                        <th>Podatek</th>
                                        <th id="zyskKolumnaNaglowek">Zysk netto</th>
                                        <th>Opłata za wykup</th>
                                        <th id="kolumnaStopaInflacja">Inflacja/Stopa</th>
                                        <th>Kwota za cykl</th>
                                    </tr>
                                </thead>
                                <tbody id="harmonogramTabela"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</body>
<style>
body {
    background-color: #f5f6f5;
    font-family: 'Montserrat', sans-serif;
    padding: 10px;
}
.logo-container {
    background-color: #e9ecef;
    padding: 15px;
    text-align: center;
    margin-bottom: 20px;
}
.logo {
    max-width: 200px;
    margin-bottom: 0;
    cursor: pointer;
}
.container {
    max-width: 1200px;
    margin: 30px auto 0;
    background: #FFFFFF;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
}
.header-row {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 15px;
    position: relative;
}
.header-row h4 {
    font-size: 1.2em;
    color: #333333;
    font-weight: 700;
    margin: 0;
}
.checkbox-label {
    position: absolute;
    top: 0;
    right: 10px;
    display: flex;
    align-items: center;
    font-size: 0.8em;
    color: #333333;
    cursor: pointer;
}
.checkbox-label input {
    display: none;
}
.checkbox-custom {
    width: 16px;
    height: 16px;
    border: 2px solid #C2B280;
    background-color: #fff;
    margin-right: 5px;
    display: inline-block;
    position: relative;
}
.checkbox-label input:checked + .checkbox-custom {
    background-color: #C2B280;
}
.checkbox-label input:checked + .checkbox-custom::after {
    content: '✔';
    color: #000;
    font-size: 12px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}
.form-section {
    padding: 10px;
    position: relative;
}
.form-row {
    display: flex;
    justify-content: center;
    margin-bottom: 10px;
    gap: 10px;
    align-items: flex-start;
}
.form-group {
    flex: 1;
    min-width: 0;
    max-width: 150px;
}
.form-label {
    font-size: 0.7em;
    text-transform: uppercase;
    margin-bottom: 2px;
    color: #333333;
}
.form-control, .form-select, .form-range {
    height: 22px;
    font-size: 0.7em;
    padding: 2px;
    text-align: center;
}
.form-select {
    max-width: 100px;
    appearance: none;
    background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAQ0lEQVR42mNgwAfKy8Q/Y//+Ii//3jVAYQzsIFyQ0dOaWq992zxcnN5+9NmyZACV40DmGhPZtzwUAxhUaoLntdha0DqQbtz4E9DzN6XgI0P2VYFlQrUwoQDIgbChLE/0awXiwV5rhugPX6A8BSsYFDqU+rEFdkGZA7+G9HMqaAU6l+0w+NdJD7ADhzhR/4KDZnWOw0QKrVqYc1G+1Dczfx8DR0uv+QJqDRvQxdizFAQAwsy39EZhAAAwAAJ4+Q1XFlAAAAABJRU5ErkJggg==') no-repeat right 5px center;
}
.form-range {
    margin-top: 2px;
    height: 8px;
    background: #d3d3d3;
    border-radius: 5px;
}
.form-range::-webkit-slider-thumb {
    background: #C2B280;
    border: none;
    border-radius: 50%;
    width: 12px;
    height: 12px;
    cursor: pointer;
    -webkit-appearance: none;
}
.form-range::-moz-range-thumb {
    background: #C2B280;
    border: none;
    border-radius: 50%;
    width: 12px;
    height: 12px;
    cursor: pointer;
}
.input-group-text {
    font-size: 0.7em;
    padding: 2px 5px;
}
.sub-info {
    font-size: 0.4em;
    color: #333333;
    margin-top: 2px;
    text-align: left;
}
.opis-container {
    margin-top: 20px;
    text-align: center;
    margin-bottom: 10px;
}
.obligacje-opis, .harmonogram-opis {
    font-size: 0.6em;
    color: #333333;
    text-align: center;
    max-width: 400px;
    margin: 10px auto 0;
    line-height: 1.4;
}
.data-container {
    text-align: right;
    margin-top: 5px;
}
.data-info {
    font-size: 0.8em;
    color: #C2B280;
}
.data-date {
    font-size: 0.8em;
}
.obligacje-opis ul, .harmonogram-opis ul {
    list-style: none;
    padding-left: 0;
}
.obligacje-opis li, .harmonogram-opis li {
    margin-bottom: 5px;
}
.result-section {
    display: none;
    padding: 10px;
    max-width: 1200px;
    margin: 0 auto;
    background: #FFFFFF;
}
.result-header {
    text-align: center;
    margin-bottom: 20px;
    position: relative;
}
.result-header h4 {
    font-size: 1.2em;
    color: #333333;
    font-weight: 700;
    display: inline-block;
}
.chart-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
    position: relative;
    overflow: visible;
}
.chart {
    flex: 0 0 auto;
    width: 120px;
    height: 120px;
    position: relative;
    z-index: 25;
}
.chart-legend {
    flex: 0 0 auto;
    max-width: 200px;
    margin: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.chart-legend .legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    font-size: 0.7em;
    color: #333333;
    cursor: pointer;
    transition: transform 0.3s ease;
    padding-left: 8px;
}
.chart-legend .color-box {
    width: 90px;
    height: 18px;
    border-radius: 5px;
    text-align: center;
    font-weight: 500;
    line-height: 18px;
    font-size: 0.8em;
    white-space: nowrap;
    overflow: hidden;
    position: relative;
    color: #fff;
    margin-right: 6px;
}
.chart-legend .color-box .value {
    display: block;
}
.chart-legend .color-box:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    color: #fff;
    font-size: 0.8em;
    line-height: 18px;
    text-align: center;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 30;
}
.chart-legend .color-box:hover .value {
    display: none;
}
.chart-legend .legend-text {
    opacity: 1;
    transition: opacity 0.3s ease;
    font-size: 0.7em;
}
.summary-footer {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 10px;
}
.summary-footer .highlight {
    font-size: 0.8em;
    padding: 4px 6px;
    border-radius: 5px;
    position: relative;
    cursor: pointer;
}
.highlight.yellow {
    background-color: #17a2b8;
    color: #ffffff;
}
.highlight.yellow:hover {
    color: transparent;
}
.highlight.yellow:hover::after {
    content: attr(data-hover);
    font-weight: bold;
    font-size: 1.1em;
    color: #ffffff;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
}
.highlight.green {
    background-color: #28a745;
    color: #ffffff;
}
.highlight.green:hover {
    color: transparent;
}
.highlight.green:hover::after {
    content: attr(data-hover);
    font-weight: bold;
    font-size: 1.1em;
    color: #ffffff;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
}
.harmonogram {
    margin-top: 20px;
    font-size: 0.8em;
    background-color: #f9f9f9;
    border-radius: 10px;
    padding: 10px;
}
.harmonogram table {
    margin: 0 auto;
    width: auto;
    max-width: 1000px;
    display: table;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    background: #f9f9f9;
}
.harmonogram th {
    background: linear-gradient(90deg, #C2B280, #b0a070);
    color: #000000;
    padding: 12px;
    text-align: center;
    vertical-align: middle;
    font-weight: 500;
    border-bottom: 2px solid #ddd;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.harmonogram td {
    padding: 10px;
    text-align: center;
    font-weight: 400;
    border-bottom: 1px solid #eee;
    background-color: #f9f9f9;
    color: #000000;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.btn-toggle {
    cursor: pointer;
    font-size: 0.8em;
    color: #007bff;
    text-decoration: underline;
    margin-bottom: 10px;
}
.btn-primary, .btn-secondary {
    background: linear-gradient(135deg, #C2B280, #b0a070);
    border: none;
    color: #000000;
    font-size: 0.9em;
    padding: 8px 20px;
    width: auto;
    margin: 25px auto 0;
    display: block;
    border-radius: 25px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.3s ease;
}
.btn-primary:hover, .btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    background: linear-gradient(135deg, #b0a070, #C2B280);
    color: #000000;
}
.btn-sm {
    font-size: 0.7em;
    padding: 3px 10px;
}
.btn-danger {
    background: #dc3545;
    border: none;
    color: #fff;
}
.btn-danger:hover {
    background: #c82333;
    color: #fff;
}
#generatePdfBtn {
    position: absolute;
    top: 0;
    right: 10px;
}
#harmonogramContent {
    display: block;
}
.form-container {
    display: flex;
    gap: 20px;
    justify-content: center;
    position: relative;
}
.form-wrapper {
    flex: 1;
    max-width: 400px;
}
.result-container {
    display: flex;
    gap: 20px;
    justify-content: center;
    flex-wrap: wrap;
    position: relative;
}
.harmonogram-container {
    display: flex;
    gap: 20px;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 20px;
    position: relative;
    background-color: #f9f9f9;
    border-radius: 10px;
    padding: 10px;
}
.result-wrapper {
    flex: 1;
    max-width: 1000px;
}
.result-wrapper h5 {
    font-size: 1em;
    text-align: center;
    margin-bottom: 10px;
    color: #333333;
}
.chart-container-line {
    margin-top: 20px;
    width: 100%;
    height: 400px;
}
.chart-line {
    width: 100%;
    height: 100%;
}
.checkbox-row {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 10px;
}
.variable-rate-container {
    margin-top: 15px;
    text-align: center;
}
.variable-inputs {
    margin-top: 10px;
}
.variable-inputs-wrapper {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 400px;
    margin: 0 auto;
}
.variable-input-group {
    display: flex;
    justify-content: center;
    gap: 10px;
    align-items: flex-start;
    position: relative;
}
.variable-input-group .form-group {
    max-width: 150px;
}
</style>
<script>
let chart;
let harmonogramData = [];
let isIkeIkzeMode = false;
let variableInflacjaChanges = [];
let variableStopaChanges = [];

const { jsPDF } = window.jspdf;

const obligacjeConfig = {
    "OTS": { okres: 3, oprocentowanie: 3.00, zmienne: false, kapitalizacja: false, oplataWykup: 0.00 },
    "ROR": { okres: 12, oprocentowanie: 5.75, zmienne: true, marza: 0.00, kapitalizacja: false, oplataWykup: 0.005 },
    "DOR": { okres: 24, oprocentowanie: 5.90, zmienne: true, marza: 0.15, kapitalizacja: false, oplataWykup: 0.007 },
    "TOS": { okres: 36, oprocentowanie: 5.95, zmienne: false, kapitalizacja: true, oplataWykup: 0.01 },
    "COI": { okres: 48, oprocentowanie: 6.30, zmienne: true, marza: 1.50, indeksowaneInflacja: true, kapitalizacja: false, oplataWykup: 0.02 },
    "EDO": { okres: 120, oprocentowanie: 6.55, zmienne: true, marza: 2.00, indeksowaneInflacja: true, kapitalizacja: true, oplataWykup: 0.03 },
    "ROS": { okres: 72, oprocentowanie: 6.50, zmienne: true, marza: 2.00, indeksowaneInflacja: true, kapitalizacja: true, oplataWykup: 0.02 },
    "ROD": { okres: 144, oprocentowanie: 6.80, zmienne: true, marza: 2.50, indeksowaneInflacja: true, kapitalizacja: true, oplataWykup: 0.03 }
};

document.getElementById("kwotaRange").addEventListener("input", function() {
    document.getElementById("kwota").value = this.value;
    updateIloscObligacji();
});

document.getElementById("kwota").addEventListener("input", function() {
    document.getElementById("kwotaRange").value = this.value;
    updateIloscObligacji();
});

document.getElementById("typObligacji").addEventListener("change", updateForm);
document.getElementById("ikeIkzeBtn").addEventListener("change", updateForm);

function updateForm() {
    isIkeIkzeMode = document.getElementById("ikeIkzeBtn").checked;
    const select = document.getElementById("typObligacji");
    const previousTyp = select.value;

    if (isIkeIkzeMode) {
        select.innerHTML = `
            <option value="ROR">12-miesięczne (ROR)</option>
            <option value="DOR">24-miesięczne (DOR)</option>
            <option value="TOS" selected>3-letnie (TOS)</option>
            <option value="COI">4-letnie (COI)</option>
            <option value="EDO">10-letnie (EDO)</option>
        `;
    } else {
        select.innerHTML = `
            <option value="OTS" selected>3-miesięczne (OTS)</option>
            <option value="ROR">12-miesięczne (ROR)</option>
            <option value="DOR">24-miesięczne (DOR)</option>
            <option value="TOS">3-letnie (TOS)</option>
            <option value="COI">4-letnie (COI)</option>
            <option value="EDO">10-letnie (EDO)</option>
            <option value="ROS">6-letnie (ROS)</option>
            <option value="ROD">12-letnie (ROD)</option>
        `;
    }

    const availableOptions = Array.from(select.options).map(opt => opt.value);
    if (!availableOptions.includes(previousTyp)) {
        select.value = isIkeIkzeMode ? "TOS" : "OTS";
    } else {
        select.value = previousTyp;
    }

    const typ = select.value;
    const config = obligacjeConfig[typ];

    document.getElementById("okres").value = config.okres;
    document.getElementById("oprocentowanie").value = config.oprocentowanie;
    updateIloscObligacji();

    const inflacjaZmiennaLabel = document.getElementById("inflacjaZmiennaLabel");
    const stopaZmiennaLabel = document.getElementById("stopaZmiennaLabel");
    inflacjaZmiennaLabel.style.display = ["COI", "EDO", "ROS", "ROD"].includes(typ) ? "flex" : "none";
    stopaZmiennaLabel.style.display = ["ROR", "DOR"].includes(typ) ? "flex" : "none";

    document.getElementById("inflacjaZmiennaBtn").checked = false;
    document.getElementById("stopaZmiennaBtn").checked = false;
    variableInflacjaChanges = [];
    variableStopaChanges = [];
    updateVariableInputs();
}

function updateIloscObligacji() {
    const kwota = parseFloat(document.getElementById("kwota").value) || 0;
    const ilosc = Math.floor(kwota / 100);
    document.getElementById("iloscObligacji").textContent = `Ilość obligacji: ${ilosc}`;
}

function updateVariableInputs() {
    const typ = document.getElementById("typObligacji").value;
    const isInflacjaZmienna = document.getElementById("inflacjaZmiennaBtn").checked && ["COI", "EDO", "ROS", "ROD"].includes(typ);
    const isStopaZmienna = document.getElementById("stopaZmiennaBtn").checked && ["ROR", "DOR"].includes(typ);
    const variableInputs = document.getElementById("variableInputs");
    const addVariableBtn = document.getElementById("addVariableBtn");
    const wrapper = document.getElementById("variableInputsWrapper");
    const config = obligacjeConfig[typ];
    const maxCykl = ["ROR", "DOR"].includes(typ) ? config.okres : config.okres / 12;

    if (isInflacjaZmienna || isStopaZmienna) {
        variableInputs.style.display = "block";
        addVariableBtn.style.display = "block";

        if ((isInflacjaZmienna && variableInflacjaChanges.length === 0) || (isStopaZmienna && variableStopaChanges.length === 0)) {
            addVariableChange();
        }

        wrapper.innerHTML = "";
        const changes = isInflacjaZmienna ? variableInflacjaChanges : variableStopaChanges;

        changes.forEach((change, index) => {
            const inputGroup = document.createElement("div");
            inputGroup.className = "variable-input-group";

            const cyklGroup = document.createElement("div");
            cyklGroup.className = "form-group";
            cyklGroup.innerHTML = `
                <label class="form-label">Od ${["ROR", "DOR"].includes(typ) ? "miesiąca" : "roku"}</label>
                <div class="input-group">
                    <input type="number" class="form-control variable-cykl" min="1" max="${maxCykl}" step="1" value="${change.cykl}">
                    <span class="input-group-text">${["ROR", "DOR"].includes(typ) ? "mc" : "rok"}</span>
                </div>
                <input type="range" class="form-range variable-cykl-range" min="1" max="${maxCykl}" step="1" value="${change.cykl}">
            `;

            const rateGroup = document.createElement("div");
            rateGroup.className = "form-group";
            rateGroup.innerHTML = `
                <label class="form-label">${isInflacjaZmienna ? "Inflacja" : "Stopa NBP"}</label>
                <div class="input-group">
                    <input type="number" class="form-control variable-rate" min="0" max="${isInflacjaZmienna ? 50 : 20}" step="${isInflacjaZmienna ? 0.1 : 0.05}" value="${change.wartosc}">
                    <span class="input-group-text">%</span>
                </div>
                <input type="range" class="form-range variable-rate-range" min="0" max="${isInflacjaZmienna ? 50 : 20}" step="${isInflacjaZmienna ? 0.1 : 0.05}" value="${change.wartosc}">
            `;

            if (index > 0) {
                const removeBtn = document.createElement("button");
                removeBtn.className = "btn btn-danger btn-sm";
                removeBtn.textContent = "Usuń";
                removeBtn.onclick = () => removeVariableChange(index);
                inputGroup.appendChild(removeBtn);
            }

            inputGroup.appendChild(cyklGroup);
            inputGroup.appendChild(rateGroup);
            wrapper.appendChild(inputGroup);

            const cyklInput = inputGroup.querySelector(".variable-cykl");
            const cyklRange = inputGroup.querySelector(".variable-cykl-range");
            const rateInput = inputGroup.querySelector(".variable-rate");
            const rateRange = inputGroup.querySelector(".variable-rate-range");

            cyklInput.addEventListener("input", () => {
                cyklRange.value = cyklInput.value;
                changes[index].cykl = parseInt(cyklInput.value);
            });
            cyklRange.addEventListener("input", () => {
                cyklInput.value = cyklRange.value;
                changes[index].cykl = parseInt(cyklRange.value);
            });
            rateInput.addEventListener("input", () => {
                rateRange.value = rateInput.value;
                changes[index].wartosc = parseFloat(rateInput.value);
            });
            rateRange.addEventListener("input", () => {
                rateInput.value = rateRange.value;
                changes[index].wartosc = parseFloat(rateInput.value);
            });
        });
    } else {
        variableInputs.style.display = "none";
        addVariableBtn.style.display = "none";
        wrapper.innerHTML = "";
    }
}

function addVariableChange() {
    const typ = document.getElementById("typObligacji").value;
    const isInflacjaZmienna = document.getElementById("inflacjaZmiennaBtn").checked && ["COI", "EDO", "ROS", "ROD"].includes(typ);
    const changes = isInflacjaZmienna ? variableInflacjaChanges : variableStopaChanges;
    const maxCykl = ["ROR", "DOR"].includes(typ) ? obligacjeConfig[typ].okres : obligacjeConfig[typ].okres / 12;
    const lastCykl = changes.length > 0 ? changes[changes.length - 1].cykl : 1;
    const newCykl = Math.min(lastCykl + 1, maxCykl);
    changes.push({ cykl: newCykl, wartosc: isInflacjaZmienna ? 4.9 : 5.75 });
    updateVariableInputs();
}

function removeVariableChange(index) {
    const typ = document.getElementById("typObligacji").value;
    const isInflacjaZmienna = document.getElementById("inflacjaZmiennaBtn").checked && ["COI", "EDO", "ROS", "ROD"].includes(typ);
    const changes = isInflacjaZmienna ? variableInflacjaChanges : variableStopaChanges;
    if (changes.length > 1) {
        changes.splice(index, 1);
        updateVariableInputs();
    }
}

function toggleHarmonogram(sectionId) {
    const content = document.getElementById(sectionId);
    const toggleBtn = content.previousElementSibling;
    content.style.display = content.style.display === "none" ? "block" : "none";
    toggleBtn.textContent = content.style.display === "none" ? "Harmonogram odsetek ►" : "Harmonogram odsetek ▼";
}

function showForm() {
    document.getElementById("formSection").style.display = "block";
    document.getElementById("resultSection").style.display = "none";
}

function obliczObligacje() {
    const kwota = parseFloat(document.getElementById("kwota").value) || 0;
    const typ = document.getElementById("typObligacji").value;
    const config = obligacjeConfig[typ];
    const miesiace = config.okres;
    const podatekBelki = isIkeIkzeMode ? 0 : 0.19;
    const inflacjaZmienna = document.getElementById("inflacjaZmiennaBtn").checked && ["COI", "EDO", "ROS", "ROD"].includes(typ);
    const stopaZmienna = document.getElementById("stopaZmiennaBtn").checked && ["ROR", "DOR"].includes(typ);

    if (kwota < 100) {
        alert("Kwota musi być co najmniej 100 zł.");
        return;
    }

    let kapital = kwota;
    let odsetkiCalkowite = 0;
    let zyskNettoCalkowity = 0;
    let harmonogram = [];
    let liczbaCykli = ["OTS", "ROR", "DOR"].includes(typ) ? miesiace : miesiace / 12;
    let changes = inflacjaZmienna ? variableInflacjaChanges : (stopaZmienna ? variableStopaChanges : []);
    changes.sort((a, b) => a.cykl - b.cykl);

    for (let i = 1; i <= liczbaCykli; i++) {
        let oprocentowanieRoczne;
        let changeApplied = false;

        if (inflacjaZmienna || stopaZmienna) {
            let dynamicValue = (inflacjaZmienna ? 4.9 : 5.75) / 100;
            for (const change of changes) {
                if (i >= change.cykl) {
                    dynamicValue = change.wartosc / 100;
                    changeApplied = change.cykl === i;
                }
            }
            oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (dynamicValue + config.marza / 100);
        } else {
            oprocentowanieRoczne = config.oprocentowanie / 100;
        }

        let oprocentowanieMiesieczne = oprocentowanieRoczne / 12;
        let miesiecyWCyklu = ["OTS", "ROR", "DOR"].includes(typ) ? 1 : 12;
        let odsetkiCykl = kapital * oprocentowanieMiesieczne * miesiecyWCyklu;

        let podatekCykl = odsetkiCykl * podatekBelki;
        let odsetkiNettoCykl = odsetkiCykl - podatekCykl;

        odsetkiCalkowite += odsetkiCykl;
        zyskNettoCalkowity += odsetkiNettoCykl;

        if (config.kapitalizacja) kapital += odsetkiCykl;

        harmonogram.push({
            okres: i,
            wartoscInwestycji: kapital.toFixed(2),
            oprocentowanie: (oprocentowanieRoczne * 100).toFixed(2) + "%",
            odsetki: odsetkiCykl.toFixed(2),
            sumaOdsetek: odsetkiCalkowite.toFixed(2),
            podatek: podatekCykl.toFixed(2),
            zyskNetto: odsetkiNettoCykl.toFixed(2),
            oplataZaWykup: (i < liczbaCykli ? kwota * config.oplataWykup : 0).toFixed(2),
            stopaRefLubInflacja: (inflacjaZmienna || stopaZmienna) ? (changes.find(c => c.cykl <= i)?.wartosc || (inflacjaZmienna ? 4.9 : 5.75)) + "%" : "-",
            changeApplied: changeApplied
        });
    }

    harmonogramData = harmonogram;

    if (chart) chart.destroy();
    const ctx = document.getElementById("obligacjeChart").getContext("2d");
    chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Kapitał', 'Odsetki', 'Podatek'],
            datasets: [{
                data: [kwota, odsetkiCalkowite, odsetkiCalkowite * podatekBelki],
                backgroundColor: ['#28a745', '#007bff', '#dc3545'],
                borderWidth: 1
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    let tabela = document.getElementById("harmonogramTabela");
    tabela.innerHTML = "";
    harmonogram.forEach(wiersz => {
        tabela.innerHTML += `
            <tr>
                <td>${wiersz.okres}${wiersz.changeApplied ? ' ★' : ''}</td>
                <td>${wiersz.wartoscInwestycji} zł</td>
                <td>${wiersz.oprocentowanie}</td>
                <td>${wiersz.odsetki} zł</td>
                <td>${wiersz.sumaOdsetek} zł</td>
                <td>${wiersz.podatek} zł</td>
                <td>${wiersz.zyskNetto} zł</td>
                <td>${wiersz.oplataZaWykup} zł</td>
                <td>${wiersz.stopaRefLubInflacja}</td>
                <td>${(parseFloat(wiersz.wartoscInwestycji) + parseFloat(wiersz.zyskNetto)).toFixed(2)} zł</td>
            </tr>
        `;
    });

    document.getElementById("formSection").style.display = "none";
    document.getElementById("resultSection").style.display = "block";
}

function generatePDF() {
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text("Kalkulator Obligacji - Podsumowanie", 10, 10);
    doc.setFontSize(12);
    doc.text(`Kwota: ${document.getElementById("kwota").value} zł`, 10, 20);
    doc.text(`Typ: ${document.getElementById("typObligacji").value}`, 10, 30);

    const headers = ["Okres", "Wartość", "Oproc.", "Odsetki", "Suma", "Podatek", "Zysk", "Opłata", "Stopa/Inflacja", "Kwota"];
    const data = harmonogramData.map(w => [
        w.okres + (w.changeApplied ? ' *' : ''),
        w.wartoscInwestycji + " zł",
        w.oprocentowanie,
        w.odsetki + " zł",
        w.sumaOdsetek + " zł",
        w.podatek + " zł",
        w.zyskNetto + " zł",
        w.oplataZaWykup + " zł",
        w.stopaRefLubInflacja,
        (parseFloat(w.wartoscInwestycji) + parseFloat(w.zyskNetto)).toFixed(2) + " zł"
    ]);

    doc.autoTable({ startY: 40, head: [headers], body: data });
    doc.save("obligacje.pdf");
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById("obliczBtn").addEventListener("click", obliczObligacje);
    document.getElementById("generatePdfBtn").addEventListener("click", generatePDF);
    document.getElementById("inflacjaZmiennaBtn").addEventListener("change", updateVariableInputs);
    document.getElementById("stopaZmiennaBtn").addEventListener("change", updateVariableInputs);
    document.getElementById("addVariableBtn").addEventListener("click", addVariableChange);
    updateForm();
});
</script>
